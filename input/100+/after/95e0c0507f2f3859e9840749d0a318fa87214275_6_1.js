function aStar(a,b,c,d){function m(){switch(d){case"Diagonal":case"Euclidean":d=r;break;case"DiagonalFree":case"EuclideanFree":d=s;break;default:d=function(){}}}function n(b,c){return a[c][b].isTraversable()}function o(a,b){return{Parent:a,value:b.x+b.y*i,x:b.x,y:b.y,f:0,g:0}}function p(){var a=o(null,{x:b[0],y:b[1]}),d=o(null,{x:c[0],y:c[1]}),e=new Array(k),f=[a],g=[],h=[],i,j,m,n,p,r,s,t;while(n=f.length){p=k,r=-1;for(s=0;s<n;s++)f[s].f<p&&(p=f[s].f,r=s);j=f.splice(r,1)[0];if(j.value===d.value){m=g[g.push(j)-1];do h.push([m.x,m.y]);while(m=m.Parent);e=g=f=[],h.reverse()}else{i=q(j.x,j.y);for(s=0,t=i.length;s<t;s++)m=o(j,i[s]),e[m.value]||(m.g=j.g+l(i[s],j),m.f=m.g+l(i[s],d),f.push(m),e[m.value]=!0);g.push(j)}}return h}function q(a,b){var c=b-1,e=b+1,f=a+1,g=a-1,h=c>-1&&n(a,c),k=e<j&&n(a,e),l=f<i&&n(f,b),m=g>-1&&n(g,b),o=[];return h&&o.push({x:a,y:c}),l&&o.push({x:f,y:b}),k&&o.push({x:a,y:e}),m&&o.push({x:g,y:b}),d(h,k,l,m,c,e,f,g,o),o}function r(a,b,c,d,e,f,g,h,i){a&&(c&&n(g,e)&&i.push({x:g,y:e}),d&&n(h,e)&&i.push({x:h,y:e})),b&&(c&&n(g,f)&&i.push({x:g,y:f}),d&&n(h,f)&&i.push({x:h,y:f}))}function s(a,b,c,d,e,f,g,h,k){a=e>-1,b=f<j,c=g<i,d=h>-1,c&&(a&&n(g,e)&&k.push({x:g,y:e}),b&&n(g,f)&&k.push({x:g,y:f})),d&&(a&&n(h,e)&&k.push({x:h,y:e}),b&&n(h,f)&&k.push({x:h,y:f}))}function t(a,b){return f(e(a.x-b.x),e(a.y-b.y))}function u(a,b){return h(g(a.x-b.x,2)+g(a.y-b.y,2))}function v(a,b){return e(a.x-b.x)+e(a.y-b.y)}var e=Math.abs,f=Math.max,g=Math.pow,h=Math.sqrt,i=a[0].length,j=a.length,k=i*j,l={Diagonal:t,DiagonalFree:t,Euclidean:u,EuclideanFree:u,Manhattan:v}[d]||v;return p(m())}!function(a,b){function e(){this._events=new Object}function f(a){a&&(a.delimiter&&(this.delimiter=a.delimiter),a.wildcard&&(this.wildcard=a.wildcard),this.wildcard&&(this.listenerTree=new Object))}function g(a){this._events=new Object,f.call(this,a)}function h(a,b,c,d){if(!c)return[];var e=[],f,g,i,j,k,l,m,n=b.length,o=b[d],p=b[d+1];if(d===n&&c._listeners){if(typeof c._listeners=="function")return a&&a.push(c._listeners),[c];for(f=0,g=c._listeners.length;f<g;f++)a&&a.push(c._listeners[f]);return[c]}if(o==="*"||o==="**"||c[o]){if(o==="*"){for(i in c)i!=="_listeners"&&c.hasOwnProperty(i)&&(e=e.concat(h(a,b,c[i],d+1)));return e}if(o==="**"){m=d+1===n||d+2===n&&p==="*",m&&c._listeners&&(e=e.concat(h(a,b,c,n)));for(i in c)i!=="_listeners"&&c.hasOwnProperty(i)&&(i==="*"||i==="**"?(c[i]._listeners&&!m&&(e=e.concat(h(a,b,c[i],n))),e=e.concat(h(a,b,c[i],d))):i===p?e=e.concat(h(a,b,c[i],d+2)):e=e.concat(h(a,b,c[i],d)));return e}e=e.concat(h(a,b,c[o],d+1))}j=c["*"],j&&h(a,b,j,d+1),k=c["**"];if(k)if(d<n){k._listeners&&h(a,b,k,n);for(i in k)i!=="_listeners"&&k.hasOwnProperty(i)&&(i===p?h(a,b,k[i],d+2):i===o?h(a,b,k[i],d+1):(l={},l[i]=k[i],h(a,b,{"**":l},d+1)))}else k._listeners?h(a,b,k,n):k["*"]&&k["*"]._listeners&&h(a,b,k["*"],n);return e}function i(a,b){a=typeof a=="string"?a.split(this.delimiter):a.slice();for(var e=0,f=a.length;e+1<f;e++)if(a[e]==="**"&&a[e+1]==="**")return;var g=this.listenerTree,h=a.shift();while(h){g[h]||(g[h]=new Object),g=g[h];if(a.length===0){if(!g._listeners)g._listeners=b;else if(typeof g._listeners=="function")g._listeners=[g._listeners,b];else if(c(g._listeners)){g._listeners.push(b);if(!g._listeners.warned){var i=d;typeof this._events.maxListeners!="undefined"&&(i=this._events.maxListeners),i>0&&g._listeners.length>i&&(g._listeners.warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",g._listeners.length),console.trace())}}return!0}h=a.shift()}return!0}var c=Array.isArray?Array.isArray:function(a){return Object.prototype.toString.call(a)==="[object Array]"},d=10;g.prototype.delimiter=".",g.prototype.setMaxListeners=function(a){this._events||e.call(this),this._events.maxListeners=a},g.prototype.event="",g.prototype.once=function(a,b){return this.many(a,1,b),this},g.prototype.many=function(a,b,c){function e(){--b===0&&d.off(a,e),c.apply(this,arguments)}var d=this;if(typeof c!="function")throw new Error("many only accepts instances of Function");return e._origin=c,this.on(a,e),d},g.prototype.emit=function(){this._events||e.call(this);var a=arguments[0];if(a==="newListener"&&!this._events.newListener)return!1;if(this._all){var b=arguments.length,c=new Array(b-1);for(var d=1;d<b;d++)c[d-1]=arguments[d];for(d=0,b=this._all.length;d<b;d++)this.event=a,this._all[d].apply(this,c)}if(a==="error"&&!this._all&&!this._events.error&&(!this.wildcard||!this.listenerTree.error))throw arguments[1]instanceof Error?arguments[1]:new Error("Uncaught, unspecified 'error' event.");var f;if(this.wildcard){f=[];var g=typeof a=="string"?a.split(this.delimiter):a.slice();h.call(this,f,g,this.listenerTree,0)}else f=this._events[a];if(typeof f=="function"){this.event=a;if(arguments.length===1)f.call(this);else if(arguments.length>1)switch(arguments.length){case 2:f.call(this,arguments[1]);break;case 3:f.call(this,arguments[1],arguments[2]);break;default:var b=arguments.length,c=new Array(b-1);for(var d=1;d<b;d++)c[d-1]=arguments[d];f.apply(this,c)}return!0}if(f){var b=arguments.length,c=new Array(b-1);for(var d=1;d<b;d++)c[d-1]=arguments[d];var i=f.slice();for(var d=0,b=i.length;d<b;d++)this.event=a,i[d].apply(this,c);return i.length>0||this._all}return this._all},g.prototype.on=function(a,b){if(typeof a=="function")return this.onAny(a),this;if(typeof b!="function")throw new Error("on only accepts instances of Function");this._events||e.call(this),this.emit("newListener",a,b);if(this.wildcard)return i.call(this,a,b),this;if(!this._events[a])this._events[a]=b;else if(typeof this._events[a]=="function")this._events[a]=[this._events[a],b];else if(c(this._events[a])){this._events[a].push(b);if(!this._events[a].warned){var f=d;typeof this._events.maxListeners!="undefined"&&(f=this._events.maxListeners),f>0&&this._events[a].length>f&&(this._events[a].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[a].length),console.trace())}}return this},g.prototype.onAny=function(a){this._all||(this._all=[]);if(typeof a!="function")throw new Error("onAny only accepts instances of Function");return this._all.push(a),this},g.prototype.addListener=g.prototype.on,g.prototype.off=function(a,b){if(typeof b!="function")throw new Error("removeListener only takes instances of Function");var d,e=[];if(this.wildcard){var f=typeof a=="string"?a.split(this.delimiter):a.slice();e=h.call(this,null,f,this.listenerTree,0)}else{if(!this._events[a])return this;d=this._events[a],e.push({_listeners:d})}for(var g=0;g<e.length;g++){var i=e[g];d=i._listeners;if(c(d)){var j=-1;for(var k=0,l=d.length;k<l;k++)if(d[k]===b||d[k].listener&&d[k].listener===b||d[k]._origin&&d[k]._origin===b){j=k;break}if(j<0)return this;this.wildcard?i._listeners.splice(j,1):this._events[a].splice(j,1),d.length===0&&(this.wildcard?delete i._listeners:delete this._events[a])}else if(d===b||d.listener&&d.listener===b||d._origin&&d._origin===b)this.wildcard?delete i._listeners:delete this._events[a]}return this},g.prototype.offAny=function(a){var b=0,c=0,d;if(a&&this._all&&this._all.length>0){d=this._all;for(b=0,c=d.length;b<c;b++)if(a===d[b])return d.splice(b,1),this}else this._all=[];return this},g.prototype.removeListener=g.prototype.off,g.prototype.removeAllListeners=function(a){if(arguments.length===0)return!this._events||e.call(this),this;if(this.wildcard){var b=typeof a=="string"?a.split(this.delimiter):a.slice(),c=h.call(this,null,b,this.listenerTree,0);for(var d=0;d<c.length;d++){var f=c[d];f._listeners=null}}else{if(!this._events[a])return this;this._events[a]=null}return this},g.prototype.listeners=function(a){if(this.wildcard){var b=[],d=typeof a=="string"?a.split(this.delimiter):a.slice();return h.call(this,b,d,this.listenerTree,0),b}return this._events||e.call(this),this._events[a]||(this._events[a]=[]),c(this._events[a])||(this._events[a]=[this._events[a]]),this._events[a]},g.prototype.listenersAny=function(){return this._all?this._all:[]},typeof define=="function"&&define.amd?define(function(){return g}):a.EventEmitter2=g}(typeof process!="undefined"&&typeof process.title!="undefined"&&typeof exports!="undefined"?exports:window),!function(a,b){typeof define=="function"?define(b):typeof module!="undefined"?module.exports=b():this[a]=b()}("klass",function(){function a(a){return e.call(b(a)?a:function(){},a,1)}function b(a){return typeof a===h}function c(a,b,c){return function(){var d=this.supr;this.supr=c[j][a];var e=b.apply(this,arguments);return this.supr=d,e}}function d(a,d,e){for(var f in d)d.hasOwnProperty(f)&&(a[f]=b(d[f])&&b(e[j][f])&&i.test(d[f])?c(f,d[f],e):d[f])}function e(a,c){function e(){}function f(){this.initialize?this.initialize.apply(this,arguments):(c||i&&g.apply(this,arguments),k.apply(this,arguments))}e[j]=this[j];var g=this,h=new e,i=b(a),k=i?a:this,l=i?{}:a;return f.methods=function(a){return d(h,a,g),f[j]=h,this},f.methods.call(f,l).prototype.constructor=f,f.extend=arguments.callee,f[j].implement=f.statics=function(a,b){return a=typeof a=="string"?function(){var c={};return c[a]=b,c}():a,d(this,a,g),this},f}var f=this,g=f.klass,h="function",i=/xyz/.test(function(){xyz})?/\bsupr\b/:/.*/,j="prototype";return a.noConflict=function(){return f.klass=g,this},f.klass=a,a}),function(){var a={},b=Array.prototype.slice,c=Array.prototype.forEach,d={debug:!1,defaults:{font:"bold 18pt Helvetica",character_sprite:"character.png",emote_sprite:"emote.png",explosion_sprite:"explosion.png"},each:function(b,d,e){if(b==null)return;if(c&&b.forEach===c)b.forEach(d,e);else if(b.length===+b.length){for(var f=0,g=b.length;f<g;f++)if(f in b&&d.call(e,b[f],f,b)===a)return}else for(var h in b)if(b.hasOwnProperty(h)&&d.call(e,b[h],h,b)===a)return},extend:function(a){return d.each(b.call(arguments,1),function(b){for(var c in b)a[c]=b[c]}),a},generateGUID:function(){var a=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}};d.extend(d,new window.EventEmitter2),window.TK=window.Tilekit=d}(),Array.prototype.isArray=!0,typeof window!="undefined"&&(window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}()),Math.roundTo=function a(a,b){if(a<b/2)return 0;var c=b*Math.round(a/b);return c===0&&(c=b),c},Math.floorTo=function(a,b){if(a<b)return 0;var c=b*Math.floor(a/b);return c===0&&(c=b),c},Math.ceilTo=function b(a,b){if(a<b)return b;var c=b*Math.ceil(a/b);return c===0&&(c=b),c};var Format=window.Format={};Format.align=function(a,b,c,d){return/bottom|right/ig.test(a)?c-d-b:d},function(){var a={};a.toRadians=function(a){return a*(Math.PI/180)},a.findAngle=function(a,b){a.isArray&&(a={x:a[0],y:a[1]}),b.isArray&&(b={x:b[0],y:b[1]});var c=Math.atan2(b.y-a.y,b.x-a.x)*(180/Math.PI);return c<0?c+360:c},a.findPoint=function(b,c,d,e){e=e||100;var f=a.toRadians(d);return{x:b.x+c*~~(Math.cos(f)*e)/e,y:b.y+c*~~(Math.sin(f)*e)/e}},a.findDistance=function(a,b){var c=Math.pow(b.x-a.x,2),d=Math.pow(b.y-a.y,2),e=Math.sqrt(c+d);return e},a.isWithinCone=function(b,c,d,e,f){var g=a.findAngle(c,b),h=a.findDistance(b,c);return h>=d?!1:e-f>=g||g>=e+f?!1:!0},window.Geo=a}();var TextBox=function(a){a=a||{},this.header=a.header||"???",this.subheader=a.subheader||!1,this.body=a.body||"",this.context=a.context,this.lineheight=a.lineheight||25};TextBox.prototype.setFont=function(a,b){var c=this.context;c.textBaseline="top",c.fillStyle=a,c.font=b},TextBox.prototype.drawWindow=function(){var a=this.context;a.fillStyle="#f0f0f0",a.fillRect(0,document.height-document.height*.2,document.width,document.height*.2),a.fillStyle="#333",a.fillRect(0,document.height-document.height*.2-2,document.width,2),a.fillStyle="#fff",a.fillRect(0,document.height-document.height*.2+1,document.width,1)},TextBox.prototype.drawText=function(a,b,c){this.context.fillText(a,document.width*.1+(b||0),document.height-document.height*.2+(c||0))},TextBox.prototype.drawEllipsis=function(){var a=this.context,b=document.width*.93,c=document.height-document.height*.05;a.fillStyle="#333",a.fillRect(b,c,5,5),a.fillRect(b+10,c,5,5),a.fillRect(b+20,c,5,5)},TextBox.prototype.draw=function(){var a=this.context,b=this;this.drawWindow(),this.setFont("black","bold 14pt monospace"),this.drawText(this.header,0,15),this.subheader&&(this.setFont("#666","normal 10pt monospace"),this.drawText(this.subheader,0,40)),this.setFont("#333","normal 14pt monospace");var c=0,d=this.body.split(" "),e=70,f=0,g="",h=0;while(d[f]){g=d[f],h=a.measureText(g+" ").width,c+h>document.width*.85&&(c=0,e+=this.lineheight);if(e>document.height*.2-document.height*.05)return;b.drawText(g,c,e),c+=a.measureText(g+" ").width,f++}this.drawEllipsis();return},function(a){a.Text=function(b,c,d,e,f){b.globalAlpha=f.alpha||1,b.globalCompositeOperation=f.composite,b.font=f.font||a.defaults.font,b.fillStyle=f.color||"#fff",f&&f.align==="center"&&(d-=b.measureText(c).width/2),b.fillText(c,d,e),b.globalAlpha=1,b.globalCompositeOperation="source-over"},a.Rectangle=function(a,b,c,d,e,f){a.globalAlpha=f.alpha||1,a.globalCompositeOperation=f.composite,f.fill&&(a.fillStyle=f.fill,a.fillRect(b,c,d,e)),f.stroke&&(a.lineWidth=f.lineWidth||1,a.strokestyle=f.stroke,a.strokeRect(b+1,c+1,d-1,e-1)),a.globalAlpha=1,a.globalCompositeOperation="source-over"},a.Icon=function(a,b,c,d,e){a.globalAlpha=e.alpha||1,a.globalCompositeOperation=e.composite,a.drawImage(b,c,d),a.globalAlpha=1,a.globalCompositeOperation="source-over"}}(window.Tilekit),function(a){var b=a.Timer=function(){this.date=new Date};b.prototype.update=function(){var a=new Date;this.date=a},b.prototype.getMilliseconds=function(){return this.date.getTime()},b.prototype.getSeconds=function(){return Math.round(this.date.getTime()/1e3)}}(window.Tilekit),function(a){"use strict",a.Entity=window.klass({attributes:{},layers:{},initialize:function(b,c){this.attributes=a.extend({},this.attributes,b),this.layers=a.extend({},this.layers,c),this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d")},get:function(a){return this.attributes[a]},set:function(a,b){if(typeof a=="object")for(var c in a)a.hasOwnProperty(c)&&this.set(c,a[c]);var d=this.attributes[a];return this.attributes[a]=b,this.emit("change",b,d),this.emit("change:"+a,b,d),this.attributes[a]},is:function(a,b){return this.get(a)===(b||!0)},addLayer:function(b,c,d,e){var f=this;typeof b=="function"&&(c=b,d=c,e=d,b=a.generateGUID());if(!b)throw new Error("Entity#addLayer - Layer requires a namespace");if(typeof b=="object"){for(var g in b)b.hasOwnProperty(g)&&this.addLayer(g,b[g],d);return this}var h=c.bind(d||this);return h.created_at=Date.now(),h.expires_at=e||!1,h.callback=function(){},this.layers[b]=h,{then:function(a){h.callback=a}}},removeLayer:function(a){this.layers[a]&&delete this.layers[a]},renderLayers:function(a){var b=this.layers,c,d=new Date;for(var e in b)b.hasOwnProperty(e)&&typeof b[e]=="function"&&(c=b[e],c(a||this.ctx,d,c.created_at),c.expires_at!==!1&&d.getTime()-c.created_at>c.expires_at&&(this.layers[e].callback.apply(this,d),delete this.layers[e]))}}),a.extend(a.Entity.prototype,window.EventEmitter2.prototype)}(window.Tilekit),function(a){var b=a.Entity.extend({initialize:function(b,c){a.extend(this,{width:0,height:0,offset:{x:0,y:0},base_offset:{x:0,y:0},padding:0,position:{x:0,y:0},base_position:{x:0,y:0},frames:1,currentFrame:0,iterations:0,keyframe:1,duration:1,spritesheet:null,shadow:null,shown:!0,zoomLevel:1,target:null,timer:new a.Timer},c),this.setSpritesheet(b),this.created_at=this.timer.getMilliseconds();var d=new Date;this.duration>0&&this.frames>0?this.ftime=d.getTime()+this.duration/this.frames:this.ftime=0}});b.prototype.setSpritesheet=function(a){var b=this;return this.spritesheet instanceof Image&&this.spritesheet.src===a?(b.emit("ready"),this):(this.ready=!1,a instanceof Image?this.spritesheet=a:(this.spritesheet=new Image,this.spritesheet.src=a),this.spritesheet.onload=function(){b.emit("ready")},this)},b.prototype.setPosition=function(a,b){return this.position.x=a,this.position.y=b,this},b.prototype.setOffset=function(a,b){return typeof a!="undefined"&&(this.offset.x=a),typeof b!="undefined"&&(this.offset.y=b),this},b.prototype.setFrames=function(a){return this.currentFrame=0,this.frames=a,this},b.prototype.setDuration=function(a){return this.duration=a,this},b.prototype.nextFrame=function(){if(this.duration>0){var a=new Date;this.duration>0&&this.frames>0?this.ftime=a.getTime()+this.duration/this.frames:this.ftime=0,this.offset.x=this.width*this.currentFrame,this.currentFrame===this.frames-1?(this.currentFrame=0,this.iterations++,this.emit("iteration")):this.currentFrame++,this.currentFrame===this.keyframe&&this.emit("keyframe")}return this},b.prototype.animate=function(a){return a=a||this.timer,a.update(),a.getMilliseconds()>this.ftime&&this.nextFrame(),this},b.prototype.draw=function(a){return a=a||this.target,this.shown?(a.drawImage(this.spritesheet,this.offset.x+this.base_offset.x,this.offset.y+this.base_offset.y,this.width,this.height,this.position.x-this.padding,this.position.y-this.padding,this.width*this.zoomLevel,this.height*this.zoomLevel),this):!1},a.Sprite=b}(window.Tilekit),function(a){var b=Math.round,c=a.Entity.extend({defaults:{x:0,y:0,width:32,height:32},layers:[],initialize:function(b){a.extend(this,this.defaults,b)},isTraversable:function(){return this.layers[1]===undefined||this.layers[1]===0},isBlocking:function(){return this.layers[1]>0},roundedTile:function(){return{x:b(this.x),y:b(this.y)}},draw:function(b){var c=this.grid,d=this.sprite,e=this.layers,f=this.sprite.position;for(var g=0,h=e.length;g<h;g++){var i=e[g],j=c.calculateTileOffset(i);d.setOffset(j.x,j.y),d.draw(b),g>1&&i>0?d.draw(c.overlayCtx):d.draw()}a.debug&&this.debug()}});a.Tile=c}(window.Tilekit),function(a,b){"use strict";var c=b.Sprite,d=b.Tile,e=b.Entity,f=a.Geo,g=a.aStar,h=Math.floor,i=Math.floorTo,j=Math.ceil,k=Math.round,l=Math.roundTo,m=Math.min,n=Math.max,o=b.Grid=e.extend({attributes:{encoding:24,resize:!0,paused:!1,scroll:{x:0,y:0},size:32,tileset:[]},scale:1,initialize:function(c,d,e){function h(a){var b=f.get("size"),c=f.findCenter();a.position={x:a.clientX/f.scale-c.x-b/2,y:a.clientY/f.scale-c.y-b/2},a.tile={x:l(a.position.x/b,1),y:l(a.position.y/b,1)},f.set("mouse",a),f.emit(a.type,a)}var f=this;e=e||{},this.attributes=b.extend({},this.attributes,{tileset:d&&d.tileset||[]},e,{created_at:Date.now()});if(typeof c=="string"){var g=document.querySelector(c);if(!g)throw new Error("Please provide either a canvas or query selector for this Grid to target");g instanceof a.HTMLCanvasElement?this.canvas=g:(this.canvas=document.createElement("canvas"),g.appendChild(this.canvas))}else c instanceof a.HTMLCanvasElement?this.canvas=c:this.canvas=document.createElement("canvas");this.ctx=this.canvas.getContext("2d"),this.on("ready",function(){var b=this.get("resize"),c=this.get("start_location"),d=this;a.addEventListener("resize",function(){d.fillspace()}),d.fillspace(),c&&d.panTo(e.start_location),a.onblur=function(){d.pause()},d.begin()}),this.canvas.parentNode&&(this.canvas.parentNode.oncontextmenu=function(){return!1}),this.canvas.addEventListener("click",h),this.canvas.addEventListener("mousemove",h),this.canvas.addEventListener("mousedown",h),this.canvas.addEventListener("mouseup",h),this.canvas.addEventListener("mousewheel",h),this.start_location=e.start_location,this.portals=e.portals||[];var i=function(){f.emit("portal",m)};for(var j=0,k=this.portals.length;j<k;j++){var m=this.portals[j];this.on("tile:"+[m.x,m.y].join(","),i)}var n=this.base=document.createElement("canvas");this.baseCtx=n.getContext("2d");var o=this.staging=document.createElement("canvas");this.stagingCtx=o.getContext("2d");var p=this.debug=document.createElement("canvas");this.debugCtx=p.getContext("2d");var q=this.overlay=document.createElement("canvas");this.overlayCtx=q.getContext("2d"),n.height=p.height=o.height=q.height=e.canvasHeight||2e3,n.width=p.width=o.width=q.width=e.canvasWidth||2e3,d&&this.generateTilemap(d.data)}});o.prototype.zoom=function(a){this.scale=n(.5,m(4,this.scale*a))},o.methods({toJSON:function(){return b.extend(this.attributes,{name:this.name,data:this.encode(),start_x:this.start_location.x,start_y:this.start_location.y})},encode:function(a){a=a||this.tilemap;var b=this,c="",d=this.get("encoding"),e,f=0,g=a.length;while(f<g)e=a[f],e.isArray?e[0].isArray&&f!==0?c+="."+b.encode(e):c+="\n"+b.encode(e):c+=e<d?"0"+e.toString(d):e.toString(d),f++;return c},isBlocking:function(a){var b=k(a.y),c=k(a.x);return this.tilemap[b][c].isBlocking()}}),o.methods({begin:function q(){return this.attributes.paused?!1:(a.requestAnimationFrame(this.begin.bind(this)),q.then=q.then||this.created_at,q.now=Date.now(),this.set("fps",1e3/(q.now-q.then)),this.shift=60/(1e3/(q.now-q.then)),q.then=q.now,this.draw())},pause:function(){if(this.get("paused"))return;this.set("paused",!0);var c=this.ctx,d=this.canvas;b.Rectangle(c,0,0,a.innerWidth,a.innerWidth,{fill:"rgba(0,0,0,0.6)"}),b.Text(c,"PAUSED",d.width/2,d.height/2+1,{align:"center",color:"#000"}),b.Text(c,"PAUSED",d.width/2,d.height/2,{align:"center",color:"#fff"})},play:function(){this.set("paused",!1),this.begin()},toggle:function(){this.get("paused")?this.play():this.pause()}}),o.methods({generateTilemap:function(a){var b=this,e=this.get("size"),f=this.get("tileset"),g,h,i,j,k,l,m,n,o,p=this.tileSprite=new c(f,{width:e,height:e,target:this.stagingCtx});p.once("ready",function(){b.tilesetDepth=p.spritesheet.width/e,b.tilemap=[];var q=a.trim().split("."),r=b.findCenter(),s=b.get("encoding");for(j=0;q[j];j++)for(i=0,k=q[j].trim().split("\n");k[i];i++){b.tilemap[i]=b.tilemap[i]||[];for(h=0,n=[],l=k[i].trim();l[h];h+=2){g=parseInt(l.slice(h,h+2),s),r=b.calculateTileOffset(g);var t=b.tilemap[i][h/2]=b.tilemap[i][h/2]||new d({grid:b,x:h/2,y:i,width:e,height:e,layers:[0,0,0],sprite:new c(f,{width:e,height:e,target:b.baseCtx,position:{x:e*h/2,y:e*i},offset:r})});t.layers[j]=g}}for(i=0,m=b.tilemap.length;i<m;i++)for(h=0,n=b.tilemap[i],o=n.length;h<o;h++)b.tilemap[i][h].draw();b.emit("ready")})}}),o.methods({findCenter:function(){var a=this.get("size")/2,b=this.get("scroll"),c=this.canvas;return{x:c.width/this.scale/2-a-b.x*2,y:c.height/this.scale/2-a-b.y*2}},getTileAt:function(a){var b=this.get("size"),c=this.findCenter(),d=a.x+c.x,e=a.y+c.y;return d=i(a.x/b,b),e=i(a.y/b,b),{x:d,y:e}},calculateTileOffset:function(a){var b=this.get("size"),c=this.tilesetDepth,d={x:0,y:h(a/c)*b};return d.x=a>c-1?a%c:a,d.x*=b,d}}),o.methods({fillspace:function(){var b=this.get("size");return this.canvas.width=i(a.innerWidth,b),this.canvas.height=i(a.innerHeight,b),this},replaceTile:function(a,b,c,e){var f=this.get("size"),g;return this.tilemap[b]||(this.tilemap[b]=[]),this.tilemap[b][a]||(this.tilemap[b][a]=new d(a,b,f,f)),g=this.tilemap[b][a],g.layers[c]=e,this.drawTile(g),this},clear:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.stagingCtx.clearRect(0,0,this.staging.width,this.staging.height)},panTo:function(a){var b=this.get("size")/2;return this.set("scroll",{x:k(a.x*b),y:k(a.y*b)}),this},drawTile:function(a,b){var c=this.get("size"),d=this.findCenter(),e=b||0,f=this.tileSprite,g=a.layers,h,i;f.setPosition(a.x*c,a.y*c),this.baseCtx.clearRect(a.x*c,a.y*c,c,c);for(var j=0,k=g.length;j<k;j++)h=this.calculateTileOffset(g[j]),f.setOffset(h.x,h.y),f.draw(this.baseCtx)},draw:function(){var a=this.ctx,b=this.findCenter(),c=this.layers;return this.clear(),this.stagingCtx.drawImage(this.base,0,0),this.emit("refresh"),a.scale(this.scale,this.scale),a.drawImage(this.staging,b.x,b.y),a.drawImage(this.overlay,b.x,b.y),this.renderLayers(a),a.scale(1/this.scale,1/this.scale),!0}}),o.methods({plotCourse:function(a,b,c){var d={},e=this.tilemap;for(var h in c||{})if(c.hasOwnProperty(h)){var i=c[h].tile(),j={x:k(i.x),y:k(i.y)};d[h]=e[j.y][j.x].layers[1],e[j.y][j.x].layers[1]=1}var l=g(e,[a.x,a.y],[b.x,b.y]),m=[];for(var n=0,o=l.length,p;n+1<o;n++)p=f.findAngle(l[n],l[n+1]),p===90?p=270:p===270&&(p=90),m.push(p);for(var q in c)if(c.hasOwnProperty(q)){var r=c[q].tile(),s={x:k(r.x),y:k(r.y)};e[s.y][s.x].layers[1]=d[q]}return m}})}(window,window.Tilekit),function(a){"use strict";var b=window.Geo,c=a.Sprite,d=Math.round,e=Math.roundTo,f=Math.abs,g=Math.PI,h=b.findDistance,i=b.findPoint,j=b.isWithinCone,k=window.requestAnimationFrame,l=a.Unit=a.Entity.extend();l.statics({defaults:{animation:"stand",face:270,health:100,maxHealth:100,energy:100,maxEnergy:100,path:[],position:{x:0,y:0},hearing:64,vision:96,visionCone:30,attack_speed:1,movement_speed:2,strength:1,dexterity:1,intelligence:1,vitality:1,spells:{}}}),l.methods({layers:{},isUnit:!0,tile:function(){var a=this.grid.get("size"),b=this.get("position");return{x:b.x/a,y:b.y/a}},initialize:function(b,e,f){var g=e.grid,h=g.get("size"),i=this;this.scene=e,this.grid=e.grid,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=2e3,this.canvas.height=2e3,f=f||{},f.tile&&this.set("position",{x:f.tile.x*h,y:f.tile.y*h}),this.sprite=new c(f.image,{width:h*3,height:h*3,target:this.ctx,padding:h}),g&&(this.__boundDraw=this.draw.bind(this),g.on("refresh",this.__boundDraw,this)),this.on("draw",function(){i.renderLayers(i.ctx)}),this.on("change:animation",function(a,b){if(b===a){i.sprite.iterations=0;return}var c=i.animations[a];c&&(i.sprite.keyframe=c.keyframe||1,i.sprite.iterations=0,i.sprite.base_offset.x=c.offset.x||0,i.sprite.base_offset.y=c.offset.y||0,i.sprite.setFrames(c.frames||1),i.sprite.setDuration(c.duration||1))}),this.on("change:health",function(b,c){var e=this.get("position"),f=this.grid.get("size"),g=Math.min,h=Math.max,i=g(1,h(.01,b/this.get("maxHealth"))),j=b-c,k=this.sprite;b<=0&&this.death(),b<c?(this.addLayer("pain-"+Date.now(),function(b,c,d){var h=(c.getTime()-d)/1e3;a.Text(b,j,e.x+f/2,e.y-f*h,{alpha:g(.8,.1/h),align:"center",color:"red",font:8+h*10+"pt Helvetica"})},this,1e3),this.addLayer("healthchange",function(b,c,d){var e=(c.getTime()-d)/1e3;a.Rectangle(b,k.position.x,k.position.y,k.width,k.height,{fill:"red",alpha:g(.6,.1/e),composite:"source-atop"})},this,1e3)):(this.addLayer("health"+Date.now(),function(b,c,d){var e=(c.getTime()-d)/1e3;a.Rectangle(b,k.position.x,k.position.y,k.width,k.height,{fill:"aquamarine",alpha:g(.6,.1/e),composite:"source-atop"})},this,1e3),this.addLayer("pleasure-"+Date.now(),function(b,c,d){var h=(c.getTime()-d)/1e3;a.Text(b,j,e.x+f/2,e.y-f*h,{alpha:g(.8,.1/h),align:"center",color:"green",font:8+h*10+"pt Helvetica"})},this,1e3));var l=["red","crimson","crimson","orange","orange","gold","yellow","lime","lime","lime"][d(i*9)];this.addLayer("healthbar",function(b,c,d){var e=this.get("position"),g=(c.getTime()-d)/1e3;a.Rectangle(b,e.x,e.y-f/4,f,f/8,{fill:"black",alpha:.7}),a.Rectangle(b,e.x,e.y-f/4,f*i,f/8,{fill:l,stroke:"rgba(0,0,0,0.25)",alpha:.7})},this,1500)}),this.attributes=a.extend({},l.defaults,{name:b,created_at:Date.now()},this.attributes,f),this.layers=a.extend({},this.layers),this.setFace(this.get("face")),this.animations={stand:{offset:{x:0,y:0}},walk:{frames:3,duration:220,offset:{x:0,y:0}},melee:{frames:9,keyframe:3,duration:350,offset:{y:h*13},iterations:1},range:{frames:7,keyframe:6,duration:500,offset:{y:h*26},iterations:1},spell:{frames:11,duration:400,offset:{y:h*39},iterations:1}}}}),l.methods({getTileFront:function(a){return i(this.tile(),a||1,-this.get("face"))},getPositionFront:function(a){var b=this.grid.get("size");return i(this.get("position"),b*(a||1),-this.get("face"))},getTileBack:function(a){return i(this.tile(),a||1,this.get("face"))},getPositionBack:function(a){var b=this.grid.get("size");return i(this.get("position"),b*(a||1),this.get("face"))},setFace:function(a){var b=a.isUnit?f(a.get("face")-180):a,c=this.grid.get("size");switch(a){case 90:this.sprite.setOffset(undefined,c*6);break;case 270:this.sprite.setOffset(undefined,0);break;case 0:this.sprite.setOffset(undefined,c*9);break;case 180:this.sprite.setOffset(undefined,c*3)}return this.set("face",b),this}}),l.methods({toJSON:function(){return a.extend({},this.attributes,this.tile())},remove:function(){this.grid.removeListener("refresh",this.__boundDraw)}}),l.methods({registerAction:function(a,b){var c=this;this.actions[a]=function(){return c.acting?!1:(c.acting=!0,b.apply(c,c.ctx,Date.now()),c.sprite.once("iteration",function(){c.acting=!1}),c)}},attack:function(){if(this.acting)return!1;this.acting=!0;var b=this;this.halt(),this.set("animation","melee"),this.sprite.once("keyframe",function(){a.emit("damage",b.getPositionFront(),b)}),this.sprite.once("iteration",function(){b.acting=!1})},shoot:function(){if(this.acting)return!1;this.acting=!0;var b=this.grid.get("size"),c=Math.roundTo(this.get("vision")/b,b),d=this;this.halt(),this.set("animation","range"),this.sprite.once("keyframe",function(){a.Projectile({source:d,from:d.get("position"),distance:d.get("vision")*2,angle:d.get("face"),scene:d.scene})}),this.sprite.once("iteration",function(){d.acting=!1})},castSpell:function(a,b){var c=this;if(this.acting)return!1;this.acting=!0,this.halt(),this.set("animation","spell"),this.get("spells")[a].apply(this,b,Date.now()),this.emit("spell",this.get("position")),this.sprite.once("iteration",function(){c.acting=!1})},death:function(){var b=this.get("position"),c=this.grid.get("size");a.emit("death",this),this.emit("death"),this.scene.remove(this)}}),l.methods({clear:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)},draw:function(){var a=this.get("position"),b=this.animations[this.get("animation")];this.clear(),b.iterations!==0&&this.sprite.iterations>=b.iterations&&this.set("animation","stand"),this.sprite.animate(),this.sprite.setPosition(a.x,a.y).draw(),this.emit("draw"),this.grid.stagingCtx.drawImage(this.canvas,0,0)}}),l.methods({halt:function(a){var b=this.grid.get("size"),c=this.get("position"),d=this.tile();this.set({moving:!1,position:{x:e(c.x,b),y:e(c.y,b)},path:[],animation:"stand"}),a&&(this.grid.emit("tile:"+d.x+","+d.y),this.grid.emit("tile:*,"+d.y),this.grid.emit("tile:"+d.x+",*"))},move:function m(a,b,c){function p(){var a=d(e.shift);return j.x=m(o.x,j.x+l.x*a*h),j.y=n(o.y,j.y+l.y*a*h),b&&e.panTo(f.tile()),j.x===o.x&&j.y===o.y?(f.halt(!0),c.apply(f,[Date.now()])):k(p)}if(this.get("moving"))return!1;this.set("moving",!0),c=c||function(){},this.setFace(a);var e=this.grid,f=this,g=e.get("size"),h=this.get("movement_speed"),j=this.get("position"),l=i({x:0,y:0},1,-a),m=l.x>0?Math.min:Math.max,n=l.y>0?Math.min:Math.max,o=i(j,g,-a);return this.set("animation","walk"),this.detectHit(l.x*g,l.y*g)?this.halt(!0):(p(),this)},setPath:function n(a,b){function h(){g.length&&c===n.__audit&&e.move(g.shift(),b.pan,h)}var c=n.__audit=Date.now();b=b||{};var e=this,f=this.tile(),g;this.is("moving")&&this.halt(),a.isUnit&&(a=a.tile),f={x:d(f.x),y:d(f.y)},g=this.set("path",this.grid.plotCourse(f,a,this.scene.units)),h()},detectHit:function(a,b){var c=this.scene.units,d=this.grid,e=d.get("size"),f=this.get("position"),g=this.tile(),i=this.get("name").toLowerCase(),k=!1,l={x:f.x+(a||0),y:f.y+(b||0)},m={x:l.x/e,y:l.y/e};d.isBlocking(m)&&(this.emit("blocked",m),k=!0);for(var n in c)if(c.hasOwnProperty(n)&&c[n]!==this){var o=c[n],p=o.get("position"),q=h(l,p)-e/2,r=o.get("vision")||0,s=o.get("visionCone")||0,t=o.get("hearing")||0,u=o.get("face");j(p,l,r,u,s)&&o.emit(["see","see:"+i],this),t>q&&o.emit(["hear","hear"+i],this);if(e>q+e){var v=o.get("name").toLowerCase();this.emit(["collision","collision:"+v],o),o.emit(["collision","collision:"+i],this),k=!0}}return k}}),l.methods({addSpell:function(a,b){var c=this.get("spells");c[a]=b},removeSpell:function(a){delete this.get("spells")[a]}})}(window.Tilekit),function(a){var b=window.Geo.findPoint,c=a.Character=a.Unit.extend();c.statics({defaults:{comment:"",emote:"",movement_speed:2,hearing:64,vision:96,visionCone:30}}),c.methods({showName:!1,initialize:function(b,d,e){this.supr(b,d,e),a.extend(this.attributes,c.defaults,e);var f=d.grid.get("size");this.emote_sprite=new a.Sprite(a.defaults.emote_sprite,f,f,0,0),this.addLayer("emote",function(){var a=this.emote_sprite,b=this.get("position"),c=this.grid.get("size"),d={surprised:[0,0],sad:[32,0],love:[64,0],power:[96,0],happy:[128,0],disguise:[160,0],poison:[0,32],quest:[32,32],idea:[64,32],see:[0,64],hear:[32,64]}[this.get("emote")]||!1;if(!d)return!1;a.setPosition(b.x,b.y-(c+Math.cos(Date.now()/500)*2)),a.setOffset(d[0],d[1]),a.draw(this.ctx)},this),this.addLayer("renderName",function(){if(!this.showName)return;var a=this.ctx,b=this.get("name");a.font="15px monospace",a.fillStyle="#000";var c=this.ctx.measureText(b).width;a.fillText(b,this.tile.x*32-c/10,this.tile.y*31)},this)}})}(window.Tilekit),function(a){var b=window.Geo.findPoint,c=a.Projectile=function(c){var d=a.extend({damage:0,source:null,distance:300,speed:10,angle:0,scene:null},c),e=d.scene,f=d.scene.grid,g=f.get("size"),h=0,i=f.get("size")/2,j="projectile"+Date.now(),k=d.source.get("position");f.addLayer(j,function(c){var e=f.findCenter();h+=d.speed;var k=b(d.from,h,-d.angle);a.emit("damage",k,d.source),a.Rectangle(c,k.x+e.x+i,g/2+k.y+e.y,5,5,{fill:"#000"}),h>d.distance&&f.removeLayer(j)})}}(window.Tilekit),function(a){var b=window.Geo,c=b.findDistance,d=a.Character,e=window.Textbox,f=a.Scene=window.klass(function(b){b=b||{},a.extend(this,{units:[]},b),this.units.length&&this.add(this.units)});f.prototype.add=function(b){var c=0,e;if(b.isArray){while(b[c])e=b[c],e.tile=e.tile||{x:e.x||0,y:e.y||0},this.add(e),c++;return}return b instanceof a.Unit?(e=this.units[b.get("name")]=b,e):(b=a.extend({},{image:a.defaults.character_sprite,tile:{x:b.x||0,y:b.y||0}},b),e=this.units[b.name]=new d(b.name,this,b),e)},f.prototype.remove=function(b){b instanceof a.Unit&&(b=b.get("name"));if(!this.units[b])return;this.units[b].remove(),delete this.units[b]},f.prototype.message=function(a,b,c){var d=this.grid,f=Date.now();c=c||function(){},this.grid.addLayer("message-"+f,function(c,f){var g=new e({header:a,subheader:(new Array(a.length+3)).join("-"),body:b,context:d.c});g.draw.apply(g)}),$(window).one("keydown",function(a){return d.removeLayer("message-"+f),c(a),!1})},f.prototype.find=function(a){for(var b in this.units)if(this.units.hasOwnProperty(b)&&a(this.units[b]))return this.units[b];return!1},f.prototype.findAt=function(a,b){var d=b||this.grid.get("size"),e,f;for(var g in this.units){if(!this.units.hasOwnProperty(g))continue;e=this.units[g].get("position"),f=c(a,e);if(f<d)return this.units[g]}},f.prototype.fetch=function(a,b){return $.get(a,function(a){b(a)}),{then:function(a){b=a}}}}(window.Tilekit),function(a){var b=a.Battle=window.klass({initialize:function(a){if(!a)throw new Error("Tilekit::Battle#initialize requires a scene");this.scene=a},damage:function(b,c){var d,e;d=b instanceof a.Unit?b:this.scene.findAt(b),d&&d!==c&&(e=d.get("health"),d.set("health",e-c.get("strength")))},heal:function(b,c){var d,e;d=b instanceof a.Unit?b:this.scene.findAt(b),d&&(e=d.get("health"),d.set("health",e+c.get("intelligence")))}})}(window.Tilekit),function(a){a.Explosion=function(b,c){var d=b.findCenter(),e=b.get("size"),f=new a.Sprite(a.defaults.explosion_sprite,{frames:14,duration:700,width:e*2,height:e*2,padding:e/2,position:{x:c.x+d.x,y:c.y+d.y}});f.on("ready",function(){b.addLayer("explosion-"+Date.now(),function(a){var d=b.findCenter();f.setPosition(c.x+d.x,c.y+d.y),f.animate(),f.draw(a)},f,f.duration)})}}(window.Tilekit),function(a){a.Smoke=function(b,c){var d=b.findCenter(),e=b.get("size"),f=new a.Sprite("images/smoke.png",{frames:9,duration:500,width:e*2,height:e*2,padding:e/2,position:{x:c.x+d.x,y:c.y+d.y}});f.on("ready",function(){b.addLayer("smoke-"+Date.now(),function(a){var d=b.findCenter();f.setPosition(c.x+d.x,c.y+d.y),f.animate(),f.draw(a)},f,f.duration)})}}