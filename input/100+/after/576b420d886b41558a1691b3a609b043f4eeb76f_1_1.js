function(a){a.widget("custom.autocompleteOSB",a.ui.autocomplete,{_renderMenu:function(b,c){var d=this,e="";a.each(c,function(a,c){if(c.category!=e){e=c.category}b.addClass("ui-autocomplete-onesearchBox");d._renderItem(b,c)})},_renderItem:function(b,c){var d=a("<div class='category "+c.category+"'>"+c.category+"</div>"),e=a("<div class='label'>"+c.label+"</div>");d.css("color",c.color);var f=a("<a>").append(d).append(e);return a("<li></li>").data("item.autocomplete",c).append(f).appendTo(b)}});var b=[];var c=function(c,e,f){a("option",f).remove();if(e.length>1){f.append("<option value='"+c+"'>"+c+"</option>")}b[c]=[];for(var g=0;g<e.length;g++){var h=e[g].name;d(e[g]);b[h]=e[g].items;f.append("<option value='"+h+"'>"+h+"</option>");b[c]=b[c].concat(b[h])}};var d=function(a){for(var b=0;b<a.items.length;b++){var c=a.items[b];c.category=a.name;if(a.fields){c.id=c[a.fields.id]||c.id;c.label=c[a.fields.label]||c.label;c.color=a.color;c.single=a.single||false}}};var e={init:function(d){var e={allLabel:"All",tags:"",categories:[]};var f=a.extend({},e,d);return this.each(function(){var d=a(this),e=d,g=d.data("onesearchbox");if(!g){d.data("onesearchbox",{target:d,options:f});g=d.data("onesearchbox");g.categoriesSel=a("<select>").insertAfter(d);g.options.selection=[];function h(){d.autocompleteOSB({delay:0,source:b[g.options.allLabel],open:function(b,c){var e=d.width()+a(".ui-combobox").width();var f=a(d.autocompleteOSB("widget")[0]);f.width(e-10);a("li .label").width(d.width()-10)},select:function(b,c){var d=a("li[data-id="+c.item.id+"]",a(g.options.tags));if(d.filter("."+c.item.category).length>0)return false;if(c.item.single&&a("."+c.item.category,a(g.options.tags)).length>0)return false;var e=a("<li>"+c.item.label+"<a href='#' class='close'>x</a></li>").addClass(c.item.category).css("border-color",c.item.color).attr("data-id",c.item.id);g.options.selection.push(c.item);a(g.options.tags).append(e);a("#searchBox").val("");if(g.options.added)g.options.added(c.item.category,c.item.id);return false}}).attr("class","ui-state-default ui-autocomplete-input ui-widget ui-widget-content ui-corner-left")}function i(){g.categoriesSel.combobox({selected:function(a){d.autocompleteOSB("option","source",b[g.categoriesSel.val()])},opened:function(c,d){a("li",d).each(function(){if(a(this).text()!=g.options.allLabel){var c=b[a(this).text()];if(c)a("a",this).css("color",c[0].color||"")}})}}).change(function(a){d.autocompleteOSB("option","source",b[g.categoriesSel.val()])}).next("span.ui-combobox").find("input").attr("readonly","readonly").removeClass("ui-corner-left")}function j(){function b(b){var c=a(this).parents("ul").children("li");var d=a(this).attr("class");c.not("."+d).stop(true).animate({opacity:b},500)}a("a.close",g.options.tags).live("click",function(){var c,d=a(this).parents("li");for(var e=0;e<g.options.selection.length;e++){if(g.options.selection[e].id==d.attr("data-id")){c=e;break}}var f=g.options.selection[c].category;g.options.selection.splice(c,1);b.call(this,1);a(this).parents("li").remove();if(g.options.removed)g.options.removed(f)});if(!f.tags){g.options.tags=a("<ul></ul>");g.options.tags.insertAfter(d)}a(g.options.tags).addClass("onesearchBox-tags");a("li",g.options.tags).live("mouseenter",function(){b.call(this,.2)}).live("mouseleave",function(){b.call(this,1)})}c(g.options.allLabel,g.options.categories,g.categoriesSel);h();i();j()}})},rebind:function(d){var e=a(this),f=e.data("onesearchbox"),g=f.options.categories;for(var h=0;h<g.length;h++){if(g[h].name===d.name){g[h].items=d.items;break}}c(f.options.allLabel,g,f.categoriesSel);e.autocompleteOSB("option","source",b[f.options.allLabel])},clear:function(b){function e(e){var g=d.options.selection;for(var h=0;h<g.length;h++){if(!e||g[h].category===e){c.data("onesearchbox").options.selection.splice(h,1);h--}}if(e)a("li."+b[f],a(d.options.tags)).remove();else a("li",a(d.options.tags)).remove()}var c=a(this),d=c.data("onesearchbox");b=b||[];if(!b.length){e()}else{for(var f=0;f<b.length;f++){e(b[f])}}var g=a(".ui-combobox").prev();g.change(function(){var b=a(this),c=b.next().children("input"),d=b.find("option:selected");c.val(b.children(":selected").text());c.trigger("autocompleteselect",{item:{label:d.text(),option:d[0],value:d.val()}})});g.val("Todos").trigger("change");return this},selection:function(){var b=a(this),c=b.data("onesearchbox");var d={};var e=c.options.selection;for(var f=0;f<e.length;f++){catName=e[f].category;if(!d[catName])d[catName]=[];d[catName].push(e[f].id)}return d}};a.fn.onesearchbox=function(b){if(e[b]){return e[b].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof b==="object"||!b){return e.init.apply(this,arguments)}else{a.error("Method "+b+" does not exist on jQuery.onesearchbox")}}}