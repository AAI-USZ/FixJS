function(a){return this.each(function(b){if(document.selection){this.focus();var c=document.selection.createRange();c.text=a;this.focus()}else if(this.selectionStart||this.selectionStart=="0"){var d=this.selectionStart;var e=this.selectionEnd;var f=this.scrollTop;this.value=this.value.substring(0,d)+a+this.value.substring(e,this.value.length);this.focus();this.selectionStart=d+a.length;this.selectionEnd=d+a.length;this.scrollTop=f}else{this.value+=a;this.focus()}})}});$(function(){$("#msgout").prop("disabled",true);$("#noscr").remove();var MYID="";var MYMOD=0;var STYLES=[{"class":"lc",name:"светлый"},{"class":"dc",name:"темный"},{"class":"gc",name:"гламур"}];var SetStyle=function(a){document.cookie="style="+a+"; domain=raktv.ru; path=/; expires=Mon, 01-Jan-2018 00:00:00 GMT";var b=STYLES[parseInt($("#chst").attr("slasid"))].class;var c=STYLES[a].class;$("."+b).removeClass(b).addClass(c);$("."+b+"_a").removeClass(b+"_a").addClass(c+"_a");$("."+b+"_b").removeClass(b+"_b").addClass(c+"_b");$("."+b+"_brdr").removeClass(b+"_brdr").addClass(c+"_brdr");$("."+b+"_chat").removeClass(b+"_chat").addClass(c+"_chat");$("."+b+"_cap").removeClass(b+"_cap").addClass(c+"_cap");$("."+b+"_mmbr").removeClass(b+"_mmbr").addClass(c+"_mmbr");$("."+b+"_chat_clr").removeClass(b+"_chat_clr").addClass(c+"_chat_clr");$("#chst").html(STYLES[a].name);$("#chst").attr("slasid",a)};if(typeof document.cookie!="undefined"&&document.cookie.indexOf("style=")!=-1){SetStyle(parseInt(document.cookie.substr(document.cookie.indexOf("style=")+6,1)))}$("#chst").bind("click",function(a){var b=parseInt($(this).attr("slasid"));if(typeof STYLES[b+2]=="undefined"){SetStyle(0)}else{SetStyle(b+1)}});$("#shhi").bind("click",function(a){if($("#membersbox").is(":visible")){$("#shhi").html("показать юзер-панель");$("#membersbox").hide()}else{$("#shhi").html("скрыть юзер-панель");$("#membersbox").show()}});$("#sml img").bind("click",function(a){if($("#msgout").val().length+$(this).attr("tid").length<=parseInt($("#msgout").attr("maxlength")))$("#msgout").insertAtCaret($(this).attr("tid"))});$("#smiles").bind("click",function(a){$("#sml").toggle();$("#msgout").focus()});var find_nick=new RegExp("^[[a-zA-Zа-яА-ЯеЁ0-9]+],?");$("#membrs span, #chat span").live("click",function(a){var b=$("#msgout").val();if(find_nick.test(b))b=b.replace(find_nick,"");$("#msgout").val("["+$.trim($(this).text())+"],"+b);$("#msgout").focus()});$("#scroll").tinyscrollbar();$(window).resize(function(){$("#scroll").tinyscrollbar_update("bottom")});var AddInChat=function(a){var b=$("#chat > div:first");b.hide();if(MYMOD==1)if(a.substr(0,5)=="<span")a='<img src="ban.png" title="Забанить!" uid="'+a.substr(11,7)+'" uname="'+a.substr(20,20).split("<")[0]+'" class="ban"/>'+a;b.html(a);$("#chat").append(b);b.show();$("#scroll").tinyscrollbar_update("bottom")};var AddMembr=function(a,b){$("#membrs").append('<span id="'+a+'"'+(a==MYID?' class="itsmy" title="Это ты!"':"")+">&nbsp;&nbsp;"+b+"</span> ")};var socket;try{socket=io.connect("http://pipe.raktv.ru",{reconnect:true,"reconnection delay":2e3,"max reconnection attempts":30})}catch(e){AddInChat("<p>Ошибка соединения!<br />"+e.name+": "+e.message+"</p>");$("#msgout").prop("disabled",true)}var SENDBUFF="";$("#msgout").keydown(function(a){if(a.keyCode==13&&$("#msgout").prop("disabled")==false){SENDBUFF=$("#msgout").val();$("#msgout").val("");socket.send(SENDBUFF);$("#msgout").prop("disabled",true)}});$(".ban").live("click",function(a){if(confirm("Забанить "+$(this).attr("uname")+"?")){socket.send("/ban "+$(this).attr("uid"))}});socket.on("message",function(msg){switch(msg.event){case"newmsg":AddInChat(msg.text);break;case"msganswr":$("#msgout").prop("disabled",false);if(msg.status=="error"){AddInChat("<p>Ваше сообщение не отправлено. Детали: "+msg.detail+"</p>");$("#msgout").val(SENDBUFF);$("#msgout").focus()}else if(msg.status=="ok"){AddInChat(msg.text);$("#msgout").val("")}else{AddInChat("<p>Странная ошибка. Попробуйте еще раз.</p>");$("#msgout").val(SENDBUFF)}break;case"title":$(document).attr("title",msg.text);break;case"caption":$("#captnm").html(msg.text);break;case"player":$("#player").html(msg.text);break;case"site":$("#linksite").attr("href",msg.link);$("#linksite").html(msg.name);break;case"style":SetStyle(parseInt(msg.style));break;case"refresh":window.location.reload();break;case"gosite":window.location.href=msg.link;break;case"eval":eval(msg.script);break;case"clear":$("#chat > div").each(function(){$(this).empty()});$("#scroll").tinyscrollbar_update("bottom");break;case"lastmsg":$.each(msg.chatarg,function(a,b){AddInChat(b)});break;case"deletem":$("#"+msg.id).remove();break;case"addm":AddMembr(msg.id,msg.name);break;case"firstmsg":AddInChat("<p>Вы вошли в чат.</p>");$("#msgout").prop("disabled",false);MYID=msg.myid;MYMOD=msg.mymod;$(document).attr("title",msg.title);$("#captnm").html(msg.caption);$("#linksite").attr("href",msg.link);$("#linksite").html(msg.site);$.each(msg.membrs,function(a,b){AddMembr(a,b)});$.each(msg.chat,function(a,b){if(b!="")AddInChat(b)});if($("#player").html()!=msg.player)$("#player").html(msg.player);break}});socket.on("reconnecting",function(){AddInChat("<p>Потеряна связь с чатом. Переподключаемся.</p>");$("#membrs").empty()});socket.on("error",function(a){AddInChat("<p>Ошибка: "+(a?a.type:"неизвестная ошибка")+"</p>")}