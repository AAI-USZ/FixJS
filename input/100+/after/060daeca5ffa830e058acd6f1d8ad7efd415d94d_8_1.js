function aStar(a,b,c,d){function m(){switch(d){case"Diagonal":case"Euclidean":d=r;break;case"DiagonalFree":case"EuclideanFree":d=s;break;default:d=function(){}}}function n(b,c){return a[c][b].isTraversable()}function o(a,b){return{Parent:a,value:b.x+b.y*i,x:b.x,y:b.y,f:0,g:0}}function p(){var a=o(null,{x:b[0],y:b[1]}),d=o(null,{x:c[0],y:c[1]}),e=new Array(k),f=[a],g=[],h=[],i,j,m,n,p,r,s,t;while(n=f.length){p=k,r=-1;for(s=0;s<n;s++)f[s].f<p&&(p=f[s].f,r=s);j=f.splice(r,1)[0];if(j.value===d.value){m=g[g.push(j)-1];do h.push([m.x,m.y]);while(m=m.Parent);e=g=f=[],h.reverse()}else{i=q(j.x,j.y);for(s=0,t=i.length;s<t;s++)m=o(j,i[s]),e[m.value]||(m.g=j.g+l(i[s],j),m.f=m.g+l(i[s],d),f.push(m),e[m.value]=!0);g.push(j)}}return h}function q(a,b){var c=b-1,e=b+1,f=a+1,g=a-1,h=c>-1&&n(a,c),k=e<j&&n(a,e),l=f<i&&n(f,b),m=g>-1&&n(g,b),o=[];return h&&o.push({x:a,y:c}),l&&o.push({x:f,y:b}),k&&o.push({x:a,y:e}),m&&o.push({x:g,y:b}),d(h,k,l,m,c,e,f,g,o),o}function r(a,b,c,d,e,f,g,h,i){a&&(c&&n(g,e)&&i.push({x:g,y:e}),d&&n(h,e)&&i.push({x:h,y:e})),b&&(c&&n(g,f)&&i.push({x:g,y:f}),d&&n(h,f)&&i.push({x:h,y:f}))}function s(a,b,c,d,e,f,g,h,k){a=e>-1,b=f<j,c=g<i,d=h>-1,c&&(a&&n(g,e)&&k.push({x:g,y:e}),b&&n(g,f)&&k.push({x:g,y:f})),d&&(a&&n(h,e)&&k.push({x:h,y:e}),b&&n(h,f)&&k.push({x:h,y:f}))}function t(a,b){return f(e(a.x-b.x),e(a.y-b.y))}function u(a,b){return h(g(a.x-b.x,2)+g(a.y-b.y,2))}function v(a,b){return e(a.x-b.x)+e(a.y-b.y)}var e=Math.abs,f=Math.max,g=Math.pow,h=Math.sqrt,i=a[0].length,j=a.length,k=i*j,l={Diagonal:t,DiagonalFree:t,Euclidean:u,EuclideanFree:u,Manhattan:v}[d]||v;return p(m())}!function(a,b){function e(){this._events=new Object}function f(a){a&&(a.delimiter&&(this.delimiter=a.delimiter),a.wildcard&&(this.wildcard=a.wildcard),this.wildcard&&(this.listenerTree=new Object))}function g(a){this._events=new Object,f.call(this,a)}function h(a,b,c,d){if(!c)return[];var e=[],f,g,i,j,k,l,m,n=b.length,o=b[d],p=b[d+1];if(d===n&&c._listeners){if(typeof c._listeners=="function")return a&&a.push(c._listeners),[c];for(f=0,g=c._listeners.length;f<g;f++)a&&a.push(c._listeners[f]);return[c]}if(o==="*"||o==="**"||c[o]){if(o==="*"){for(i in c)i!=="_listeners"&&c.hasOwnProperty(i)&&(e=e.concat(h(a,b,c[i],d+1)));return e}if(o==="**"){m=d+1===n||d+2===n&&p==="*",m&&c._listeners&&(e=e.concat(h(a,b,c,n)));for(i in c)i!=="_listeners"&&c.hasOwnProperty(i)&&(i==="*"||i==="**"?(c[i]._listeners&&!m&&(e=e.concat(h(a,b,c[i],n))),e=e.concat(h(a,b,c[i],d))):i===p?e=e.concat(h(a,b,c[i],d+2)):e=e.concat(h(a,b,c[i],d)));return e}e=e.concat(h(a,b,c[o],d+1))}j=c["*"],j&&h(a,b,j,d+1),k=c["**"];if(k)if(d<n){k._listeners&&h(a,b,k,n);for(i in k)i!=="_listeners"&&k.hasOwnProperty(i)&&(i===p?h(a,b,k[i],d+2):i===o?h(a,b,k[i],d+1):(l={},l[i]=k[i],h(a,b,{"**":l},d+1)))}else k._listeners?h(a,b,k,n):k["*"]&&k["*"]._listeners&&h(a,b,k["*"],n);return e}function i(a,b){a=typeof a=="string"?a.split(this.delimiter):a.slice();for(var e=0,f=a.length;e+1<f;e++)if(a[e]==="**"&&a[e+1]==="**")return;var g=this.listenerTree,h=a.shift();while(h){g[h]||(g[h]=new Object),g=g[h];if(a.length===0){if(!g._listeners)g._listeners=b;else if(typeof g._listeners=="function")g._listeners=[g._listeners,b];else if(c(g._listeners)){g._listeners.push(b);if(!g._listeners.warned){var i=d;typeof this._events.maxListeners!="undefined"&&(i=this._events.maxListeners),i>0&&g._listeners.length>i&&(g._listeners.warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",g._listeners.length),console.trace())}}return!0}h=a.shift()}return!0}var c=Array.isArray?Array.isArray:function(a){return Object.prototype.toString.call(a)==="[object Array]"},d=10;g.prototype.delimiter=".",g.prototype.setMaxListeners=function(a){this._events||e.call(this),this._events.maxListeners=a},g.prototype.event="",g.prototype.once=function(a,b){return this.many(a,1,b),this},g.prototype.many=function(a,b,c){function e(){--b===0&&d.off(a,e),c.apply(this,arguments)}var d=this;if(typeof c!="function")throw new Error("many only accepts instances of Function");return e._origin=c,this.on(a,e),d},g.prototype.emit=function(){this._events||e.call(this);var a=arguments[0];if(a==="newListener"&&!this._events.newListener)return!1;if(this._all){var b=arguments.length,c=new Array(b-1);for(var d=1;d<b;d++)c[d-1]=arguments[d];for(d=0,b=this._all.length;d<b;d++)this.event=a,this._all[d].apply(this,c)}if(a==="error"&&!this._all&&!this._events.error&&(!this.wildcard||!this.listenerTree.error))throw arguments[1]instanceof Error?arguments[1]:new Error("Uncaught, unspecified 'error' event.");var f;if(this.wildcard){f=[];var g=typeof a=="string"?a.split(this.delimiter):a.slice();h.call(this,f,g,this.listenerTree,0)}else f=this._events[a];if(typeof f=="function"){this.event=a;if(arguments.length===1)f.call(this);else if(arguments.length>1)switch(arguments.length){case 2:f.call(this,arguments[1]);break;case 3:f.call(this,arguments[1],arguments[2]);break;default:var b=arguments.length,c=new Array(b-1);for(var d=1;d<b;d++)c[d-1]=arguments[d];f.apply(this,c)}return!0}if(f){var b=arguments.length,c=new Array(b-1);for(var d=1;d<b;d++)c[d-1]=arguments[d];var i=f.slice();for(var d=0,b=i.length;d<b;d++)this.event=a,i[d].apply(this,c);return i.length>0||this._all}return this._all},g.prototype.on=function(a,b){if(typeof a=="function")return this.onAny(a),this;if(typeof b!="function")throw new Error("on only accepts instances of Function");this._events||e.call(this),this.emit("newListener",a,b);if(this.wildcard)return i.call(this,a,b),this;if(!this._events[a])this._events[a]=b;else if(typeof this._events[a]=="function")this._events[a]=[this._events[a],b];else if(c(this._events[a])){this._events[a].push(b);if(!this._events[a].warned){var f=d;typeof this._events.maxListeners!="undefined"&&(f=this._events.maxListeners),f>0&&this._events[a].length>f&&(this._events[a].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[a].length),console.trace())}}return this},g.prototype.onAny=function(a){this._all||(this._all=[]);if(typeof a!="function")throw new Error("onAny only accepts instances of Function");return this._all.push(a),this},g.prototype.addListener=g.prototype.on,g.prototype.off=function(a,b){if(typeof b!="function")throw new Error("removeListener only takes instances of Function");var d,e=[];if(this.wildcard){var f=typeof a=="string"?a.split(this.delimiter):a.slice();e=h.call(this,null,f,this.listenerTree,0)}else{if(!this._events[a])return this;d=this._events[a],e.push({_listeners:d})}for(var g=0;g<e.length;g++){var i=e[g];d=i._listeners;if(c(d)){var j=-1;for(var k=0,l=d.length;k<l;k++)if(d[k]===b||d[k].listener&&d[k].listener===b||d[k]._origin&&d[k]._origin===b){j=k;break}if(j<0)return this;this.wildcard?i._listeners.splice(j,1):this._events[a].splice(j,1),d.length===0&&(this.wildcard?delete i._listeners:delete this._events[a])}else if(d===b||d.listener&&d.listener===b||d._origin&&d._origin===b)this.wildcard?delete i._listeners:delete this._events[a]}return this},g.prototype.offAny=function(a){var b=0,c=0,d;if(a&&this._all&&this._all.length>0){d=this._all;for(b=0,c=d.length;b<c;b++)if(a===d[b])return d.splice(b,1),this}else this._all=[];return this},g.prototype.removeListener=g.prototype.off,g.prototype.removeAllListeners=function(a){if(arguments.length===0)return!this._events||e.call(this),this;if(this.wildcard){var b=typeof a=="string"?a.split(this.delimiter):a.slice(),c=h.call(this,null,b,this.listenerTree,0);for(var d=0;d<c.length;d++){var f=c[d];f._listeners=null}}else{if(!this._events[a])return this;this._events[a]=null}return this},g.prototype.listeners=function(a){if(this.wildcard){var b=[],d=typeof a=="string"?a.split(this.delimiter):a.slice();return h.call(this,b,d,this.listenerTree,0),b}return this._events||e.call(this),this._events[a]||(this._events[a]=[]),c(this._events[a])||(this._events[a]=[this._events[a]]),this._events[a]},g.prototype.listenersAny=function(){return this._all?this._all:[]},typeof define=="function"&&define.amd?define(function(){return g}):a.EventEmitter2=g}(typeof process!="undefined"&&typeof process.title!="undefined"&&typeof exports!="undefined"?exports:window),!function(a,b){typeof define=="function"?define(b):typeof module!="undefined"?module.exports=b():this[a]=b()}("klass",function(){function a(a){return e.call(b(a)?a:function(){},a,1)}function b(a){return typeof a===h}function c(a,b,c){return function(){var d=this.supr;this.supr=c[j][a];var e=b.apply(this,arguments);return this.supr=d,e}}function d(a,d,e){for(var f in d)d.hasOwnProperty(f)&&(a[f]=b(d[f])&&b(e[j][f])&&i.test(d[f])?c(f,d[f],e):d[f])}function e(a,c){function e(){}function f(){this.initialize?this.initialize.apply(this,arguments):(c||i&&g.apply(this,arguments),k.apply(this,arguments))}e[j]=this[j];var g=this,h=new e,i=b(a),k=i?a:this,l=i?{}:a;return f.methods=function(a){return d(h,a,g),f[j]=h,this},f.methods.call(f,l).prototype.constructor=f,f.extend=arguments.callee,f[j].implement=f.statics=function(a,b){return a=typeof a=="string"?function(){var c={};return c[a]=b,c}():a,d(this,a,g),this},f}var f=this,g=f.klass,h="function",i=/xyz/.test(function(){xyz})?/\bsupr\b/:/.*/,j="prototype";return a.noConflict=function(){return f.klass=g,this},f.klass=a,a}),function(){var a={},b=Array.prototype.slice,c=Array.prototype.forEach,d={debug:!1,each:function(b,d,e){if(b==null)return;if(c&&b.forEach===c)b.forEach(d,e);else if(b.length===+b.length){for(var f=0,g=b.length;f<g;f++)if(f in b&&d.call(e,b[f],f,b)===a)return}else for(var h in b)if(b.hasOwnProperty(h)&&d.call(e,b[h],h,b)===a)return},extend:function(a){return d.each(b.call(arguments,1),function(b){for(var c in b)a[c]=b[c]}),a}};window.TK=window.Tilekit=d}(),Array.prototype.isArray=!0,Number.prototype.roundTo=function a(a){if(this<a/2)return 0;var b=a*Math.round(this/a);return b===0&&(b=a),b},Number.prototype.floorTo=function(a){if(this<a)return 0;var b=a*Math.floor(this/a);return b===0&&(b=a),b},Number.prototype.ceilTo=function b(a){if(this<a)return a;var b=a*Math.ceil(this/a);return b===0&&(b=a),b},Number.prototype.times=function(a,b){if(this===0)return;var c=~~Math.abs(this),d=0;do a.apply(b||this,[d]),c--,d++;while(c>0)},typeof window!="undefined"&&(window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}()),Function.prototype.bind||(Function.prototype.bind=function(a){if(typeof this!="function")throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e}),Math.percentChance=function(a,b){Math.random()<a/100&&b()},Math.parseDelta=function(a,b){return/\%/.test(a)?b*(parseFloat(a,10)/100):/\+|\-/.test(a)?b+parseFloat(a,10):a};var Format=window.Format={};Format.align=function(a,b,c,d){return/bottom|right/ig.test(a)?c-d-b:d},function(){var a={};a.toRadians=function(a){return a*(Math.PI/180)},a.findAngle=function(a,b){a.isArray&&(a={x:a[0],y:a[1]}),b.isArray&&(b={x:b[0],y:b[1]});var c=Math.atan2(b.y-a.y,b.x-a.x)*(180/Math.PI);return c<0?c+360:c},a.findPoint=function(b,c,d,e){e=e||100;var f=a.toRadians(d);return{x:b.x+c*~~(Math.cos(f)*e)/e,y:b.y+c*~~(Math.sin(f)*e)/e}},a.findDistance=function(a,b){var c=Math.pow(b.x-a.x,2),d=Math.pow(b.y-a.y,2),e=Math.sqrt(c+d);return e},a.isWithinCone=function(b,c,d,e,f){var g=a.findAngle(c,b),h=a.findDistance(b,c);return h>=d?!1:e-f>=g||g>=e+f?!1:!0},typeof module!="undefined"?global.Geo=a:window.Geo=a}();var Rectangle=function(a,b){var c=this,d=b.tileEngine;return $.extend(this,{x:0,y:0,stroke:null,fill:null,width:100,height:100},b),this.canvas=a,this.c=this.canvas.getContext("2d"),d&&d.on("refresh",function(){window.requestAnimationFrame(function(){c.draw()})}),this.draw=function(){var a=this.x,b=this.y;if(this.tile){var c=this.tileEngine,d=this.canvas,e=c.tile,f=c.get("size"),g=c.get("scroll"),h=d.width/2-f/2,i=d.height/2-f/2;a=this.tile.x*f,b=this.tile.y*f,a+=h-g.x*2,b+=i-g.y*2}this.fill&&(this.c.fillStyle=this.fill,this.c.fillRect(a,b,this.width,this.height)),this.stroke&&(this.c.strokeStyle=this.stroke,this.c.strokeRect(a,b,this.width,this.height))},this},TextBox=function(a){a=a||{},this.header=a.header||"???",this.subheader=a.subheader||!1,this.body=a.body||"",this.context=a.context,this.lineheight=a.lineheight||25};TextBox.prototype.setFont=function(a,b){var c=this.context;c.textBaseline="top",c.fillStyle=a,c.font=b},TextBox.prototype.drawWindow=function(){var a=this.context;a.fillStyle="#f0f0f0",a.fillRect(0,document.height-document.height*.2,document.width,document.height*.2),a.fillStyle="#333",a.fillRect(0,document.height-document.height*.2-2,document.width,2),a.fillStyle="#fff",a.fillRect(0,document.height-document.height*.2+1,document.width,1)},TextBox.prototype.drawText=function(a,b,c){this.context.fillText(a,document.width*.1+(b||0),document.height-document.height*.2+(c||0))},TextBox.prototype.drawEllipsis=function(){var a=this.context,b=document.width*.93,c=document.height-document.height*.05;a.fillStyle="#333",a.fillRect(b,c,5,5),a.fillRect(b+10,c,5,5),a.fillRect(b+20,c,5,5)},TextBox.prototype.draw=function(){var a=this.context,b=this;this.drawWindow(),this.setFont("black","bold 14pt monospace"),this.drawText(this.header,0,15),this.subheader&&(this.setFont("#666","normal 10pt monospace"),this.drawText(this.subheader,0,40)),this.setFont("#333","normal 14pt monospace");var c=0,d=this.body.split(" "),e=70,f=0,g="",h=0;while(d[f]){g=d[f],h=a.measureText(g+" ").width,c+h>document.width*.85&&(c=0,e+=this.lineheight);if(e>document.height*.2-document.height*.05)return;b.drawText(g,c,e),c+=a.measureText(g+" ").width,f++}this.drawEllipsis();return},function(a){var b=a.Timer=function(){this.date=new Date};b.prototype.update=function(){var a=new Date;this.date=a},b.prototype.getMilliseconds=function(){return this.date.getTime()},b.prototype.getSeconds=function(){return Math.round(this.date.getTime()/1e3)}}(window.Tilekit),function(a){var b=function(b,c,d,e,f,g,h,i){this.spritesheet=null,this.offsetX=0,this.offsetY=0,this.width=c,this.height=d,this.frames=1,this.currentFrame=0,this.duration=1,this.posX=0,this.posY=0,this.shown=!0,this.zoomLevel=1,this.shadow=null,this.setSpritesheet(b),this.setOffset(e,f),this.setFrames(g),this.setDuration(h),this.target=i,this.timer=new a.Timer,this.created_at=this.timer.getMilliseconds();var j=new Date;this.duration>0&&this.frames>0?this.ftime=j.getTime()+this.duration/this.frames:this.ftime=0};b.prototype.setSpritesheet=function(a){return this.spritesheet instanceof Image&&this.spritesheet.src===a?this:(a instanceof Image?this.spritesheet=a:(this.spritesheet=new Image,this.spritesheet.src=a),this)},b.prototype.setPosition=function(a,b){return this.posX=a,this.posY=b,this},b.prototype.setOffset=function(a,b){return this.offsetX=a,this.offsetY=b,this},b.prototype.setFrames=function(a){return this.currentFrame=0,this.frames=a,this},b.prototype.setDuration=function(a){return this.duration=a,this},b.prototype.nextFrame=function(){if(this.duration>0){var a=new Date;this.duration>0&&this.frames>0?this.ftime=a.getTime()+this.duration/this.frames:this.ftime=0,this.offsetX=this.width*this.currentFrame,this.currentFrame===this.frames-1?this.currentFrame=0:this.currentFrame++}return this},b.prototype.animate=function(a){return a=a||this.timer,a.update(),a.getMilliseconds()>this.ftime&&this.nextFrame(),this},b.prototype.draw=function(a,b,c){a=a||this.target;if(this.shown){if(b!==undefined&&b){if(this.shadow===null){var d=document.createElement("canvas"),e=d.getContext("2d");d.width=this.width,d.height=this.height,e.drawImage(this.spritesheet,this.offsetX,this.offsetY,this.width,this.height,0,0,this.width*this.zoomLevel,this.height*this.zoomLevel);var f=e.getImageData(0,0,d.width,d.height);for(var g=0,h=f.data.length;g<h;g+=4)f.data[g]=0,f.data[g+1]=0,f.data[g+2]=0;e.clearRect(0,0,d.width,d.height),e.putImageData(f,0,0),this.shadow=e}a.save(),a.globalAlpha=.1;var i=this.width*this.zoomLevel,j=this.height*this.zoomLevel;a.drawImage(this.shadow.canvas,this.posX,this.posY-j,i,j*2),a.restore()}a.drawImage(this.spritesheet,this.offsetX,this.offsetY,this.width,this.height,this.posX,this.posY,this.width*this.zoomLevel,this.height*this.zoomLevel)}return this},a.Sprite=b}(window.Tilekit),function(a){"use strict",a.Entity=window.klass({attributes:{},layers:{},initialize:function(b,c){this.attributes=a.extend({},this.attributes,b),this.layers=a.extend({},this.layers,c)},get:function(a){return this.attributes[a]},set:function(a,b){var c=this.attributes[a];return this.attributes[a]=b,this.emit(["change","change:"+b],b,c),this.attributes[a]},addLayer:function(a,b,c){if(!a)throw new Error("Entity#addLayer - Layer requires a namespace");if(typeof a=="object"){for(var d in a)a.hasOwnProperty(d)&&this.addLayer(d,a[d],c);return this}return this.layers[a]=b.bind(c||this),b},removeLayer:function(a){this.layers[a]&&delete this.layers[a]},renderLayers:function(a){var b=this.layers;for(var c in b)b.hasOwnProperty(c)&&typeof b[c]=="function"&&b[c].apply(this,[a||this.ctx,Date()])}}),a.extend(a.Entity.prototype,window.EventEmitter2.prototype)}(window.Tilekit),function(a){var b=Math.round,c=window.klass({x:0,y:0,width:32,height:32,layers:[],initialize:function(b){a.extend(this,b)},isTraversable:function(){return this.__blockOnce?(this.__blockOnce=undefined,!1):this.layers[1]===undefined||this.layers[1]===0},isBlocking:function(){return this.layers[1]>0},roundedTile:function(){return{x:b(this.x),y:b(this.y)}}});a.Tile=c}(window.Tilekit),function(a,b){"use strict";var c=b.Sprite,d=b.Tile,e=b.Entity,f=a.Geo,g=a.aStar,h=Math.floor,i=Math.ceil,j=Math.round,k=a.jQuery,l=b.Grid=e.extend({attributes:{encoding:24,resize:!0,paused:!1,scroll:{x:0,y:0},size:32},initialize:function(c,d,e){function g(a){var b=f.get("size"),c=f.findCenter();a.tile=f.getTileAt(a.offsetX,a.offsetY),a.position={x:a.tile.x*b+c.x,y:a.tile.y*b+c.y},f.set("mouse",a),f.emit(a.type,a)}var f=this;e=e||{},this.attributes=b.extend({},this.attributes,{tileset:d.tileset},e,{created_at:Date.now()}),this.canvas=typeof c=="string"?document.getElementById(c):c,this.ctx=this.canvas.getContext("2d"),this.on("ready",function(){var b=this.get("resize"),c=this.get("start_location");b!==!1&&(a.addEventListener("resize",function(){f.fillspace()}),f.fillspace()),c&&f.panTo(e.start_location),f.begin()}),this.canvas.addEventListener("onContextMenu",function(){return!1}),this.canvas.addEventListener("click",g),this.canvas.addEventListener("mousemove",g),this.canvas.addEventListener("mousedown",g),this.canvas.addEventListener("mouseup",g),this.start_location=e.start_location,this.portals=e.portals||[];var h=function(){f.emit("portal",k)};for(var i=0,j=this.portals.length;i<j;i++){var k=this.portals[i];this.on("tile:"+[k.x,k.y].join(","),h)}var l=this.base=document.createElement("canvas");this.baseCtx=l.getContext("2d");var m=this.staging=document.createElement("canvas");this.stagingCtx=m.getContext("2d");var n=this.debug=document.createElement("canvas");this.debugCtx=n.getContext("2d");var o=this.overlay=document.createElement("canvas");this.overlayCtx=o.getContext("2d"),l.height=n.height=m.height=o.height=e.canvasHeight||2e3,l.width=n.width=m.width=o.width=e.canvasWidth||2e3,d&&this.generateTilemap(d.data)}});l.prototype.zoom=function(a){a=this.scale=a/100,this.ctx.scale(a,a)},l.methods({toJSON:function(){return b.extend(this.attributes,{name:this.name,data:this.encode(),start_x:this.start_location.x,start_y:this.start_location.y})},encode:function(a){var b=this,c="",d=this.get("encoding"),e;a=a||this.tilemap;for(var f=0,g=a.length;f<g;f++)e=a[f],e.isArray?e[0].isArray&&f!==0?c+="."+b.encode(e):c+="\n"+b.encode(e):c+=e<d?"0"+e.toString(d):e.toString(d);return c.trim()},isBlocking:function(a){return this.tilemap[a.y][a.x].isBlocking()}}),l.methods({begin:function n(){return this.attributes.paused?!1:(a.requestAnimationFrame(this.begin.bind(this)),n.then=n.then||this.created_at,n.now=Date.now(),this.set("fps",1e3/(n.now-n.then)),this.shift=60/(1e3/(n.now-n.then)),n.then=n.now,this.draw())},pause:function(){this.set("paused",!0)},play:function(){this.set("paused",!1),this.begin()}}),l.methods({generateTilemap:function(e){var f=this,g=this.get("size"),h=this.get("tileset"),i;this.tileSprite=new c(h,g,g,0,0,this.stagingCtx);var j=new a.Image;j.src=h,j.onload=function(){f.tilesetDepth=j.width/g,f.tilemap=[];var a=e.trim().split("."),c=f.findCenter(),h=f.get("encoding");for(var k=0;a[k];k++)for(var l=0,m=a[k].trim().split("\n");m[l];l++){f.tilemap[l]=f.tilemap[l]||[];for(var n=0,o=[],p=m[l].trim();p[n];n+=2){i=parseInt(p.slice(n,n+2),h);var q=f.tilemap[l][n/2]=f.tilemap[l][n/2]||new d({x:n/2,y:l,width:g,height:g,layers:[0,0,0]});f.tilemap[l][n/2].layers[k]=i,c=f.calculateTileOffset(i);var r=g*n/2,s=g*l;f.tileSprite.setOffset(c.x,c.y),f.tileSprite.setPosition(r,s),f.tileSprite.draw(f.baseCtx),k>1&&i>0&&f.tileSprite.draw(f.overlayCtx),b.debug&&k===1&&i>0&&(f.debugCtx.fillStyle="rgba(200, 100, 0, 0.4)",f.debugCtx.fillRect(r,s,g,g)),b.debug&&k>1&&i>0&&(f.debugCtx.fillStyle="rgba(250, 256, 0, 0.4)",f.debugCtx.fillRect(r,s,g,g))}}f.save(),b.debug&&f.drawPortals(),f.emit("ready")}}}),l.methods({findCenter:function(){var a=this.get("size")/2,b=this.get("scroll"),c=this.canvas;return{x:c.width/2-a-b.x*2,y:c.height/2-a-b.y*2}},getTileAt:function(a,b){var c=this.get("size"),d=this.findCenter();return a=this.canvas.width-(this.canvas.width-a)-d.x,b=this.canvas.height-(this.canvas.height-b)-d.y,{x:a.floorTo(c)/c,y:b.floorTo(c)/c}},calculateTileOffset:function(a){var b=this.get("size"),c=this.tilesetDepth,d={x:0,y:h(a/c)*b};return d.x=a>c-1?a%c:a,d.x*=b,d},calculatePixelOffset:function(a){var b=this.findCenter(),c=this.get("size");return{x:a.x*c+b.x,y:a.y*c+b.y}}}),l.methods({save:function(){this.baseCtx.save(),this.debugCtx.save(),this.overlayCtx.save()},fillspace:function(){var a=this.get("size");return this.canvas.width=document.width.roundTo(a),this.canvas.height=document.height.roundTo(a),this},replaceTile:function(a,b,c,e){var f=this.get("size"),g;return this.tilemap[b]||(this.tilemap[b]=[]),this.tilemap[b][a]||(this.tilemap[b][a]=new d(a,b,f,f)),g=this.tilemap[b][a],g.layers[c]=e,this.drawTile(g),this},clear:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.stagingCtx.clearRect(0,0,this.staging.width,this.staging.height)},panTo:function(a){if(!a)return console.error("Grid#panTo: Coordinates must be specified for panning.");var b=this.get("size")/2;return this.set("scroll",{x:j(a.x*b),y:j(a.y*b)}),this},drawTile:function(a,b){var c=this.get("size"),d=this.findCenter(),e=b||0,f=this.tileSprite,g=a.layers,h,i;f.setPosition(a.x*c,a.y*c),this.baseCtx.clearRect(a.x*c,a.y*c,c,c);for(var j=0,k=g.length;j<k;j++)h=this.calculateTileOffset(g[j]),f.setOffset(h.x,h.y),f.draw(this.baseCtx)},drawPortals:function(){var a=this.debugCtx,b=this.get("size");this.start_location&&(a.strokeStyle="rgb(255, 180, 10)",a.fillStyle="rgba(255, 180, 10, 0.5)",a.fillRect(this.start_location.x*b,this.start_location.y*b,b,b),a.strokeRect(this.start_location.x*b,this.start_location.y*b,b,b));for(var c=0;c<this.portals.length;c++)a.strokeStyle="rgb(200, 20, 250)",a.fillStyle="rgba(200, 20, 250, 0.4)",a.fillRect(this.portals[c].x*b,this.portals[c].y*b,b,b),a.strokeRect(this.portals[c].x*b,this.portals[c].y*b,b,b)},draw:function(){var a=this.ctx,b=this.findCenter(),c=this.layers;return this.clear(),this.stagingCtx.drawImage(this.base,0,0),this.stagingCtx.save(),this.emit("refresh"),a.drawImage(this.staging,b.x,b.y),a.drawImage(this.overlay,b.x,b.y),this.renderLayers(a),!0}}),l.methods({plotCourse:function(a,b,c){var d={},e=this.tilemap;for(var h in c||{})if(c.hasOwnProperty(h)){var i=c[h].tile();d[h]=e[i.y][i.x].layers[1],e[i.y][i.x].layers[1]=1}var j=g(e,[a.x,a.y],[b.x,b.y]),k=[];for(var l=0,m=j.length,n;l+1<m;l++)n=f.findAngle(j[l],j[l+1]),n===90?n=270:n===270&&(n=90),k.push(n);for(var o in c)if(c.hasOwnProperty(o)){var p=c[o].tile();e[p.y][p.x].layers[1]=d[o]}return k}})}(window,window.Tilekit),function(a){"use strict";var b=Math.round,c=Math.abs,d=Math.PI,e=window.Geo,f=e.findDistance,g=e.isWithinCone,h=window.requestAnimationFrame,i=a.Sprite,j=a.Unit=a.Entity.extend({attributes:{speed:1,face:270,hearing:64,vision:96,visionCone:30,position:{x:0,y:0}},layers:{},isUnit:!0,tile:function(){var a=this.grid.get("size"),b=this.get("position");return{x:b.x/a,y:b.y/a}},initialize:function(a,b,c){var d=b.grid,e=d.get("size"),f=this;this.scene=b,this.grid=b.grid,this.ctx=b.grid.stagingCtx,this.set("position",{x:c.tile.x*e,y:c.tile.y*e}),this.sprite=new i(c.image,e,e,0,0,3,200,this.ctx),d.on("refresh",this.draw.bind(this),this),this.on("draw",function(){f.renderLayers(f.ctx)}),this.attributes=$.extend(!0,{name:a,created_at:Date.now()},this.attributes,c),this.layers=$.extend({},this.layers)}});j.methods({getTileFront:function(a){return e.findPoint(this.tile,a||1,this.get("face"))},getTileBack:function(a){return e.findPoint(this.tile,a||1,-this.get("face"))},setFace:function(b){if(typeof b!="number")return a.debug&&console.error("Unit#setFace requires a numerical direction."),!1;var d=b.isUnit?c(b.get("face")-180):b;switch(b){case 90:this.sprite.setOffset(0,100);break;case 270:this.sprite.setOffset(0,0);break;case 0:this.sprite.setOffset(0,150);break;case 180:this.sprite.setOffset(0,50)}return this.set("face",d),this}}),j.methods({toJSON:function(){return $.extend({},this.attributes,this.tile())},remove:function(){this.grid.removeListener("refresh",this.draw)}}),j.methods({draw:function(){var a=this.get("position");this.sprite.setPosition(a.x,a.y).draw(),this.emit("draw")}}),j.methods({halt:function(a){var b=this.grid.get("size"),c=this.get("position");this.moving=!1,this.set("position",{x:c.x.roundTo(b),y:c.y.roundTo(b)});var d=this.tile();this.sprite.currentFrame=0,a&&(this.grid.emit("tile:"+d.x+","+d.y),this.grid.emit("tile:*,"+d.y),this.grid.emit("tile:"+d.x+",*"))},move:function(a,c,d){function o(){var a=l.get("position");return l.set("position",{x:a.x+m.x*g*j,y:a.y+m.y*g*j}),c&&f.panTo(l.tile()),a.x===n.x&&a.y===n.y?(l.halt(!0),d.apply(l,[Date.now()])):(l.sprite.animate(),h(o))}if(this.moving)return!1;this.moving=!0,d=d||function(){},this.setFace(a);var f=this.grid,g=b(this.grid.shift),i=f.get("size"),j=this.get("speed"),k=this.get("position"),l=this,m=e.findPoint({x:0,y:0},1,-a),n=e.findPoint(k,i,-a);return this.detectHit(m.x*i,m.y*i)?this.halt(!0):(o(),this)},setPath:function(a,c){function i(){var a=h.shift();a!==undefined&&d.move(a,c.pan,i)}c=c||{};var d=this,e=[],f=this.grid,g=this.tile();a.isUnit&&(a=a.tile),g={x:b(g.x),y:b(g.y)},e=f.plotCourse(g,a,this.scene.units);var h=this.set("path",e);i()},detectHit:function(a,b){var c=this.scene.units,d=this.grid,e=d.get("size"),h=this.get("position"),i=this.tile(),j=this.get("name").toLowerCase(),k=!1,l={x:h.x+(a||0),y:h.y+(b||0)},m={x:l.x/e,y:l.y/e};d.isBlocking(m)&&(this.emit("blocked",m),k=!0);for(var n in c)if(c.hasOwnProperty(n)&&c[n]!==this){var o=c[n],p=o.get("position"),q=f(l,p)-e/2,r=o.get("vision")||0,s=o.get("visionCone")||0,t=o.get("hearing")||0,u=o.get("face");g(p,l,r,u,s)&&o.emit(["see","see:"+j],this),t>q&&o.emit(["hear","hear"+j],this);if(e>q+e){var v=o.get("name").toLowerCase();this.emit(["collision","collision:"+v],o),o.emit(["collision","collision:"+j],this),k=!0}}return k}})}(window.Tilekit),function(a){var b=a.Character=a.Unit.extend({attributes:{comment:"",emote:"",speed:2,face:270,hearing:64,vision:96,visionCone:30},showName:!1,initialize:function(b,c,d){this.supr(b,c,d);var e=c.grid.get("size");this.emote_sprite=new a.Sprite("/assets/emotes.png",e,e,0,0),this.layers=a.extend(this.layers,{emote:function(){var a=this.emote_sprite,b=this.get("position"),c=this.grid.get("size"),d={surprised:[0,0],sad:[32,0],love:[64,0],power:[96,0],happy:[128,0],disguise:[160,0],poison:[0,32],quest:[32,32],idea:[64,32],see:[0,64],hear:[32,64]}[this.get("emote")]||!1;if(!d)return!1;a.setPosition(b.x,b.y-(c+Math.cos(Date.now()/500)*2)),a.setOffset(d[0],d[1]),a.draw(this.ctx)},renderName:function(){if(!this.showName)return;var a=this.ctx,b=this.get("name");a.font="15px monospace",a.fillStyle="#000";var c=this.ctx.measureText(b).width;a.fillText(b,this.tile.x*32-c/10,this.tile.y*31)}})}})}(window.Tilekit),function(a){var b=a.Character,c=window.Textbox,d=a.Scene=window.klass(function(a){a=a||{},$.extend(this,{units:[]},a),this.grid=a.grid,this.units.length&&this.add(this.units)});d.prototype.add=function(a){var c=0,d;if($.isArray(a)){while(a[c])d=a[c],d.tile=d.tile||{x:d.x||0,y:d.y||0},this.add(d),c++;return}return a=$.extend({},{image:"/assets/players/default.png",tile:{x:a.x||0,y:a.y||0}},a),d=this.units[a.name]=new b(a.name,this,a),d},d.prototype.remove=function(a){if(!this.units[a])return;this.units[a].remove(),delete this.units[a]},d.prototype.message=function(a,b,d){var e=this.grid;d=d||function(){},this.grid.addLayer("message",function(d,f){var g=new c({header:a,subheader:(new Array(a.length+3)).join("-"),body:b,context:e.c});g.draw.apply(g)}),$(window).one("keydown",function(a){return e.removeLayer("message"),d(a),!1})},d.prototype.find=function(a){var b;for(var c in this.units)if(a(this.units[c]))return b;return!1},d.prototype.findAt=function(a,b){var c;for(var d in this.units){c=this.units[d].tile;if(a.x===c.x&&a.y===c.y)if(b)b(this.units[d]);else return this.units[d]}},d.prototype.fetch=function(a,b){return $.get(a,function(a){b(a)}),{then:function(a){b=a}}}}