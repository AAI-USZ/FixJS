function(c){html=a("body").data().midgardWorkflows.prepareItem(d.instance,c,function(a,c){b._clearWorkflows();if(a)return}),a(".create-ui-tool-workflowarea",this.element).append(html)})})},_setOption:function(a,b){a==="display"&&this._setDisplay(b),this.options[a]=b},_setDisplay:function(b){b==="minimized"&&a("div.create-ui-toolbar-wrapper").hide()},hide:function(){a("div.create-ui-toolbar-wrapper").fadeToggle("fast","linear")},show:function(){a("div.create-ui-toolbar-wrapper").fadeToggle("fast","linear")},_getMinimized:function(){return a('<div class="create-ui-logo"><a class="create-ui-toggle" id="create-ui-toggle-toolbar"></a></div>')},_getFull:function(){return a('<div class="create-ui-toolbar-wrapper"><div class="create-ui-toolbar-toolarea"><div class="create-ui-toolbar-dynamictoolarea"><ul class="create-ui-dynamictools create-ui-toolset-1"><li class="create-ui-tool-metadataarea"></li><li class="create-ui-tool-workflowarea"></li><li class="create-ui-tool-freearea"></li></ul></div><div class="create-ui-toolbar-statustoolarea"><ul class="create-ui-statustools"></ul></div></div></div>')},_clearWorkflows:function(){a(".create-ui-tool-workflowarea",this.element).empty()},_clearMetadata:function(){a(".create-ui-tool-metadataarea",this.element).empty()}})}(jQuery),function(a,b){a.widget("Midgard.midgardWorkflows",{options:{url:function(a){},renderers:{button:function(b,c,d,e){return button_id="midgardcreate-workflow_"+c.get("name"),html=a('<button class="create-ui-btn" id="'+button_id+'">'+c.get("label")+"</button>").button(),html.bind("click",function(a){d(b,c,e)}),html}},action_types:{backbone_save:function(a,b,c){copy_of_url=a.url,original_model=a.clone(),original_model.url=copy_of_url,action=b.get("action"),action.url&&(a.url=action.url),original_model.save(null,{success:function(b){a.url=copy_of_url,a.change(),c(null,a)},error:function(b,d){a.url=copy_of_url,a.change(),c(d,a)}})},backbone_destroy:function(a,b,c){copy_of_url=a.url,original_model=a.clone(),original_model.url=copy_of_url,action=b.get("action"),action.url&&(a.url=action.url),a.destroy({success:function(b){a.url=copy_of_url,a.change(),c(null,b)},error:function(b,d){a.url=copy_of_url,a.change(),c(d,a)}})},http:function(b,c,d){action=c.get("action");if(!action.url)return d("No action url defined!");wf_opts={},action.http&&(wf_opts=action.http),ajax_options=a.extend({url:action.url,type:"POST",data:b.toJSON(),success:function(){b.fetch({success:function(a){d(null,a)},error:function(a,b){d(b,a)}})}},wf_opts),a.ajax(ajax_options)}}},_init:function(){this._renderers={},this._action_types={},this._parseRenderersAndTypes(),this._last_instance=null,this.ModelWorkflowModel=Backbone.Model.extend({defaults:{name:"",label:"",type:"button",action:{type:"backbone_save"}}}),this.workflows={};var b=this;a(this.element).bind("midgardeditableactivated",function(a,c){b._fetchWorkflows(c.instance)})},_fetchWorkflows:function(a){var b=this;if(a.isNew()){b._trigger("changed",null,{instance:a,workflows:[]});return}if(b._last_instance==a){b.workflows[a.cid]&&b._trigger("changed",null,{instance:a,workflows:b.workflows[a.cid]});return}b._last_instance=a;if(b.workflows[a.cid]){b._trigger("changed",null,{instance:a,workflows:b.workflows[a.cid]});return}b.options.url?b._fetchModelWorkflows(a):(flows=new(b._generateCollectionFor(a))([],{}),b._trigger("changed",null,{instance:a,workflows:flows}))},_parseRenderersAndTypes:function(){var b=this;a.each(this.options.renderers,function(a,c){b.setRenderer(a,c)}),a.each(this.options.action_types,function(a,c){b.setActionType(a,c)})},setRenderer:function(a,b){this._renderers[a]=b},getRenderer:function(a){return this._renderers[a]?this._renderers[a]:!1},setActionType:function(a,b){this._action_types[a]=b},getActionType:function(a){return this._action_types[a]},prepareItem:function(a,b,c){var d=this;return renderer=this.getRenderer(b.get("type")),action_type_cb=this.getActionType(b.get("action").type),renderer(a,b,action_type_cb,function(e,f){delete d.workflows[a.cid],d._last_instance=null,b.get("action").type!=="backbone_destroy"&&d._fetchModelWorkflows(a),c(e,f)})},_generateCollectionFor:function(a){var b={model:this.ModelWorkflowModel};return this.options.url&&(b.url=this.options.url(a)),Backbone.Collection.extend(b)},_fetchModelWorkflows:function(a){if(a.isNew())return;var b=this;b.workflows[a.cid]=new(this._generateCollectionFor(a))([],{}),b.workflows[a.cid].fetch({success:function(c){b.workflows[a.cid].reset(c.models),b._trigger("changed",null,{instance:a,workflows:b.workflows[a.cid]})},error:function(a,b){}