function(d,e,a,c){var b=this;this.url=new ResourceTable.Url(d,window.location.href);this.renderDataCallBack=e;this.renderViewCallBack=a;this.pagination=new ResourceTable.Pagination();this.filterTemplate=_.template(ResourceTable.FilterTemplate);this.defaultFilter=c||{};ResourceTable.Loader.listenToAnchorChangedEvents(function(){b.url=new ResourceTable.Url(d,window.location.href);b.load()})};ResourceTable.Loader.prototype.sort=function(a,b){this.url.change_hash({sort:a,sort_direction:b})};ResourceTable.Loader.prototype.filter=function(c){var b={};var a=this;_.each(c,function(e,d){b[a.filterTemplate({key:d})]=e});this.url.change_hash(b)};ResourceTable.Loader.prototype.change_page=function(a){this.url.change_hash({page:a})};ResourceTable.Loader.prototype.load=function(){var a=this;var b=this.url.hash_to_url();if(!this.url.hasFilter()){this.filter(this.defaultFilter);return}$.getJSON(b,null,function(c){a.renderDataCallBack(c.data);var d=ResourceTable.ParseUrlRailsStyle(a.url.query);d.paginationSummary=a.pagination.generate(c);a.renderViewCallBack(d)})};ResourceTable.Loader.listenToAnchorChangedEvents=function(b){var a=this;if("onhashchanged" in window){window.onhashchange=function(){b()}}else{var c=window.location.hash;window.setInterval(function(){if(window.location.hash!=c){c=window.location.hash;b()}},100)}};ResourceTable.Pagination=function(){this.numOfLinks=1};ResourceTable.Pagination.prototype._calculatefirstAndLastPage=function(b){var a=Math.ceil(b.total/b.page_size);var d=b.page-this.numOfLinks;var c=b.page+this.numOfLinks;if(c>a){c=a;d=c-(2*this.numOfLinks)}if(d<1){c=1+(this.numOfLinks*2);if(c>a){c=a}d=1}return[d,c]};ResourceTable.Pagination.prototype.generate=function(f){var b={name:"Previous",link:f.page-1,disabled:f.page==1};var d=[b];var e=this._calculatefirstAndLastPage(f);if(e[0]>1){d.push({name:"1",link:1,disabled:false});if(e[0]>2){d.push({name:"...",link:"",disabled:true})}}_.chain(_.range(e[0],(e[1]+1))).each(function(h){d.push({name:h.toString(),link:h,disabled:h==f.page})});var g=e[1]==f.page;var c=Math.ceil(f.total/f.page_size);if(f.page!=c&&(e[1]<c)){if((e[1]+1)<c){d.push({name:"...",link:"",disabled:true})}d.push({name:c.toString(),link:c,disabled:false})}var a={name:"Next",link:f.page+1,disabled:g};d.push(a);return d};ResourceTable.Url=function(b,a){this.base_url=b;this.query=this.parse_hash(a)};ResourceTable.ParseUrlRailsStyle=function(a){var c={};_.each(a,function(f,e){var d=e.match(/^filter\[(\w+)\]$/);if(d!=null){c[d[1]]=f}});var b={page:a.page,sort:{key:a.sort,direction:a.sort_direction},filter:c};return b};ResourceTable.Url.prototype.parse_hash=function(b){var c=b.match(/([&#])([^#&=]+)=?([^&#]+)/g);var a={};_.each(c,function(e){var d=/^[&#](.+)=(.+)$/.exec(e);if(d!=null){a[d[1]]=d[2]}});return a};ResourceTable.Url.prototype.change_hash=function(a){var b=this;_.each(a,function(d,c){b.query[c]=d});ResourceTable.Navigation.change_hash(this.hash_to_query())};ResourceTable.Url.prototype.hash_to_query=function(){return _.map(this.query,function(b,a){return a+"="+b}).join("&")};ResourceTable.Url.prototype.hash_to_url=function(){var a=this.base_url+"?";a+=this.hash_to_query();return a};ResourceTable.Url.prototype.hasFilter=function(){return _.size(this.query)};ResourceTable.Navigation={};ResourceTable.Navigation.change_hash=function(a){window.location.hash=a};(function(a){a.widget("ui.resourceTable",{options:{url:"",renderDataCallBack:function(b){},paginationElement:a({}),sortElements:a({})},_create:function(){var b=this;this.filters=new ResourceTableView.Filters(b.options.filterElements,b);this.table=new ResourceTable.Loader(this.options.url,this.options.renderDataCallBack,function(c){b._renderView(c)},this.filters.currentState());this.table.load();b.options.sortElements.click(function(){b._toggleSort(a(this));return false})},sort:function(b,c){this.table.sort(b,c)},filter:function(b){this.table.filter(b)},_toggleSort:function(c){var b=this;if(c.hasClass("sort-ascending")){var d="descending"}else{var d="ascending"}b.sort(c.attr("name"),d)},_renderView:function(c){var b=this;b._renderPagination(c.paginationSummary);b._renderSort(c.sort);b._renderFilters(c.filter)},_renderPagination:function(d){var c=this;var b=this.options.paginationElement;b.empty();_.each(d,function(e){if(!e.disabled){var f=a("<a>",{href:""}).html(e.name);b.append(f);f.click(function(){c.table.change_page(e.link);return false})}else{b.append(a("<span>").html(e.name))}})},_renderSort:function(c){if(c.key==undefined){return}this.options.sortElements.toggleClass("sort-ascending sort-descending",false);var b=_.find(this.options.sortElements,function(d){return a(d).is("[name='"+c.key+"']")});a(b).addClass("sort-"+c.direction)},_renderFilters:function(b){this.filters.setFilterValues(b)}})}(jQuery));ResourceTableView={};ResourceTableView.Filters=function(){};ResourceTableView.Filters=function(b,c){var a=this;a.element=b;a.filters={};_.each(b,function(e){var e=$(e);var d=e.attr("name");if(e.is("select")){a.filters[d]=new ResourceTableView.SelectFilter(d,e,c)}})};ResourceTableView.Filters.prototype.setFilterValues=function(b){var a=this;_.each(b,function(d,c){a.filters[c].setValue(d)})};ResourceTableView.Filters.prototype.currentState=function(){var a=this;var b={};console.log("here");_.each(a.filters,function(d,c){console.log(d,c);b[c]=d.getValue()});console.log(b);return b};ResourceTableView.SelectFilter=function(b,a,c){this.element=a;this.resourceTable=c;a.change(function(){var d={};d[b]=a.val();c.filter(d)})};ResourceTableView.SelectFilter.prototype.setValue=function(a){this.element.val(a)};ResourceTableView.SelectFilter.prototype.getValue=function(){return this.element.val()}