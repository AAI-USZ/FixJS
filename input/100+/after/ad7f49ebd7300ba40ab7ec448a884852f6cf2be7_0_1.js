function m(a,b){for(var c=a.length-1;c>=0;c--)a[c]===b&&a.splice(c,1)}function q(a,b,c,d,f){if(d.needsUpdate){d.program&&D.deallocateMaterial(d);D.initMaterial(d,b,c,f);d.needsUpdate=false}if(d.morphTargets&&!f.__webglMorphTargetInfluences)f.__webglMorphTargetInfluences=new Float32Array(D.maxMorphTargets);var e=false,g=d.program,h=g.uniforms,j=d.uniforms;if(g!==N){k.useProgram(g);N=g;e=true}if(d.id!==U){U=d.id;e=true}if(e||a!==ca){k.uniformMatrix4fv(h.projectionMatrix,
false,a._projectionMatrixArray);a!==ca&&(ca=a)}if(e){if(c&&d.fog){j.fogColor.value=c.color;if(c instanceof THREE.Fog){j.fogNear.value=c.near;j.fogFar.value=c.far}else if(c instanceof THREE.FogExp2)j.fogDensity.value=c.density}if(d instanceof THREE.MeshPhongMaterial||d instanceof THREE.MeshLambertMaterial||d.lights){if(Ra){for(var i,l=0,m=0,o=0,n,p,r,q=ra,s=q.directional.colors,w=q.directional.positions,t=q.point.colors,u=q.point.positions,x=q.point.distances,F=q.spot.colors,B=q.spot.positions,H=q.spot.distances,
I=q.spot.directions,X=q.spot.angles,E=q.spot.exponents,J=0,O=0,T=0,L=r=0,c=L=0,e=b.length;c<e;c++){i=b[c];if(!i.onlyShadow&&i.visible){n=i.color;p=i.intensity;r=i.distance;if(i instanceof THREE.AmbientLight)if(D.gammaInput){l=l+n.r*n.r;m=m+n.g*n.g;o=o+n.b*n.b}else{l=l+n.r;m=m+n.g;o=o+n.b}else if(i instanceof THREE.DirectionalLight){r=J*3;if(D.gammaInput){s[r]=n.r*n.r*p*p;s[r+1]=n.g*n.g*p*p;s[r+2]=n.b*n.b*p*p}else{s[r]=n.r*p;s[r+1]=n.g*p;s[r+2]=n.b*p}Fa.copy(i.matrixWorld.getPosition());Fa.subSelf(i.target.matrixWorld.getPosition());
Fa.normalize();w[r]=Fa.x;w[r+1]=Fa.y;w[r+2]=Fa.z;J=J+1}else if(i instanceof THREE.PointLight){L=O*3;if(D.gammaInput){t[L]=n.r*n.r*p*p;t[L+1]=n.g*n.g*p*p;t[L+2]=n.b*n.b*p*p}else{t[L]=n.r*p;t[L+1]=n.g*p;t[L+2]=n.b*p}n=i.matrixWorld.getPosition();u[L]=n.x;u[L+1]=n.y;u[L+2]=n.z;x[O]=r;O=O+1}else if(i instanceof THREE.SpotLight){L=T*3;if(D.gammaInput){F[L]=n.r*n.r*p*p;F[L+1]=n.g*n.g*p*p;F[L+2]=n.b*n.b*p*p}else{F[L]=n.r*p;F[L+1]=n.g*p;F[L+2]=n.b*p}n=i.matrixWorld.getPosition();B[L]=n.x;B[L+1]=n.y;B[L+2]=
n.z;H[T]=r;Fa.copy(n);Fa.subSelf(i.target.matrixWorld.getPosition());Fa.normalize();I[L]=Fa.x;I[L+1]=Fa.y;I[L+2]=Fa.z;X[T]=Math.cos(i.angle);E[T]=i.exponent;T=T+1}}}c=J*3;for(e=s.length;c<e;c++)s[c]=0;c=O*3;for(e=t.length;c<e;c++)t[c]=0;c=T*3;for(e=F.length;c<e;c++)F[c]=0;q.directional.length=J;q.point.length=O;q.spot.length=T;q.ambient[0]=l;q.ambient[1]=m;q.ambient[2]=o;Ra=false}c=ra;j.ambientLightColor.value=c.ambient;j.directionalLightColor.value=c.directional.colors;j.directionalLightDirection.value=
c.directional.positions;j.pointLightColor.value=c.point.colors;j.pointLightPosition.value=c.point.positions;j.pointLightDistance.value=c.point.distances;j.spotLightColor.value=c.spot.colors;j.spotLightPosition.value=c.spot.positions;j.spotLightDistance.value=c.spot.distances;j.spotLightDirection.value=c.spot.directions;j.spotLightAngle.value=c.spot.angles;j.spotLightExponent.value=c.spot.exponents}if(d instanceof THREE.MeshBasicMaterial||d instanceof THREE.MeshLambertMaterial||d instanceof THREE.MeshPhongMaterial){j.opacity.value=
d.opacity;D.gammaInput?j.diffuse.value.copyGammaToLinear(d.color):j.diffuse.value=d.color;(j.map.texture=d.map)&&j.offsetRepeat.value.set(d.map.offset.x,d.map.offset.y,d.map.repeat.x,d.map.repeat.y);j.lightMap.texture=d.lightMap;j.envMap.texture=d.envMap;j.flipEnvMap.value=d.envMap instanceof THREE.WebGLRenderTargetCube?1:-1;j.reflectivity.value=d.reflectivity;j.refractionRatio.value=d.refractionRatio;j.combine.value=d.combine;j.useRefract.value=d.envMap&&d.envMap.mapping instanceof THREE.CubeRefractionMapping}if(d instanceof
THREE.LineBasicMaterial){j.diffuse.value=d.color;j.opacity.value=d.opacity}else if(d instanceof THREE.ParticleBasicMaterial){j.psColor.value=d.color;j.opacity.value=d.opacity;j.size.value=d.size;j.scale.value=z.height/2;j.map.texture=d.map}else if(d instanceof THREE.MeshPhongMaterial){j.shininess.value=d.shininess;if(D.gammaInput){j.ambient.value.copyGammaToLinear(d.ambient);j.emissive.value.copyGammaToLinear(d.emissive);j.specular.value.copyGammaToLinear(d.specular)}else{j.ambient.value=d.ambient;
j.emissive.value=d.emissive;j.specular.value=d.specular}d.wrapAround&&j.wrapRGB.value.copy(d.wrapRGB)}else if(d instanceof THREE.MeshLambertMaterial){if(D.gammaInput){j.ambient.value.copyGammaToLinear(d.ambient);j.emissive.value.copyGammaToLinear(d.emissive)}else{j.ambient.value=d.ambient;j.emissive.value=d.emissive}d.wrapAround&&j.wrapRGB.value.copy(d.wrapRGB)}else if(d instanceof THREE.MeshDepthMaterial){j.mNear.value=a.near;j.mFar.value=a.far;j.opacity.value=d.opacity}else if(d instanceof THREE.MeshNormalMaterial)j.opacity.value=
d.opacity;if(f.receiveShadow&&!d._shadowPass&&j.shadowMatrix){e=c=0;for(i=b.length;e<i;e++){l=b[e];if(l.castShadow&&(l instanceof THREE.SpotLight||l instanceof THREE.DirectionalLight&&!l.shadowCascade)){j.shadowMap.texture[c]=l.shadowMap;j.shadowMapSize.value[c]=l.shadowMapSize;j.shadowMatrix.value[c]=l.shadowMatrix;j.shadowDarkness.value[c]=l.shadowDarkness;j.shadowBias.value[c]=l.shadowBias;c++}}}b=d.uniformsList;j=0;for(c=b.length;j<c;j++)if(l=g.uniforms[b[j][1]]){e=b[j][0];m=e.type;i=e.value;
if(m==="i")k.uniform1i(l,i);else if(m==="f")k.uniform1f(l,i);else if(m==="v2")k.uniform2f(l,i.x,i.y);else if(m==="v3")k.uniform3f(l,i.x,i.y,i.z);else if(m==="v4")k.uniform4f(l,i.x,i.y,i.z,i.w);else if(m==="c")k.uniform3f(l,i.r,i.g,i.b);else if(m==="fv1")k.uniform1fv(l,i);else if(m==="fv")k.uniform3fv(l,i);else if(m==="v2v"){if(e._array===void 0)e._array=new Float32Array(2*i.length);m=0;for(o=i.length;m<o;m++){q=m*2;e._array[q]=i[m].x;e._array[q+1]=i[m].y}k.uniform2fv(l,e._array)}else if(m==="v3v"){if(e._array===
void 0)e._array=new Float32Array(3*i.length);m=0;for(o=i.length;m<o;m++){q=m*3;e._array[q]=i[m].x;e._array[q+1]=i[m].y;e._array[q+2]=i[m].z}k.uniform3fv(l,e._array)}else if(m==="v4v"){if(e._array===void 0)e._array=new Float32Array(4*i.length);m=0;for(o=i.length;m<o;m++){q=m*4;e._array[q]=i[m].x;e._array[q+1]=i[m].y;e._array[q+2]=i[m].z;e._array[q+3]=i[m].w}k.uniform4fv(l,e._array)}else if(m==="m4"){if(e._array===void 0)e._array=new Float32Array(16);i.flattenToArray(e._array);k.uniformMatrix4fv(l,
false,e._array)}else if(m==="m4v"){if(e._array===void 0)e._array=new Float32Array(16*i.length);m=0;for(o=i.length;m<o;m++)i[m].flattenToArrayOffset(e._array,m*16);k.uniformMatrix4fv(l,false,e._array)}else if(m==="t"){k.uniform1i(l,i);if(l=e.texture)if(l.image instanceof Array&&l.image.length===6){e=l;if(e.image.length===6)if(e.needsUpdate){if(!e.image.__webglTextureCube)e.image.__webglTextureCube=k.createTexture();k.activeTexture(k.TEXTURE0+i);k.bindTexture(k.TEXTURE_CUBE_MAP,e.image.__webglTextureCube);
k.pixelStorei(k.UNPACK_FLIP_Y_WEBGL,e.flipY);i=[];for(l=0;l<6;l++){m=i;o=l;if(D.autoScaleCubemaps){q=e.image[l];w=Va;if(!(q.width<=w&&q.height<=w)){t=Math.max(q.width,q.height);s=Math.floor(q.width*w/t);w=Math.floor(q.height*w/t);t=document.createElement("canvas");t.width=s;t.height=w;t.getContext("2d").drawImage(q,0,0,q.width,q.height,0,0,s,w);q=t}}else q=e.image[l];m[o]=q}l=i[0];m=(l.width&l.width-1)===0&&(l.height&l.height-1)===0;o=C(e.format);q=C(e.type);v(k.TEXTURE_CUBE_MAP,e,m);for(l=0;l<6;l++)k.texImage2D(k.TEXTURE_CUBE_MAP_POSITIVE_X+
l,0,o,o,q,i[l]);e.generateMipmaps&&m&&k.generateMipmap(k.TEXTURE_CUBE_MAP);e.needsUpdate=false;if(e.onUpdate)e.onUpdate()}else{k.activeTexture(k.TEXTURE0+i);k.bindTexture(k.TEXTURE_CUBE_MAP,e.image.__webglTextureCube)}}else if(l instanceof THREE.WebGLRenderTargetCube){e=l;k.activeTexture(k.TEXTURE0+i);k.bindTexture(k.TEXTURE_CUBE_MAP,e.__webglTexture)}else D.setTexture(l,i)}else if(m==="tv"){if(e._array===void 0){e._array=[];m=0;for(o=e.texture.length;m<o;m++)e._array[m]=i+m}k.uniform1iv(l,e._array);
m=0;for(o=e.texture.length;m<o;m++)(l=e.texture[m])&&D.setTexture(l,e._array[m])}}if((d instanceof THREE.ShaderMaterial||d instanceof THREE.MeshPhongMaterial||d.envMap)&&h.cameraPosition!==null){b=a.matrixWorld.getPosition();k.uniform3f(h.cameraPosition,b.x,b.y,b.z)}(d instanceof THREE.MeshPhongMaterial||d instanceof THREE.MeshLambertMaterial||d instanceof THREE.ShaderMaterial||d.skinning)&&h.viewMatrix!==null&&k.uniformMatrix4fv(h.viewMatrix,false,a._viewMatrixArray)}d.skinning&&h.boneGlobalMatrices!==
null&&k.uniformMatrix4fv(h.boneGlobalMatrices,false,f.boneMatrices);k.uniformMatrix4fv(h.modelViewMatrix,false,f._modelViewMatrix.elements);h.normalMatrix&&k.uniformMatrix3fv(h.normalMatrix,false,f._normalMatrix.elements);h.objectMatrix!==null&&k.uniformMatrix4fv(h.objectMatrix,false,f.matrixWorld.elements);return g}function s(a,b){a._modelViewMatrix.multiply(b.matrixWorldInverse,a.matrixWorld);a._normalMatrix.getInverse(a._modelViewMatrix);a._normalMatrix.transpose()}