function(e){var t;for(t in e)e.hasOwnProperty(t)&&(e[t].match(/png$|jpg$|jpeg$|gif$|bmp$/i)?this.resources[t]=new Image:this.resources[t]=new a2d.Audio,this.resources[t].onload=this.progress,this.resources[t].onreadystatechange=function(){this.progress()},this.resources[t].src=e[t]);this.progress()},progress:function(){var e,t=0,n=0;if(!a2d.loaded){for(e in a2d.resources)a2d.resources.hasOwnProperty(e)&&((a2d.resources[e].width&&a2d.resources[e].width>0||a2d.resources[e].audioLoaded)&&n++,t++);n==t?(a2d.loaded=!0,a2d.fireEvent("load")):a2d.fireEvent("progress",{loaded:n,total:t})}},get canvas(){if(!this.a2dCanvas){console.log("acquire canvas"),this.a2dCanvas=document.getElementsByTagName("canvas")[0];if(!this.a2dCanvas){this.a2dCanvas=document.createElement("canvas"),document.body.appendChild(this.a2dCanvas);var e=new a2d.Dimension(window.innerWidth,window.innerHeight);this.a2dCanvas.setAttribute("width",e.Width),this.a2dCanvas.setAttribute("height",e.Height)}a2d.mousePosition=new a2d.Position(0,0),this.a2dCanvas.addEventListener("mousemove",function(e){var t=e.clientX+a2d.canvas.offsetLeft,n=e.clientY+a2d.canvas.offsetTop;a2d.mousePosition=new a2d.Position(t,n)}),this.a2dCanvas.addEventListener("mousedown",function(e){var t=a2d.root.findNodeAt(a2d.mousePosition);t&&t.fireEvent.call(t,"mousedown")}),this.a2dCanvas.addEventListener("mouseup",function(e){var t=a2d.root.findNodeAt(a2d.mousePosition);t&&(t.fireEvent.call(t,"mouseup"),t.fireEvent.call(t,"click"))}),this.context=this.a2dCanvas.getContext("2d")}return this.a2dCanvas},set canvas(e){this.a2dCanvas=document.getElementById(e)},get dimension(){return new a2d.Dimension(this.canvas.width,this.canvas.height)},set dimension(e){this.canvas.setAttribute("width",e.Width),this.canvas.setAttribute("height",e.Height)},get root(){return this.a2dRoot||(console.log("acquire root node"),this.a2dRoot=new a2d.Node,this.frame()),this.a2dRoot},set root(e){this.a2dRoot=e},update:function(){setTimeout(a2d.update,a2d.logicInterval)},frame:function(){a2d.forceClear&&(a2d.canvas.width=a2d.canvas.width),a2d.requestFrame(a2d.frame),a2d.root.draw(),a2d.fireEvent("draw")},requestFrame:function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}().bind(window),key:{BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,ESC:27,SPACE:32,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,ARROW_LEFT:37,ARROW_UP:38,ARROW_RIGHT:39,ARROW_DOWN:40,INSERT:45,DELETE:46,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145}};a2d.Vector=function(e,t){"use strict";this.X=e,this.Y=t,this.clone=function(){return new a2d.Vector(this.X,this.Y)}},a2d.Position=function(e,t){"use strict";a2d.Vector.apply(this,[e,t]),this.scale=function(e){e.Width?(this.X=Math.floor(this.X*e.Width),this.Y=Math.floor(this.Y*e.Height)):(this.X=Math.floor(this.X*e.X),this.Y=Math.floor(this.Y*e.Y))},this.add=function(e){this.X+=e.X,this.Y+=e.Y},this.substract=function(e){this.subtract(e)},this.subtract=function(e){this.X-=e.X,this.Y-=e.Y},this.divide=function(e){this.X=Math.floor(this.X/e.X),this.Y=Math.floor(this.Y/e.Y)},this.isInside=function(e){return this.X>e.topLeft.X&&this.X<e.bottomRight.X&&this.Y>e.topLeft.Y&&this.Y<e.bottomRight.Y?!0:!1},this.is=function(e){return this.X===e.X&&this.Y===e.Y},this.not=function(e){return this.X!==e.X||this.Y!==e.Y},this.distanceTo=function(e){var t=Math.abs(this.X-e.X),n=Math.abs(this.Y-e.Y);return Math.sqrt(Math.pow(t,2)+Math.pow(n,2))},this.clone=function(){return new a2d.Position(this.X,this.Y)}},a2d.Rectangle=function(e,t){"use strict";this.topLeft=e,this.bottomRight=t,this.topRight=new a2d.Position(t.X,e.Y),this.bottomLeft=new a2d.Position(e.X,t.Y),this.add=function(e){this.topLeft.add(e),this.topRight.add(e),this.bottomLeft.add(e),this.bottomRight.add(e)},this.overlaps=function(e){return e.topLeft.isInside(this)||e.bottomRight.isInside(this)||e.topRight.isInside(this)||e.bottomLeft.isInside(this)}},a2d.Dimension=function(e,t){"use strict";this.Width=e,this.Height=t,this.scale=function(e){this.Width=Math.floor(this.Width*e.X),this.Height=Math.floor(this.Height*e.Y)}},a2d.Collection=function(){this.length=0,this.push=function(e){typeof e=="object"&&(e.parent=this),this[this.length]=e,this.length+=1},this.pop=function(){return this.length-=1,this[this.length]},this.remove=function(e){var t=this[e],n;delete this[e];for(n=e+1;n<this.length;n++)this[n-1]=this[n];return this.length-=1,t},this.shift=function(){return this.remove(0)},this.unshift=function(e){var t;for(t=0;t<this.length;t++)this[t+1]=this[t];return this[0]=e,this.length+=1,this.length},this.indexOf=function(e){var t;for(t=0;t<this.length;t++)if(this[t]==e)return t;return-1},this.append=function(e){var t;for(t=0;t<e.length;t++)this.push(e[t])},this.sort=function(e){for(var t=1;t<this.length;t++)if(e(this[t],this[t-1])<0){var n=this[t];this[t]=this[t-1],this[t-1]=n}},this.foreach=function(e){for(var t=0;t<this.length;t++)e(this[t])}},a2d.Events=function(){"use strict";var e=this,t={};this.hasEvent=function(e){return t[e]?!0:!1},this.addEventListener=function(e,n){t[e]||(t[e]=[]),t[e].push(n)},this.emit=function(e,t){this.fireEvent(e,t)},this.on=function(e,t){this.addEventListener(e,t)},this.fireEvent=function(n,r){var i,s="on"+n.charAt(0).toUpperCase()+n.slice(1);if(t[n])for(i=0;i<t[n].length;i++)t[n][i](r);e[s]&&e[s](r)},this.removeEventListener=function(e,n){var r=-1;t[e]&&(r=t[e].indexOf(n),r!=-1&&t[e].splice(r,1))}},a2d.Events.apply(a2d),a2d.Audio=function(){var e=this;this.channels=[],this.channels.length=8,this.stop=function(){for(var e=0;e<this.channels.length;e++)this.channels[e].paused||(this.channels[e].pause(),this.channels[e].currentTime=0)},this.play=function(e){var t=e||!1;if(!a2d.mute){var n=!1;for(var r=0;r<this.channels.length;r++)if(this.channels[r].currentTime==0||this.channels[r].ended){this.channels[r].loop=t,this.channels[r].play(),n=!0;break}n||(this.channels[0].pause(),this.channels[0].currentTime=0,this.channels[0].play())}},this.__defineSetter__("src",function(t){for(var n=0;n<this.channels.length;n++)this.channels[n]=new Audio,this.channels[n].src=t,this.channels[n].addEventListener("canplaythrough",function(){e.audioLoaded=!0,e.onload&&e.onload.call()})}),this.onload=function(){alert("load!")}},a2d.Node=function(){"use strict";a2d.Collection.apply(this),a2d.Events.apply(this);var e=this;this.absolute=!1,this.scrollLock=!1,this.opacity=1,this.position=new a2d.Position(0,0),this.offset=new a2d.Position(0,0),this.set=function(e){for(var t in e)this[t]=e[t]},this.__defineGetter__("absolutePosition",function(){if(this.parent){var e=this.parent.absolutePosition.clone();return e.add(this.position),e}return this.position}),this.__defineSetter__("absolutePosition",function(e){if(this.parent){var t=this.parent.absolutePosition.clone();t.subtract(e),this.position=t}else this.position=e}),this.__defineGetter__("absoluteOffset",function(){if(this.parent){var e=this.parent.absoluteOffset.clone();return e.add(this.offset),e}return this.offset}),this.__defineSetter__("absoluteOffset",function(e){if(this.parent){var t=this.parent.absoluteOffset.clone();t.subtract(e),this.offset=t}else this.offset=e}),this.boundingBox=new a2d.Rectangle(new a2d.Position(0,0),new a2d.Position(0,0)),this.hover=!1,this.scale=new a2d.Vector(1,1),this.visible=!0,this.name="Node",this.findNodeAt=function(t){var n=new a2d.Position(t.X,t.Y);this.offset&&!this.absolute&&n.add(this.offset);for(var r=e.length-1;r>=0;r--){var i=e[r].findNodeAt(n);if(i)return i}return n.isInside(e.boundingBox)&&(e.hasEvent("click")||e.hasEvent("mousedown"))?e:null},this.draw=function(){var e,t=a2d.mousePosition?new a2d.Position(a2d.mousePosition.X,a2d.mousePosition.Y):new a2d.Position(0,0);t&&t.isInside(this.boundingBox)?this.hover||(this.fireEvent("mouseover"),this.fireEvent("hover"),this.hover=!0):this.hover&&(this.fireEvent("mouseout"),this.hover=!1);if(this.visible)for(e=0;e<this.length;e++)this[e].draw();this.fireEvent("draw")}},a2d.Tile=function(e,t){"use strict";a2d.Node.apply(this);var n=0,r=new a2d.Position(0,0),i=!1,s=this,o=this.draw.bind(this),u=function(){e.width<e.height?s.tileSize=new a2d.Dimension(e.width,e.width):s.tileSize=new a2d.Dimension(e.height,e.height)},a=function(){var e=s.absolutePosition.X+s.offset.X,t=s.absolutePosition.Y+s.offset.Y;s.boundingBox.topLeft.X=e-s.tileSize.Width/2,s.boundingBox.topLeft.Y=t-s.tileSize.Height/2,s.boundingBox.bottomRight.X=e+s.tileSize.Width/2,s.boundingBox.bottomRight.Y=t+s.tileSize.Height/2,s.boundingBox.topRight.X=e+s.tileSize.Width/2,s.boundingBox.topRight.Y=t-s.tileSize.Height/2,s.boundingBox.bottomLeft.X=e-s.tileSize.Width/2,s.boundingBox.bottomLeft.Y=t+s.tileSize.Height/2};this.image=e,this.tile=0,this.loop=!1,this.range=new a2d.Vector(0,0),this.fps=8,this.angle=0,this.tileSize=new a2d.Dimension(0,0),this.position=new a2d.Position(0,0),this.opacity=1,this.scrollLock=!1,this.setTile=function(e){this.tile=e,e!==-1&&(r.Y=parseInt(e/(this.image.width/this.tileSize.Height),10)*this.tileSize.Height,r.X=parseInt(e%(this.image.width/this.tileSize.Height),10)*this.tileSize.Width)},this.__defineGetter__("animated",function(){return n!==0}),this.frameLoop=function(e,t){this.range=e,this.loop=t,i=!0,n=(new Date).getTime()},this.stop=function(e){this.setTile(e||0),n=0},this.draw=function(e,t){var u=e||a2d.canvas,f=u.getContext("2d");a();if(n!==0){var l=(new Date).getTime()-n,c=this.range.Y-this.range.X,h=c/this.fps*1e3;if(l>h)this.loop?(n=(new Date).getTime(),i=!i):(n=0,this.fireEvent("animationend"));else{var p=1e3/this.fps;i?this.setTile(Math.floor(l/p)+this.range.X):this.setTile(this.range.Y-Math.floor(l/p))}}if(this.visible){var d=this.absolutePosition.clone();s.absoluteOffset&&d.add(s.absoluteOffset),t&&d.scale(t),f.save(),f.translate(d.X,d.Y),f.rotate(this.angle),t?f.scale(t.X,t.Y):f.scale(this.scale.X,this.scale.Y),f.globalAlpha=this.opacity,f.drawImage(this.image,r.X,r.Y,this.tileSize.Width,this.tileSize.Height,-(this.tileSize.Width/2),-(this.tileSize.Height/2),this.tileSize.Width,this.tileSize.Height),f.restore()}o()},u(),t&&this.set(t),this.setTile(this.tile)},a2d.TileGrid=function(e){"use strict";a2d.Node.apply(this);var t=this,n=this.draw.bind(this),r=this.fireEvent.bind(this),i=[],s=new a2d.Dimension(0,0),o=new a2d.Dimension(0,0),u=null,a=document.createElement("canvas");a.width=a2d.dimension.Width,a.height=a2d.dimension.Height,this.boundingBox=new a2d.Rectangle(new a2d.Position(0,0),new a2d.Position(a2d.dimension.Width,a2d.dimension.Height)),this.offset=new a2d.Position(0,0),this.setData=function(e){var t,n,r=0;o=new a2d.Dimension(e.gridSize[0],e.gridSize[1]),s=new a2d.Dimension(e.tileSize[0],e.tileSize[1]);for(t=0;t<o.Width;t++){i[t]||(i[t]=[]);for(n=0;n<o.Height;n++)i[t][n]=new a2d.Tile(a2d.resources[e.tileSet]),i[t][n].tileSize=s,i[t][n].setTile(e.tiles[r]),i[t][n].parent=this,e.tiles[r]!==-1&&(i[t][n].edit=!0),i[t][n].position=new a2d.Position(t*s.Width+s.Width/2,n*s.Height+s.Height/2),r++}},this.fireEvent=function(e,n){e==="click"&&(n||(n={}),n.tile=t.getTile(a2d.mousePosition),n.tileType=i[n.tile.X][n.tile.Y].tile),r(e,n)},this.getWidth=function(){return o.Width},this.getHeight=function(){return o.Height},this.getTile=function(e){return new a2d.Position(Math.floor(e.X/s.Width),Math.floor(e.Y/s.Height))},this.toPix=function(e){return new a2d.Position(e.X*s.Width+parseInt(s.Width/2,10),e.Y*s.Height+parseInt(s.Height/2,10))},this.getTiles=function(){return i},this.draw=function(){var e,t,r,f;if(this.visible){if(!u||u.not(this.offset)){a2d.forceClear&&(a.width=a.width),r=this.getTile(this.offset),r.add(new a2d.Position(1,1)),r.scale(new a2d.Position(-1,-1)),f=new a2d.Position(r.X+Math.floor(a2d.dimension.Width/s.Width)+1+1,r.Y+Math.floor(a2d.dimension.Height/s.Height)+1+1),f.X>o.Width&&(f.X=o.Width),f.Y>o.Height&&(f.Y=o.Height),r.X<0&&(r.X=0),r.Y<0&&(r.Y=0);for(e=r.X;e<f.X;e++)for(t=r.Y;t<f.Y;t++)i[e][t].tile!==-1&&i[e][t].draw(a);u=this.offset.clone()}a2d.context.drawImage(a,0,0)}n()},this.visibleArea=function(){return{from:this.getTile(a2d.offset),to:new a2d.Position(fromTile.X+Math.floor(a2d.dimension.Width/s.Width)+1+1,fromTile.Y+Math.floor(a2d.dimension.Height/s.Height)+1+1)}},this.getMini=function(e){var t=document.createElement("canvas"),n=t.getContext("2d"),r=s.Width*o.Width,u=s.Height*o.Height,a=new a2d.Vector(e.Width/r,e.Height/u);t.width=e.Width,t.height=e.Height;for(var f=0;f<o.Width;f++)for(var l=0;l<o.Height;l++)i[f][l].draw(t,a);return new a2d.Tile(t)},e&&this.setData(e)},a2d.IsoGrid=function(e){"use strict";a2d.Node.apply(this);var t=this,n=this.draw.bind(this),r=this.fireEvent.bind(this),i=[],s=new a2d.Dimension(0,0),o=new a2d.Dimension(0,0),u=null,a=document.createElement("canvas");a.width=a2d.dimension.Width,a.height=a2d.dimension.Height,this.boundingBox=new a2d.Rectangle(new a2d.Position(0,0),new a2d.Position(a2d.dimension.Width,a2d.dimension.Height)),this.scrollLock=!0,this.offset=new a2d.Position(0,0),this.setData=function(e){var t=0,n=0,r=0;o=new a2d.Dimension(e.gridSize[0],e.gridSize[1]),s=new a2d.Dimension(e.tileSize[0],e.tileSize[1]);for(n=0;n<o.Height;n++)for(t=0;t<o.Width;t++)i[t]||(i[t]=[]),i[t][n]=new a2d.Tile(a2d.resources[e.tileSet]),i[t][n].tileSize=s,i[t][n].setTile(e.tiles[r]),i[t][n].parent=this,e.tiles[r]!==-1&&(i[t][n].edit=!0),i[t][n].position=new a2d.Position(t*s.Width/2-n*(s.Width/2),n*s.Height/2+t*s.Height/2),r++},this.getTileSize=function(){return s},this.fireEvent=function(e,n){e==="click"&&(n||(n={}),n.tile=t.getTile(a2d.mousePosition),n.tileType=i[n.tile.X][n.tile.Y].tile),r(e,n)},this.getWidth=function(){return o.Width},this.getHeight=function(){return o.Height},this.getTile=function(e){var t=e.clone();return t.X=t.X/s.Width,t.Y=t.Y/s.Height,t=a2d.ScreenToGame(t),game.chrome?t.Y-=.5:t.X-=.5,t=t.floor(),t},this.toPix=function(e){return new a2d.Position(e.X*s.Width+parseInt(s.Width/2,10),e.Y*s.Height+parseInt(s.Height/2,10))},this.getTiles=function(){return i},this.draw=function(){var e,r,s,f;if(this.visible){a.width=a.width,s=new a2d.Position(0,0),f=new a2d.Position(o.Width,o.Height),f.X>o.Width&&(f.X=o.Width),f.Y>o.Height&&(f.Y=o.Height),s.X<0&&(s.X=0),s.Y<0&&(s.Y=0);for(r=s.Y;r<f.Y;r++)for(e=s.X;e<f.X;e++)i[e][r].tile!==-1&&i[e][r].draw(a);u=t.offset.clone(),a2d.context.drawImage(a,0,0)}n()},this.visibleArea=function(){return{from:this.getTile(t.offset),to:new a2d.Position(fromTile.X+Math.floor(a2d.dimension.Width/s.Width)+1+1,fromTile.Y+Math.floor(a2d.dimension.Height/s.Height)+1+1)}},this.getMini=function(e){var t=document.createElement("canvas"),n=t.getContext("2d"),r=s.Width*o.Width,u=s.Height*o.Height,a=new a2d.Vector(e.Width/r,e.Height/u);t.width=e.Width,t.height=e.Height;for(var f=0;f<o.Width;f++)for(var l=0;l<o.Height;l++)i[f][l].draw(t,a);return new a2d.Tile(t)},e&&this.setData(e)},a2d.Particles=function(e){a2d.Node.apply(this);var t=this,n=e.lifeTime||1e3,r=e.speed||200,i=e.frequency||300,s=e.rotateSpeed||.01,o=e.startScale||1,u=e.endScale||0,a=e.image,f=0,l=0,c=this.draw.bind(this);t.position=e.position||new a2d.Position(0,0),this.draw=function(){var e=(new Date).getTime();f===0&&(f=e),l===0&&(l=e);var h=e-f,p=Math.floor(h/(1e3/i));!(p>0);for(var d=0;d<p;d++){var v=new a2d.Tile(a),m=Math.random()*6.28;v.birth=(new Date).getTime(),v.position=new a2d.Position(t.position.X,t.position.Y),t.relative&&v.position.add(this.parent.position),v.dir=new a2d.Vector(Math.cos(m),Math.sin(m)),f=v.birth,t.push(v)}for(var d=t.length-1;d>=0;--d){var g=e-t[d].birth,y=o-u;t[d].opacity=1-g/n,t[d].angle=g/n*360*s,t[d].scale.X=o-g/n*y,t[d].scale.Y=o-g/n*y,t[d].position.X+=t[d].dir.X*r*((e-l)/1e3),t[d].position.Y+=t[d].dir.Y*r*((e-l)/1e3),g>n&&t.remove(d)}l=e,c()}},a2d.Label=function(e,t){"use strict";a2d.Node.apply(this);var n=this,r=this.draw.bind(this),i="",s="21px Arial",o=new a2d.Dimension(0,0),u=function(){var e=n.position.X,t=n.position.Y;e<0&&(e+=a2d.dimension.Width),t<0&&(t+=a2d.dimension.Height),n.boundingBox.topLeft.X=e-o.Width/2,n.boundingBox.topLeft.Y=t-o.Height/2,n.boundingBox.bottomRight.X=e+o.Width/2,n.boundingBox.bottomRight.Y=t+o.Height/2,n.boundingBox.topRight.X=e+o.Width/2,n.boundingBox.topRight.Y=t-o.Height/2,n.boundingBox.bottomLeft.X=e-o.Width/2,n.boundingBox.bottomLeft.Y=t+o.Height/2};this.__defineSetter__("text",function(e){i=e,a2d.context.font=n.font,o.Width=a2d.context.measureText(i).width,o.Height=a2d.context.measureText("m").width}),this.__defineGetter__("text",function(){return i}),this.__defineSetter__("font",function(e){s=e,a2d.context.font=s,o.Width=a2d.context.measureText(i).width,o.Height=a2d.context.measureText("m").width}),this.__defineGetter__("font",function(){return s}),this.text=e,this.border={width:0,color:"black"},this.color="#000",this.textAlign="center",this.draw=function(){u();var e=n.position.clone();n.scrollLock&&e.X<0&&(e.X+=a2d.dimension.Width),n.scrollLock&&e.Y<0&&(e.Y+=a2d.dimension.Height),e.add(this.offset),this.relative&&e.add(this.parent.position),a2d.context.globalAlpha=this.opacity,a2d.context.textAlign=this.textAlign,a2d.context.textBaseline="middle",a2d.context.font=n.font,a2d.context.fillStyle=n.color,this.border.width!==0&&(a2d.context.lineWidth=this.border.width,a2d.context.strokeStyle=this.border.color,a2d.context.strokeText(this.text,e.X,e.Y)),a2d.context.fillText(this.text,e.X,e.Y),r()}