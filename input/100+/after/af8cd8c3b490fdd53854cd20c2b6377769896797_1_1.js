function EventEmitter(){var l={},a=this;function j(v,z){var q=l[v]||false;if(q===false){l[v]=[z];return a}l[v].push(z);return a}function g(q){l[q]=[];return a}function e(){var q=Array.prototype.slice.call(arguments);var A=q.shift();var z=l[A]||false;if(z===false){return a}for(var v in z){if(z.hasOwnProperty(v)){z[v].apply({},q)}}return a}function m(q){return l[q]||[]}this.addListener=j;this.removeListeners=g;this.emit=e;this.listeners=m}wsc_html_ui='<nav class="tabs"><ul id="chattabs"></ul>        <ul id="tabnav">            <li><a href="#left" class="button">&laquo;</a></li>            <li><a href="#right" class="button">&raquo;</a></li>        </ul>        </nav>        <div class="chatbook"></div>';wsc_html_control='<div class="chatcontrol">            <form class="msg">                <input type="text" class="msg" />                <input type="submit" value="Send" class="sendmsg" />            </form>        </div>';var wsc_html_chattab='<li id="{selector}-tab"><a href="#{selector}">{ns}</a></li>';var wsc_html_channel='<div class="chatwindow" id="{selector}-window">                    <header>                        <div class="title"></div>                    </header>                    <div class="chatlog" id="{selector}-log">                        <header>                            <div class="topic"></div>                        </header>                        <div class="logwrap"></div>                    </div>                    <div class="chatusers" id="{selector}-users">                </div>            </div>';var wsc_html_cheader='<div class="{head}">{content}</div>';var wsc_html_logmsg='<span class="message">{message}</span>';var wsc_html_logitem='<p class="logmsg"><span class="ts">{ts}</span> {message}</p>';var wsc_html_servermsg='<span class="servermsg">** {message} * <em>{info}</em></span>';var wsc_html_usermsg='<strong class="user">&lt;{user}&gt;</strong> {message}';Function.prototype.bind=function(e){var a=this;return function(){return a.apply(e,arguments)}};function scope_methods(e,a){for(cbn in a){e[cbn]=a[cbn].bind(e)}}Function.prototype.scope_methods=function(e,a){for(cbn in a){e[cbn]=a[cbn].bind(e)}};function bind(e,a){return a.bind(e)}function $_GET(g,e){e=e||window.location.search;var a=new RegExp("&"+g+"(?:=([^&]*))?(?=&|$)","i");e=e.replace(/^\?/,"&").match(a);if(e){return typeof e[1]!="undefined"?decodeURIComponent(e[1]):""}}function UnixTimestamp(a){ret=new Date(a*1000);return ret}var Months=["January","February","March","April","May","June","July","August","September","October","November","December"];function PosEnd(a){return a=="1"?"st":(a=="2"?"nd":(a=="3"?"rd":"th"))}function DateStamp(a){a=UnixTimestamp(a);date=String(a.getDate());month=a.getMonth();df=date[date.length-1];return date+PosEnd(df)+" of "+Months[month]+", "+a.getFullYear()}function caseInsensitiveSort(g,e){x=String(g).toLowerCase();y=String(e).toLowerCase();return((x>y)?1:(x==y?0:-1))}function CanCreateWebsocket(){if(window.WebSocket){return true}return false}function CreateWebSocket(a,g,j,e){if(!CanCreateWebsocket()){throw"This browser does not support websockets."}ret=new WebSocket(a);if(g){ret.onclose=g}if(j){ret.onmessage=j}if(e){ret.onopen=e}return ret}function EscapeRegExp(a){return a.replace((new RegExp("(\\"+["/",".","*","+","?","|","(",")","[","]","{","}","\\"].join("|\\")+")","g")),"\\$1")}String.prototype.replacePArg=function(e,a){return replaceAll(this,e,a)};String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(e,g){return typeof a[g]!="undefined"?a[g]:e})};String.prototype.replaceAll=function(e,a){return replaceAllRaw(this,e,a)};replaceAllRaw=function(g,e,a){while(g.indexOf(e)>-1){g=g.replace(e,a)}return g};replaceAll=function(g,e,a){e=new RegExp(EscapeRegExp(e),"g");return g.replace(e,a||"")};Object.size=function(g){var e=0,a;for(a in g){if(g.hasOwnProperty(a)){e++}}return e};function WscPacket(a,e){this.raw=a;this.setNull();this.parse(e);this.raw=this.serialize()}WscPacket.prototype.parse=function(j){if(!(this.raw)){return null}j=j||"=";var a=this.raw;try{idx=a.indexOf("\n\n");if(idx>-1){this.body=a.substr(idx+2);a=a.substr(0,idx)}cmdline=null;idx=a.indexOf("\n");sidx=a.indexOf(j);if(idx>-1&&(sidx==-1||sidx>idx)){cmdline=a.substr(0,idx);a=a.substr(idx+1)}else{if(sidx==-1){cmdline=a;a=""}}if(cmdline){seg=cmdline.split(" ");this.cmd=seg[0];this.param=seg[1]?seg[1]:null}this.arg=this.parseArgs(a,j)}catch(g){alert("parser exception:"+g);this.setNull()}};WscPacket.prototype.parseArgs=function(a,e){e=e||"=";args={};lines=a.split("\n");for(n in lines){line=lines[n];si=line.search(e);if(si==-1){continue}args[line.substr(0,si)]=line.substr(si+e.length)||""}return args};WscPacket.prototype.setNull=function(){this.cmd=null;this.param=null;this.arg=null;this.body=null};WscPacket.prototype.toString=function(){return this.raw};WscPacket.prototype.serialize=function(){return wsc_packetstr(this.cmd,this.param,this.arg,this.body)};function wsc_packetstr(l,m,g,a){var e="";if(l){e=l;if(m){e=e+" "+m}}if(g){for(var j in g){e=e+"\n"+j+"="+g[j]}}e=e+"\n";if(a){e=e+"\n"+a}return e}function wsc_packet_serialze(a){return wsc_packetstr(a.cmd,a.param,a.arg,a.body)}function WscChannel(e,g){var a=e.deform_ns(g).slice(1).toLowerCase();this.client=e;this.info={raw:null,selector:null,namespace:null,members:{},pc:{},pc_order:[],title:{content:"",by:"",ts:""},topic:{content:"",by:"",ts:""},};this.info.raw=e.format_ns(g);this.info.selector=a;this.info.namespace=this.info.ns=e.deform_ns(g);scope_methods(this,WscChannel.prototype)}WscChannel.prototype.property=function(a){var g=a.pkt.arg["p"];switch(g){case"title":case"topic":this.setHeader(g,a);break;case"privclasses":this.setPrivclasses(a);break;case"members":this.setMembers(a);break;default:this.client.monitor("Received unknown property "+g+" received in "+this.info.namespace+".");break}};WscChannel.prototype.setHeader=function(a,g){this.info[a]["content"]=g.value||"";this.info[a]["by"]=g.by;this.info[a]["ts"]=g.ts;if(!this.info[a]["content"]){}};WscChannel.prototype.setPrivclasses=function(j){this.info.pc={};this.info.pc_order=[];var a=j.pkt.body.split("\n");for(var g in a){if(!a[g]){continue}bits=a[g].split(":");this.info.pc_order.push(parseInt(bits[0]));this.info.pc[parseInt(bits[0])]=bits[1]}this.info.pc_order.sort(function(l,e){return e-l})};WscChannel.prototype.setMembers=function(a){pack=new WscPacket(a.pkt.body);this.info.members={};while(pack.cmd=="member"){this.registerUser(pack);pack=new WscPacket(pack.body);if(pack==null){break}}this.setUserList()};WscChannel.prototype.registerUser=function(a){un=a.param;if(this.info.members[un]==undefined){this.info.members[un]=a.arg;this.info.members[un]["username"]=un;this.info.members[un]["conn"]=1}else{this.info.members[un]["conn"]++}};WscChannel.prototype.removeUser=function(a){member=this.info.members[a];if(member==undefined){return}member.conn--;if(member.conn==0){delete this.info.members[a]}};WscChannel.prototype.recv_join=function(a){info=new WscPacket("user "+a.user+"\n"+a["*info"]);this.registerUser(info);this.setUserList()};WscChannel.prototype.recv_part=function(a){this.removeUser(a.user);this.setUserList()};WscChannel.prototype.recv_privchg=function(a){member=this.info.members[a.user];if(!member){return}member.pc=event.pc;this.setUserList()};WscChannel.prototype.recv_kicked=function(a){if(!this.info.members[a.user]){return}delete this.info.members[a.user];this.setUserList()};function wsc_channel(a,e){var g={client:null,info:{raw:"",selector:"",namespace:"",members:{},pc:{},pc_order:[],title:{content:"",by:"",ts:""},topic:{content:"",by:"",ts:""}},window:null,logpanel:null,wrap:null,userpanel:null,tab:null,built:false,hidden:false,init:function(l,m,q){var j=l.deform_ns(m).slice(1).toLowerCase();this.client=l;this.hidden=q;this.info.raw=l.format_ns(m);this.info.selector=j;this.info.namespace=l.deform_ns(m)},build:function(){if(this.built){return}var j=this.info.selector;e=this.info.namespace;this.client.tabul.append(wsc_html_chattab.replacePArg("{selector}",j).replacePArg("{ns}",e));this.client.chatbook.append(wsc_html_channel.replacePArg("{selector}",j).replacePArg("{ns}",e));this.tab=this.client.tabul.find("#"+j+"-tab");this.window=this.client.chatbook.find("#"+j+"-window");this.logpanel=this.client.view.find("#"+j+"-log");this.wrap=this.logpanel.find("div.logwrap");this.userpanel=this.client.view.find("#"+j+"-users");this.client.view.find('a[href="#'+j+'"]').click(function(){g.client.toggleChannel(j);return false});var l=true;this.window.click(function(m){if(l){g.client.control.focus()}else{l=true}});this.logpanel.select(function(){l=false});if(this.hidden){this.tab.toggleClass("hidden")}this.built=true},invisible:function(){g.hidden=true;g.tab.addClass("hidden")},remove:function(){selector=this.info.selector;this.tab.remove();this.window.remove()},hideChannel:function(){this.window.css({display:"none"});this.tab.removeClass("active")},showChannel:function(){this.window.css({display:"block"});this.tab.addClass("active");this.tab.find("a").css({"font-weight":"normal"});this.resize()},toggleTabClass:function(j){this.tab.toggleClass(j)},scroll:function(){this.pad();this.wrap.scrollTop(this.wrap.prop("scrollHeight")-this.wrap.innerHeight())},pad:function(){this.wrap.css({"padding-top":0});wh=this.wrap.innerHeight();lh=this.logpanel.innerHeight()-this.logpanel.find("header").height()-3;pad=lh-wh;if(pad>0){this.wrap.css({"padding-top":pad})}else{this.wrap.css({"padding-top":0,height:lh})}},resize:function(){this.wrap.css({"padding-top":0});wh=this.client.chatbook.height();this.window.height(wh);cw=this.window.width();cu=this.window.find("div.chatusers");title=this.window.find("header div.title");topic=this.window.find("header div.topic");if(cu.css("display")!="none"){cw=cw-cu.outerWidth()}if(title.css("display")=="block"){wh=wh-title.outerHeight(true)}this.logpanel.css({height:wh+1,width:cw});this.scroll();cu.css({height:this.logpanel.innerHeight()-3})},log:function(j){this.logItem(wsc_html_logmsg.replacePArg("{message}",j))},logItem:function(l){var j=new Date().toTimeString().slice(0,8);this.wrap.append(wsc_html_logitem.replacePArg("{ts}",j).replacePArg("{message}",l));this.scroll()},serverMessage:function(l,j){this.logItem(wsc_html_servermsg.replacePArg("{message}",l).replacePArg("{info}",j))},property:function(j){var l=j.pkt.arg["p"];switch(l){case"title":case"topic":this.setHeader(l,j);break;case"privclasses":this.setPrivclasses(j);break;case"members":this.setMembers(j);break;default:a.monitor("Received unknown property "+l+" received in "+this.info.namespace+".");break}},setHeader:function(j,l){this.info[j]["content"]=l.value||"";this.info[j]["by"]=l.by;this.info[j]["ts"]=l.ts;if(!this.info[j]["content"]){}headd=this.window.find("header div."+j);headd.replaceWith(wsc_html_cheader.replacePArg("{head}",j).replacePArg("{content}",this.info[j]["content"]));headd=this.window.find("header div."+j);if(this.info[j]["content"]){headd.css({display:"block"})}else{this.window.find("header div."+j).css({display:"none"})}this.resize()},setUserList:function(){if(Object.size(this.info.members)==0){return}ulist='<div class="chatusers" id="'+this.info.selector+'-users">';for(var l in this.info.pc_order){pco=this.info.pc_order[l];pc=this.info.pc[pco];pcl="";for(var j in this.info.members){member=this.info.members[j];if(member.pc!=pc){continue}conn=member.conn==1?"":"["+member.conn+"]";s=member.symbol;pcl=pcl+"<li>"+s+'<a target="_blank" href="http://'+j+"."+this.client.settings.domain+'">'+j+"</a>"+conn+"</li>"}if(pcl.length>0){ulist=ulist+'<div class="pc"><h3>'+pc+"</h3><ul>"+pcl+"</ul></div>"}}ulist=ulist+"</div>";this.window.find("div.chatusers").replaceWith(ulist);this.userpanel=this.window.find("div.chatusers");this.userpanel.css({display:"block"});pcs=this.userpanel.find("h3");if(typeof(pcs)=="object"){pcs.addClass("first")}else{for(l in pcs){if(l==0){pcs[0].addClass("first");continue}pcs[l].removeClass("first")}}this.resize();this.client.trigger("set.userlist.wsc",{name:"set.userlist",ns:this.info.namespace})},setPrivclasses:function(m){this.info.pc={};this.info.pc_order=[];var j=m.pkt.body.split("\n");for(var l in j){if(!j[l]){continue}bits=j[l].split(":");this.info.pc_order.push(parseInt(bits[0]));this.info.pc[parseInt(bits[0])]=bits[1]}this.info.pc_order.sort(function(v,q){return q-v})},setMembers:function(j){pack=new WscPacket(j.pkt.body);this.info.members={};while(pack.cmd=="member"){this.registerUser(pack);pack=new WscPacket(pack.body);if(pack==null){break}}this.setUserList()},registerUser:function(j){un=j.param;if(this.info.members[un]==undefined){this.info.members[un]=j.arg;this.info.members[un]["username"]=un;this.info.members[un]["conn"]=1}else{this.info.members[un]["conn"]++}},removeUser:function(j){member=this.info.members[j];if(member==undefined){return}member.conn--;if(member.conn==0){delete this.info.members[j]}},recv_join:function(j){info=new WscPacket("user "+j.user+"\n"+j["*info"]);g.registerUser(info);g.setUserList()},recv_part:function(j){g.removeUser(j.user);g.setUserList()},recv_msg:function(j){tabl=this.tab.find("a");if(!this.tab.hasClass("active")){tabl.css({"font-weight":"bold"})}u=g.client.settings.username.toLowerCase();msg=j.message.toLowerCase();p=g.window.find("p.logmsg").last();if(msg.indexOf(u)<0||p.html().toLowerCase().indexOf(u)<0){return}p.addClass("highlight");if(this.tab.hasClass("active")){return}console.log(tabl);tabl.animate({backgroundColor:"#990000"},500).animate({backgroundColor:"#EDF8FF"},250).animate({backgroundColor:"#990000"},250).animate({backgroundColor:"#EDF8FF"},250).animate({backgroundColor:"#990000"},250).animate({backgroundColor:"#EDF8FF"},250).animate({backgroundColor:"#990000"},250)},recv_privchg:function(j){member=g.info.members[j.user];if(!member){return}member.pc=event.pc;g.setUserList()},recv_kicked:function(j){if(!g.info.members[j.user]){return}delete g.info.members[j.user];g.setUserList()}};g.init(a,e);return g}function WscTablumps(){this.lumps=this.defaultMap();this.repl=[/&(\/|)(b|i|u|s|sup|sub|code|p|ul|ol|li|bcode|a|iframe|acro|abbr)\t/g,"<$1$2>"]}WscTablumps.prototype.registerMap=function(a){this.lumps=a};WscTablumps.prototype.defaultMap=function(){return{"&link\t":[3,function(a){t=a[1]||"[link]";return'<a target="_blank" href="'+a[0]+'" title="'+t+'">'+t+"</a>"}],"&acro\t":[1,'<acronym title="{0}">'],"&abbr\t":[1,'<abbr title="{0}">'],"&img\t":[3,'<img src="{0}" alt="{1}" title="{2}" />'],"&iframe\t":[3,'<iframe src="{0}" width="{1}" height="{2}" />'],"&a\t":[2,'<a target="_blank" href="{0}" title="{1}">'],"&br\t":[0,"<br/>"]}};WscTablumps.prototype.parse=function(e,a){if(!e){return""}a=a||"\t";for(i=0;i<e.length;i++){if(e[i]!="&"){continue}primer=e.substring(0,i);working=e.substring(i);ti=working.indexOf("\t");if(ti==-1){continue}tag=working.substring(0,ti+1);working=working.substring(ti+1);lump=this.lumps[tag];if(lump===undefined){continue}cropping=this.tokens(working,lump[0],a);if(typeof(lump[1])=="string"){parsed=lump[1].format.apply(lump[1],cropping[0])}else{parsed=lump[1](cropping[0])}e=primer+parsed+cropping[1];i=i+(parsed.length-2)}e=e.replace(this.repl[0],this.repl[1]);return e};WscTablumps.prototype.tokens=function(j,e,g,a){g=g||"\t";a=a||"&";tokens=[];for(i=e;i>0;i--){find=j.indexOf(g);if(find==-1){break}tokens.push(j.substring(0,find));j=j.substring(find+1);if(tokens[tokens.length-1]==a){tokens.pop();break}}return[tokens,j]};var dAmn_avext=["gif","gif","jpg","png"];function dAmn_avatar(a,e){e=parseInt(e);cachebuster=(e>>2)&15;e=e&3;ext=dAmn_avext[e]||"gif";if(cachebuster){cachebuster="?"+cachebuster}else{cachebuster=""}if(e==0){ico="default"}else{ru=new RegExp("\\$un(\\[([0-9]+)\\])","g");ico="$un[0]/$un[1]/{un}".replace(ru,function(g,l,j){return a[j].toLowerCase()});ico=ico.replacePArg("{un}",a.toLowerCase())}return'<a target="_blank" title=":icon'+a+':" href="http://'+a+'.deviantart.com/"><img class="avatar"            alt=":icon'+a+':" src="http://a.deviantart.net/avatars/'+ico+"."+ext+cachebuster+'" height="50" width="50" /></a>'}function dAmnLumps(a){return{"&avatar\t":[2,function(e){return dAmn_avatar(e[0],e[1])}],"&emote\t":[5,'<img alt="{0}" width="{1}" height="{2}" title="{3}" src="http://e.deviantart.com/emoticons/{4}" />'],"&dev\t":[2,'{0}<a target="_blank" alt=":dev{1}:" href="http://{1}.deviantart.com/">{1}</a>'],"&thumb\t":[7,function(e){id=e[0];t=e[1];s=e[2][0];u=e[2].substring(1);dim=e[3].split("x");b=e[6];f=e[5];server=parseInt(e[4]);tw=w=parseInt(dim[0]);th=h=parseInt(dim[1]);if(w>100||h>100){if(w/h>1){th=(h*100)/w;tw=100}else{tw=(w*100)/w;th=100}if(tw>w||th>h){tw=w;th=h}}return'<a target="_blank" href="http://'+u+".deviantart.com/art/"+t.replacePArg(" ","-")+"-"+id+'"><img class="thumb" title="'+t+" by "+s+u+", "+w+"x"+h+'" width="'+tw+'"                        height="'+th+'" alt=":thumb'+id+':" src="http://fc03.deviantart.net/'+f.replace(/\:/,"/")+'" /></a>'}],}}function wsc_protocol(a){var e={client:null,evt_chains:[["recv","admin"]],tablumps:null,maps:{chatserver:["version"],dAmnServer:["version"],login:["username",["e"],"data"],join:["ns",["e"]],part:["ns",["e","*r"]],property:["ns",["p","by","ts"],"*value"],recv_msg:[null,[["from","user"]],"*message"],recv_npmsg:[null,[["from","user"]],"message"],recv_action:[null,["s",["from","user"]],"*message"],recv_join:["user",["s"],"*info"],recv_part:["user",["s","r"]],recv_privchg:["user",["s","by","pc"]],recv_kicked:["user",["s","by"],"*r"],recv_admin_create:[null,["p",["by","user"],["name","pc"],"privs"]],recv_admin_update:[null,["p",["by","user"],["name","pc"],"privs"]],recv_admin_rename:[null,["p",["by","user"],"prev",["name","pc"]]],recv_admin_move:[null,["p",["by","user"],"prev",["name","pc"],["n","affected"]]],recv_admin_remove:[null,["p",["by","user"],["name","pc"],["n","affected"]]],recv_admin_show:[null,["p"],"info"],recv_admin_showverbose:[null,["p"],"info"],recv_admin_privclass:[null,["p","e"],"command"],kicked:["ns",[["by","user"]],"*r"],ping:[],disconnect:[null,["e"]],send:["ns",["e"]],kick:["ns",[["u","user"],"e"]],get:["ns",["p","e"]],set:["ns",["p","e"]],kill:["ns",["e"]],unknown:[null,null,null,null,"packet"],},mapper:{recv:function(j,l,g){j.ns=l.param;sub=new WscPacket(l.body);if(sub.cmd=="admin"){ssub=new WscPacket(sub.body);return e.mapPacket(j,ssub,g)}return e.mapPacket(j,sub,g)}},messages:{chatserver:['<span class="servermsg">** Connected to llama {version} *</span>',false,true],dAmnServer:['<span class="servermsg">** Connected to dAmnServer {version} *</span>',false,true],login:['<span class="servermsg">** Login as {username}: "{e}" *</span>',false,true],join:['<span class="servermsg">** Join {ns}: "{e}" *</span>',true],part:['<span class="servermsg">** Part {ns}: "{e}" * <em>{*r}</em></span>',true],property:['<span class="servermsg">** Got {p} for {ns} *</span>',true],recv_msg:['<span><strong class="user">&lt;{user}&gt;</strong></span><span class="cmsg">{message}</span>'],recv_action:['<span class="caction user"><em>* {user}</em></span><span class="caction">{message}</span>'],recv_join:['<span class="cevent bg">** {user} has joined *</span>'],recv_part:['<span class="cevent bg">** {user} has left * <em>{r}</em></span>'],recv_privchg:['<span class="cevent">** {user} has been made a member of {pc} by {by} *</span>'],recv_kicked:['<span class="cevent">** {user} has been kicked by {by} * <em>{*r}</em></span>'],recv_admin_create:['<span class="cevent admin">** Privilege class {pc} has been created by {user} with: {privs} *</span>'],recv_admin_update:['<span class="cevent admin">** Privilege class {pc} has been updated by {user} with: {privs} *</span>'],recv_admin_rename:['<span class="cevent admin">** Privilege class {prev} has been renamed to {name} by {user} *</span>'],recv_admin_move:['<span class="cevent admin">** All members of {prev} have been moved to {pc} by {user} -- {affected} affected user(s) *</span>'],recv_admin_remove:['<span class="cevent admin">** Privilege class {pc} has been removed by {user} -- {affected} affected user(s) *</span>'],recv_admin_show:null,recv_admin_showverbose:null,recv_admin_privclass:['<span class="cevent admin">** Admin command "{command}" failed: {e} *</span>'],kicked:['<span class="servermsg">** You have been kicked by {user} * <em>{r}</em></span>'],ping:['<span class="servermsg">** Ping...</span>',true],disconnect:['<span class="servermsg">** You have been disconnected * <em>{e}</em></span>',false,true],send:['<span class="servermsg">** Send error: <em>{e}</em></span>'],kick:['<span class="servermsg">** Could not kick {user}: <em>{e}</em></span>'],get:['<span class="servermsg">** Could not get {p} info for {ns}: <em>{e}</em></span>'],set:['<span class="servermsg">** Could not set {p}: <em>{e}</em></span>'],kill:['<span class="servermsg">** Kill error: <em>{e}</em></span>'],unknown:['<span class="servermsg">** Received unknown packet in {ns}: <em>{packet}</em></span>',true],},init:function(g){this.client=g;this.mapper.recv=this.map_recv;this.tablumps=new WscTablumps();if(this.client.settings.tablumps!==null){lumpmap=this.client.settings.tablumps();this.client.view.extend(lumpmap,this.tablumps.lumps);this.tablumps.registerMap(lumpmap)}g.bind("chatserver.wsc",this.chatserver);g.bind("dAmnServer.wsc",this.chatserver);g.bind("login.wsc",this.login);g.bind("join.wsc",this.join);g.bind("part.wsc",this.part);g.bind("ping.wsc",this.ping);g.bind("property.wsc",this.property);g.bind("recv_join.wsc",this.recv_joinpart);g.bind("recv_part.wsc",this.recv_joinpart);g.bind("recv_msg.wsc",this.recv_msg);g.bind("recv_action.wsc",this.recv_msg);g.bind("recv_privchg.wsc",this.recv_privchg);g.bind("recv_kicked.wsc",this.recv_kicked)},debug_pkt:function(g){console.log(g.pkt.serialize());console.log(g)},connected:function(g){this.client.trigger("connected.wsc",{name:"connected",pkt:new WscPacket("connected\n\n")});this.client.connected=true;this.client.handshake();this.client.attempts=0},closed:function(g){console.log(g);this.client.trigger("closed.wsc",{name:"closed",pkt:new WscPacket("connection closed\n\n")});if(this.client.connected){this.client.monitorAll("Connection closed");this.client.connected=false}else{this.client.monitorAll("Connection failed")}if(this.client.attempts>2){this.client.monitorAll("Can't connect. Try again later.");this.client.attempts=0;return}this.client.monitorAll("Connecting in 5 seconds...");setTimeout(this.client.connect.bind(this.client),5000)},process_data:function(g){var j=new WscPacket(g.data);if(j==null){return}var l=this.client.event_name(j);pevt=this.packetEvent(l,j);this.log(pevt);this.client.trigger("data.wsc",pevt);this.client.trigger(l+".wsc",pevt)},packetEvent:function(j,l){var g={name:j,pkt:l,ns:this.client.mns};if(!this.maps[j]){return g}mapping=this.maps[j];cmd=l.cmd;if(this.mapper[cmd]){this.mapper[cmd](g,l,mapping)}else{this.mapPacket(g,l,mapping)}return g},mapPacket:function(l,g,j){for(i in j){if(j[i]==null){continue}key=j[i];skey=key;switch(i){case"0":l[key]=g.param;break;case"1":for(n in j[1]){key=j[1][n];if(key instanceof Array){l[key[1]]=g.arg[key[0]];skey=key[1]}else{k=key[0]=="*"?key.slice(1):key;l[key]=g.arg[k]||"";skey=key}}break;case"2":if(key instanceof Array){this.mapPacket(l,new WscPacket(g.body),key)}else{l[key]=g.body}break}if(skey[0]!="*"){continue}k=skey.slice(1);l[k]=this.tablumps.parse(l[skey])}},map_recv:function(l,g,j){e.mapPacket(l,g,["ns",null,j])},log:function(g){msgm=e.messages[g.name];if(!msgm){return}msg=msgm[0];if(g.s=="0"){return}for(key in g){d=key=="ns"?e.client.deform_ns(g[key]):g[key];msg=msg.replacePArg("{"+key+"}",d)}if(!msgm[2]){if(!msgm[1]){e.client.channel(g.ns).logItem(msg)}else{e.client.channel(e.client.mns).logItem(msg)}}else{e.client.logItemAll(msg)}},ping:function(g){e.client.pong()},chatserver:function(g){e.client.login()},login:function(g){if(g.pkt.arg["e"]=="ok"){info=new WscPacket("info\n"+g.data);e.client.settings.username=g.pkt.param;e.client.settings.symbol=info.arg.symbol;e.client.settings.userinfo=info.arg;if(e.client.fresh){e.client.join(a.settings.autojoin)}else{for(key in e.client.channelo){if(e.client.channelo[key].info.namespace[0]!="~"){e.client.join(key)}}}}else{}if(e.client.fresh){e.client.fresh=false}},join:function(g){if(g.pkt.arg["e"]=="ok"){ns=e.client.deform_ns(g.pkt.param);e.client.createChannel(ns);e.client.channel(ns).serverMessage("You have joined "+ns)}else{e.client.cchannel.serverMessage("Failed to join "+e.client.deform_ns(g.pkt.param),g.pkt.arg["e"])}},part:function(g){ns=e.client.deform_ns(g.ns);if(g.e=="ok"){console.log(g);info="";if(g.pkt.arg["r"]){info="["+g.pkt.arg["r"]+"]"}msg="You have left "+ns;c=e.client.channel(ns);c.serverMessage(msg,info);e.client.removeChannel(ns);if(e.client.channels()==0){switch(g.r){case"bad data":case"bad msg":case"msg too big":break;default:if(g.r.indexOf("killed:")<0){return}break}e.process_data({data:"disconnect\ne="+g.r+"\n"})}}else{e.client.monitor("Couldn't leave "+e.client.deform_ns(g.pkt.param),g.pkt.arg["e"])}},property:function(g){chan=e.client.channel(g.pkt.param);if(!chan){return}chan.property(g)},recv_joinpart:function(g){c=e.client.channel(g.ns);if(g.name=="recv_join"){c.recv_join(g)}else{c.recv_part(g)}},recv_msg:function(g){e.client.channel(g.ns).recv_msg(g)},recv_privchg:function(g){e.client.channel(g.ns).recv_privchg(g)},recv_kicked:function(g){e.client.channel(g.ns).recv_kicked(g)}};e.init(a);return e}function wsc_extdefault(a){var e={init:function(g){this.client=g;this.client.bind("cmd.set.wsc",this.setter.bind(e));this.client.bind("cmd.connect.wsc",this.connect.bind(e));this.client.bind("cmd.join.wsc",this.join.bind(e));this.client.bind("cmd.part.wsc",this.part.bind(e));this.client.bind("cmd.title.wsc",this.title.bind(e));this.client.bind("cmd.promote.wsc",this.promote.bind(e));this.client.bind("cmd.me.wsc",this.action.bind(e));this.client.bind("cmd.kick.wsc",this.kick.bind(e));this.client.bind("cmd.raw.wsc",this.raw.bind(e));this.client.bind("cmd.say.wsc",this.say.bind(e));this.client.bind("cmd.npmsg.wsc",this.npmsg.bind(e));this.client.bind("cmd.clear.wsc",this.clear.bind(e));this.client.bind("set.userlist.wsc",this.setUsers.bind(e))},setter:function(g){data=g.args.split(" ");setting=data.shift().toLowerCase();data=data.join(" ");if(data.length==0){this.client.cchannel.serverMessage("Could not set "+setting,"No data supplied");return}if(!(setting in this.client.settings)){this.client.cchannel.serverMessage('Unknown setting "'+setting+'"');return}this.client.settings[setting]=data;this.client.cchannel.serverMessage("Changed "+setting+" setting","value: "+data);this.client.control.setLabel()},connect:function(g){this.client.connect()},join:function(g){chans=g.args.split(" ");chans=chans.toString()==""?[]:chans;if(g.ns!=g.target){chans.unshift(g.target)}if(chans.toString()==""){return}for(index in chans){e.client.join(chans[index])}},part:function(g){chans=g.args.split(" ");if(g.ns!=g.target){chans.unshift(g.target)}if(chans.toString()==""){e.client.part(g.ns);return}for(index in chans){e.client.part(chans[index])}},title:function(g){e.client.title(g.target,g.args)},promote:function(g){bits=g.args.split(" ");e.client.promote(g.target,bits[0],bits[1])},action:function(g){e.client.action(g.target,g.args)},raw:function(g){e.client.send(g.args.replace(/\\n/gm,"\n"))},kick:function(g){d=g.args.split(" ");u=d.shift();r=d.length>0?d.join(" "):null;e.client.kick(g.target,u,r)},say:function(g){e.client.say(g.target,g.args)},npmsg:function(g){e.client.npmsg(g.target,g.args)},clear:function(g){this.client.cchannel.logpanel.find("p.logmsg").remove();this.client.cchannel.resize()},setUsers:function(j){var g=e.client.channel(j.ns);users=g.userpanel.find("li a");users.each(function(C,D){var l=g.userpanel.find(D);var A=l.html();var m=g.info.members[A];var z=null;l.data("hover",0);function q(G,E,H,F){o=G.offset();eb=G.outerHeight(true)+o.top;er=G.outerWidth(true)+o.left;if(E>=o.left&&E<=er&&H>=o.top&&H<=eb){return true}if(F===true){if(E<=(er+30)&&E>=o.left&&H>=o.top&&H<=(o.top+30)){return true}}return false}function v(){z.remove()}ru=new RegExp("\\$un(\\[([0-9]+)\\])","g");function B(E,G,F){return m.username[F].toLowerCase()}l.hover(function(E){g.window.find(this).data("hover",1);rn=m.realname?"<li>"+m.realname+"</li>":"";tn=m.typename?"<li>"+m.typename+"</li>":"";pane='<div class="userinfo" id="'+m.username+'">                                <div class="avatar">                                    '+dAmn_avatar(m.username,m.usericon)+'                                </div><div class="info">                                <strong>                                '+m.symbol+'<a target="_blank" href="http://'+m.username+"."+e.client.settings.domain+'/">'+m.username+"</a>                                </strong>                                <ul>                                    "+rn+tn+"                                </ul></div>                            </div>";g.window.append(pane);z=g.window.find(".userinfo#"+m.username);pos=l.offset();z.css({top:(pos.top-l.height())+10,left:(pos.left-(z.width()))-15});z.hover(function(){g.window.find(this).data("hover",1)},v);z.data("hover",0);box=g.window.find("div.userinfo:not('#"+m.username+"')");box.remove()},function(E){g.window.find(this).data("hover",0);if(q(z,E.pageX,E.pageY,true)){return}v()})})},};e.init(a);return e}function wsc_client(e,g,j){var a={view:null,mozilla:false,control:null,tabul:null,chatbook:null,connected:false,conn:null,fresh:true,evt_chains:[["recv","admin"]],events:null,attempts:0,settings:{domain:"website.com",server:"ws://website.com/wsendpoint",agent:"wsc 0.1a",symbol:"",username:"",userinfo:{},pk:"",monitor:["~Monitor",true],welcome:"Welcome to the wsc web client!",autojoin:"chat:channel",protocol:wsc_protocol,extend:[wsc_extdefault],control:wsc_control,stype:"llama",client:"chatclient",tablumps:null,avatarfile:"$un[0]/$un[1]/{un}",defaultavatar:"default.gif",avatarfolder:"/avatars/",emotefolder:"/emoticons/",thumbfolder:"/thumbs/",theme:"wsct_default",},protocol:null,channelo:{},cchannel:null,cmds:[],init:function(l,q,v){l.extend(this.settings,q);l.append('<div class="wsc '+this.settings.theme+'"></div>');this.attempts=0;this.view=l.find(".wsc");this.mozilla=v;this.connected=false;this.conn=null;this.events=new EventEmitter();this.mns=this.format_ns(this.settings.monitor[0]);this.lun=this.settings.username.toLowerCase();this.channelo={};this.protocol=this.settings.protocol(this);this.cmds=[];for(var m in this.settings.extend){this.settings.extend[m](this)}this.buildUI();this.monitor(this.settings.welcome)},registerExtension:function(l){if(container===undefined){return}a.settings.extend.push(l);l(a)},jq_registerExtension:function(l,m){a.registerExtension(m)},bind:function(m,l){this.events.addListener(m,function(q){l(q)});jqi=m.indexOf(".wsc");if(m.indexOf("cmd.")!=0||jqi==-1||jqi==4){return}cmd=m.slice(4,jqi).toLowerCase();this.cmds.push(cmd)},jq_bind:function(l,m){a.bind(m.event,m.handler)},removeListeners:function(){this.events.removeListeners()},trigger:function(l,m){this.events.emit(l,m)},jq_trigger:function(l,m){a.trigger(m.event,m.data)},channel:function(l,m){l=this.deform_ns(l).slice(1).toLowerCase();if(!this.channelo[l]&&m){this.channelo[l]=m}return this.channelo[l]},channels:function(){chans=-1;for(ns in a.channelo){if(a.channelo[ns].hidden){continue}chans++}return chans},connect:function(){if(a.connected){return}this.attempts++;if(CanCreateWebsocket()){a.conn=a.createChatSocket();a.trigger("start.wsc",new WscPacket("client connecting\ne=ok\n\n"))}else{a.monitor("Your browser does not support WebSockets. Sorry.");a.trigger("start.wsc",new WscPacket("client connecting\ne=no websockets available\n\n"))}},jq_connect:function(){a.connect()},createChatSocket:function(){var l=this;return CreateWebSocket(this.settings.server,function(m){l.protocol.closed(m)},function(m){l.protocol.process_data(m)},function(m){l.protocol.connected(m)})},buildUI:function(){this.view.append(wsc_html_ui);this.control=this.settings.control(this);this.tabul=this.view.find("#chattabs");this.chatbook=this.view.find("div.chatbook");hide=this.settings.monitor[1];this.createChannel(this.mns,hide);this.control.setInput();this.control.focus();this.resizeUI()},resizeUI:function(){a.control.resize();a.view.height(a.view.parent().height());a.view.width("100%");h=(a.view.parent().height()-a.tabul.outerHeight(true)-a.control.height());a.chatbook.height(h);for(select in a.channelo){chan=a.channel(select);chan.resize()}},loop:function(){a.doLoop()},doLoop:function(){for(key in this.channelo){c=this.channelo[key];msgs=c.logpanel.find(".logmsg");if(msgs.length<100){continue}while(msgs.length>100){msgs.slice(0,10).remove();msgs=c.logpanel.find(".logmsg")}c.resize()}},createChannel:function(m,l){chan=this.channel(m,wsc_channel(this,m));chan.build();this.toggleChannel(m);if(l){chan.invisible()}},removeChannel:function(m){if(this.channels()==0){return}chan=this.channel(m);chan.remove();delete this.channelo[chan.info.selector];var l="";for(tmp in this.channelo){if(this.channelo.hasOwnProperty(tmp)&&tmp!=chan.info.selector){l=tmp}}this.toggleChannel(l);this.channel(l).resize()},toggleChannel:function(l){chan=this.channel(l);if(!chan){return}if(this.cchannel){if(this.cchannel==chan){return}this.cchannel.hideChannel();this.control.cacheInput()}chan.showChannel();this.control.focus();this.cchannel=chan;this.control.setLabel();if(this.settings.monitor[1]){mt=this.tabul.find("#"+this.channel(this.mns).info.selector+"-tab");mt.addClass(this.settings.monitor[1])}this.resizeUI()},log:function(l,q){var m=this.channel(l);if(!m){return}m.log(q)},logAll:function(l){for(ns in this.channelo){this.channlo[ns].log(l)}},logItemAll:function(l){for(ns in this.channelo){this.channelo[ns].logItem(l)}},monitorAll:function(m,l){for(ns in this.channelo){this.channelo[ns].serverMessage(m,l)}},serverMessage:function(l,v,q){var m=this.channel(l);if(!m){return}m.serverMessage(v,q)},monitor:function(m,l){this.serverMessage(this.mns,m,l)},deform_ns:function(l){if(l.indexOf("chat:")==0){return"#"+l.slice(5)}if(l.indexOf("server:")==0){return"~"+l.slice(7)}if(l.indexOf("pchat:")==0){var m=l.split(":");m.shift();for(i in m){name=m[i];if(name.toLowerCase()!=this.lun){return"@"+name}}}if(l[0]!="#"&&l[0]!="@"&&l[0]!="~"){return"#"+l}return l},format_ns:function(l){if(l.indexOf("#")==0){return"chat:"+l.slice(1)}if(l.indexOf("@")==0){var m=[l.slice(1),this.lun];m.sort(caseInsensitiveSort);m.unshift("pchat");return m.join(":")}if(l.indexOf("~")==0){return"server:"+l.slice(1)}if(l.indexOf("chat:")!=0&&l.indexOf("server:")!=0&&l.indexOf("pchat:")!=0){return"chat:"+l}return l},event_name:function(m){var v=m.cmd;var l=null;for(var q in this.evt_chains){l=this.evt_chains[q];if(l[0]!=v){continue}var z=new WscPacket(m.body);v=v+"_"+z.cmd;if(l.length>1&&z.param!=undefined){if(l[1]==z.cmd){return v+"_"+z.param}}}return v},send:function(l){if(this.connected){return this.conn.send(l)}return -1},handshake:function(){this.send(wsc_packetstr(this.settings.client,"0.3",{agent:this.settings.agent}))},pong:function(){this.send(wsc_packetstr("pong"))},login:function(){pkt="login "+this.settings.username+"\npk="+this.settings.pk+"\n";this.send(pkt)},join:function(l){this.send(wsc_packetstr("join",this.format_ns(l)))},part:function(l){this.send(wsc_packetstr("part",this.format_ns(l)))},promote:function(q,l,m){this.send(wsc_packetstr("send",this.format_ns(q),{},wsc_packetstr("promote",l,{},(!m?"":m))))},say:function(l,m){this.send(wsc_packetstr("send",this.format_ns(l),{},wsc_packetstr("msg","main",{},m)))},npmsg:function(l,m){this.send(wsc_packetstr("send",this.format_ns(l),{},wsc_packetstr("npmsg","main",{},m)))},action:function(l,m){this.send(wsc_packetstr("send",this.format_ns(l),{},wsc_packetstr("action","main",{},m)))},title:function(l,m){this.send(wsc_packetstr("set",this.format_ns(l),{p:"title"},m))},kick:function(m,l,q){this.send(wsc_packetstr("kick",this.format_ns(m),{u:l},q?q:null))},};a.init(e,g,j);return a}function wsc_control(a){var e={client:null,panel:null,form:null,history:{},tab:{hit:false,cache:"",matched:[],index:-1,type:0,prefix:["","/",""],},init:function(g){this.client=g;this.draw();this.panel=this.client.view.find("div.chatcontrol");this.form=this.panel.find("form.msg");this.input=this.form.find("input.msg")},draw:function(){this.client.view.append(wsc_html_control)},focus:function(){e.input.focus()},userLine:function(){return this.client.settings.symbol+this.client.settings.username},resize:function(){this.panel.css({width:"100%"});this.form.css({width:"100%"});this.input.css({width:this.client.view.width()-80})},height:function(){return this.panel.height()+17},setLabel:function(){ns=this.client.cchannel.info.namespace;this.untab();h=this.getHistory();this.input.val(h.index==-1?h.tmp:h.list[h.index]);if(h.index==-1){h.tmp=""}},cacheInput:function(){h=this.getHistory();if(h.index>-1){return}h.tmp=this.input.val()},setInput:function(){if(this.client.mozilla){this.input.keypress(this.keypress)}else{this.input.keydown(this.keypress)}this.form.submit(this.submit)},getHistory:function(){ns=this.client.cchannel.info.namespace;if(!this.history[ns]){this.history[ns]={index:-1,list:[],tmp:""}}return this.history[ns]},appendHistory:function(g){if(!g){return}h=this.getHistory();h.list.unshift(g);h.index=-1;if(h.list.length>100){h.list.pop()}},scrollHistory:function(g){history=this.getHistory();data=this.input.val();if(history.index==-1){if(data){history.tmp=data}else{history.list[history.index]=data}}if(g){if(history.list.length>0&&history.index<(history.list.length-1)){history.index++}}else{if(history.index>-1){history.index--}}this.setLabel()},keypress:function(g){key=g.which||g.keypress;ut=e.tab.hit;bubble=false;switch(key){case 13:e.submit(g);break;case 38:e.scrollHistory(true);break;case 40:e.scrollHistory(false);break;case 9:e.tabItem(g);ut=false;break;default:bubble=true;break}if(ut){e.untab(g)}return bubble},submit:function(g){msg=e.input.val();e.appendHistory(msg);e.input.val("");e.handleInput(g,msg);return false},untab:function(g){this.tab.hit=false;this.tab.matched=[];this.tab.cache="";this.tab.index=-1},newtab:function(g){this.tab.hit=true;this.tab.index=-1;this.tab.matched=[];this.tab.type=0;needle=this.chomp();this.unchomp(needle);if(needle[0]=="/"||needle[0]=="#"){this.tab.type=needle[0]=="/"?1:2;needle=needle.slice(1)}else{this.tab.type=0}this.tab.cache=needle;needle=needle.toLowerCase();this.tab.matched=[];if(this.tab.type==0){for(user in this.client.cchannel.info.members){if(user.toLowerCase().indexOf(needle)==0){this.tab.matched.push(user)}}}else{if(this.tab.type==1){for(i in this.client.cmds){cmd=this.client.cmds[i];if(cmd.indexOf(needle)==0){this.tab.matched.push(cmd)}}}else{if(this.tab.type==2){for(chan in this.client.channelo){if(chan.toLowerCase().indexOf(needle)==0){this.tab.matched.push(this.client.channel(chan).info.namespace)}}}}}},tabItem:function(g){if(!this.tab.hit){this.newtab(g)}this.chomp();this.tab.index++;if(this.tab.index>=this.tab.matched.length){this.tab.index=-1}if(this.tab.index==-1){this.unchomp(this.tab.prefix[this.tab.type]+this.tab.cache);return}suf=this.input.val()==""&&this.tab.type==0?": ":" ";this.unchomp(this.tab.prefix[this.tab.type]+this.tab.matched[this.tab.index]+suf)},chomp:function(){d=this.input.val();i=d.lastIndexOf(" ");if(i==-1){this.input.val("");return d}chunk=d.slice(i+1);this.input.val(d.slice(0,i));if(chunk.length==0){return this.chomp()}return chunk},unchomp:function(g){d=this.input.val();if(!d){this.input.val(g)}else{this.input.val(d+" "+g)}},handleInput:function(j,g){if(g==""){return}if(g[0]!="/"){if(!this.client.cchannel){return}}g=(j.shiftKey?"/npmsg ":(g[0]=="/"?"":"/say "))+g;g=g.slice(1);bits=g.split(" ");cmdn=bits.shift();ens=this.client.cchannel.info.namespace;etarget=ens;if(bits[0]){hash=bits[0][0];if((hash=="#"||hash=="@")&&bits[0].length>1){etarget=this.client.format_ns(bits.shift())}}arg=bits.join(" ");this.client.trigger("cmd."+cmdn+".wsc",{name:"cmd",cmd:cmdn,args:arg,target:etarget,ns:ens})},};e.init(a);return e}(function(a){a("*").hover(function(){a(this).data("hover",true)},function(){a(this).data("hover",false)});a.fn.wsc=function(g,e){client=a(window).data("wscclient");if(g=="init"||client===undefined){if(client==undefined){client=wsc_client(a(this),e,a.browser.mozilla);a(window).resize(client.resizeUI);a(window).focus(function(){client.control.focus()});setInterval(client.loop,120000)}a(window).data("wscclient",client)}if(g!="init"&&g!=undefined){g="jq_"+g;if(g in client){client[g](a(this),e)}}return client}}