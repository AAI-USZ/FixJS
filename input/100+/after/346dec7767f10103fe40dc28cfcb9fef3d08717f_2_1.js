function(window,undefined){var MutationObserver=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver,debug=!1,Sprig,$=window.jQuery||typeof require=="function"&&(require("jquery")||require("jQuery"))||function(){throw"Sprig requires jQuery"}(),log=function(){if(!debug)return log=function(){};console.log.apply(console,arguments)},camel2data=function(camelStr){return camelStr.replace(/([A-Z]){1}/g,function(s){return"-"+s.toLowerCase()})},$D=function(el){return el.__sprigDataAccessor__||(el.dataset?el.__sprigDataAccessor__={set:function(key,val){el.dataset[key]=val},get:function(key){return key?el.dataset[key]:el.dataset}}:el.__sprigDataAccessor__=function(){var dataset=$.extend({},$(el).data());return{set:function(key,val){dataset[key]=val,el.setAttribute(camel2data(key),val)},get:function(key){return key?dataset[key]:dataset}}}()),el.__sprigDataAccessor__};function hasComponent(el){return $D(el).get().sprigComponent}function isLoading(el){return $D(el).get().sprigReadyState=="loading"}function isLoaded(el){return $D(el).get().sprigReadyState=="loaded"}function isDeferred(el){return $D(el).get().sprigDefer}Sprig=function(){function Sprig(){this.components={},this.pending={};if(MutationObserver){var self=this,observer=new MutationObserver(function(mutations){for(var i=0,i_len=mutations.length;i<i_len;i++)(function(addedNodes){for(var j=0;j<addedNodes.length;j++){var $el=$(addedNodes[j]);if(!hasComponent($el)||isLoaded($el)||isLoading($el)||isDeferred($el))return;log("Mutated, now setup: ",addedNodes[j]),self.setup(addedNodes[j])}})(mutations[i].addedNodes)});observer.observe(document,{childList:!0,subtree:!0})}}Sprig.prototype.finalize=function(el){$D(el).set("sprigReadyState","loaded"),this.load(el)},Sprig.prototype.add=function(componentId,setupFunc){if(this.components[componentId])return console.warn('Component "'+componentId+'" already registered. Skipping.');this.components[componentId]={instances:[],setupFunc:setupFunc};if(this.pending[componentId]){var todo=this.pending[componentId].slice();delete this.pending[componentId];var el;while(el=todo.shift())log("Now ready to setup "+componentId+" for ",el),this.setup(el)}},Sprig.prototype.setup=function(el){var componentId=$D(el).get().sprigComponent,component=this.components[componentId];if(!component){log('Component "'+componentId+'" not registered yet, so defer setup for',el),this.pending[componentId]||(this.pending[componentId]=[]),this.pending[componentId].push(el);return}log("Setup component for",el),$D(el).set("sprigReadyState","loading");var instance=null;for(var i=0,len=component.instances.length;i<len;i++)if(component.instances[i].el==el){instance=component.instances[i];break}instance?(log("reloading, original attrs:",JSON.stringify(instance.originalAttrs)),$.extend($D(el).get(),instance.originalAttrs),log($D(el).get())):(instance={el:el,originalAttrs:$.extend({},$(el).data())},component.instances.push(instance));var setupFunc=component.setupFunc,async=setupFunc.length==3,data=$D(el).get(),self=this;async?setupFunc(el,data,function(){self.finalize(el)}):(setupFunc(el,data),self.finalize(el))},Sprig.prototype.load=function(root){var $notLoaded=$("[data-sprig-component]:not([data-sprig-ready-state=loaded]):not([data-sprig-ready-state=loading])",root);log("Load "+$notLoaded.length+" components in",root||"body");var self=this;$notLoaded.each(function(i,el){self.setup(el)})},Sprig.prototype.reload=function(root){log("Load component inside",root);var $loaded=$("[data-sprig-ready-state=loaded]",root);log("Reload "+$loaded.length+" components in",root||"body");var self=this;$loaded.each(function(i,el){self.setup(el)})};var global=new Sprig;return $.extend(Sprig,global),Sprig}(),typeof exports!="undefined"?module.exports=Sprig:window.Sprig=Sprig}