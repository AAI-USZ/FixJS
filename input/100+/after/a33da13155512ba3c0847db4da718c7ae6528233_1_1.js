function(){function page(path,fn){var route=new Route(path);for(var i=1;i<arguments.length;++i)page.callbacks.push(route.middleware(arguments[i]))}function Context(path){"/"==path[0]&&0!=path.indexOf(base)&&(path=base+path),this.path=path.replace(base,"")||"/",this.title=document.title,this.params=[]}function Route(path,options){options=options||{},this.path=path,this.method="GET",this.regexp=pathtoRegexp(path,this.keys=[],options.sensitive,options.strict)}function pathtoRegexp(path,keys,sensitive,strict){return path instanceof RegExp?path:(path instanceof Array&&(path="("+path.join("|")+")"),path=path.concat(strict?"":"/?").replace(/\/\(/g,"(?:/").replace(/\+/g,"__plus__").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(_,slash,format,key,capture,optional){return keys.push({name:key,optional:!!optional}),slash=slash||"",""+(optional?"":slash)+"(?:"+(optional?slash:"")+(format||"")+(capture||format&&"([^/.]+?)"||"([^/]+?)")+")"+(optional||"")}).replace(/([\/.])/g,"\\$1").replace(/__plus__/g,"(.+)").replace(/\*/g,"(.*)"),new RegExp("^"+path+"$",sensitive?"":"i"))}var base="";page.callbacks=[],page.base=function(path){if(0==arguments.length)return base;base=path},page.process=function(path){page.dispatch(new Context(path))},page.dispatch=function(ctx){function next(){var fn=page.callbacks[i++];fn&&fn(ctx,next)}var i=0;next()},Route.prototype.middleware=function(fn){var self=this;return function(ctx,next){if(self.match(ctx.path,ctx.params))return fn(ctx.params,next);next()}},Route.prototype.match=function(path,params){var keys=this.keys,m=this.regexp.exec(path);if(!m)return!1;for(var i=1,len=m.length;i<len;++i){var key=keys[i-1],val="string"==typeof m[i]?decodeURIComponent(m[i]):m[i];key?params[key.name]=undefined!==params[key.name]?params[key.name]:val:params.push(val)}return!0},"undefined"==typeof window?module.exports=page:window.page=page}