function(){meddb={};var e={base_url:"http://meddb.medicinesinfohub.net",loader:"jsonp"},t=function(e,t){e.slice(-5)==".html"?d3.html(e,t):d3.json(e,t)},n=function(t,n){var r;t.slice(-5)==".html"?(r=[e.base_url+t.slice(0,-5)+".jsonp"],meddb.callback=function(e){var t=document.createDocumentFragment(),r=document.createElement("div");r.innerHTML=e,t.appendChild(r.firstChild),n(t)}):(r=[e.base_url+t+"?jsonp=meddb.callback"],meddb.callback=function(e){n(e)}),d3.select("html").select("script#meddb_jsonp").remove(),d3.select("html").select("script#meddb_jsonp").data(r).enter().append("script").attr("id","meddb_jsonp").attr("src",function(e){return e})},r=function(r,i){e.loader=="standard"?t(r,i):e.loader=="jsonp"&&n(r,i)};meddb.template={},meddb.template.cache={},meddb.template.load=function(e,t){d3.html(e,function(e){t(e.cloneNode(!0))})},meddb.template.inject=function(e,t){t=t||"#meddb_inner_container";var n=d3.select(t)[0][0];n.innerHTML="",n.appendChild(e)},meddb.template.hide=function(){d3.select("#meddb_page").attr("id","meddb_page_outgoing").transition().style("opacity","0").style("left","-950px").remove(),d3.select("img#meddb_loading").transition().duration(100).style("opacity",1)},meddb.template.show=function(e){var t="#meddb_inner_container";d3.select(e).select(".meddb_inner_page").attr("id","meddb_page_incoming").style("opacity","0").style("left","950px");var n=d3.select(t)[0][0];n.appendChild(e),d3.select("#meddb_page_incoming").transition().style("opacity","1").style("left","0px").attr("id","meddb_page"),d3.select("img#meddb_loading").transition().duration(100).style("opacity",0)},meddb.template.fx=function(e){var t="#meddb_inner_container";d3.select(e).select(".meddb_inner_page").attr("id","meddb_page_incoming").style("opacity","0").style("left","950px");var n=d3.select(t)[0][0];n.appendChild(e),d3.select("#meddb_page").attr("id","meddb_page_outgoing").transition().style("opacity","0").style("left","-950px").remove(),d3.select("#meddb_page_incoming").transition().style("opacity","1").style("left","0px").attr("id","meddb_page")},meddb.router=function(){var e=location.hash,t=meddb.history.list[meddb.history.list.length-1];if(t&&e==t.hash)return;if(e==""||e=="#")location.hash="medicine";else if(e.substring(0,5)=="#tab:"){var n=e.substring(5);meddb.tabber.change(n)}else{var r="";if(e=="#medicine")meddb.medicine.list();else if(e.substring(0,10)=="#medicine:"){var i=parseInt(e.substring(10));meddb.medicine.detail(i)}else if(e.substring(0,9)=="#product:"){var i=parseInt(e.substring(9));meddb.product.detail(i)}else if(e.substring(0,10)=="#supplier:"){var i=parseInt(e.substring(10));meddb.supplier.detail(i)}else if(e.substring(0,5)=="#tab:"){var n=e.substring(5);d3.select("div#meddb_inner_container").select("div.tab-content").selectAll("div.tab-pane").classed("active",!1),d3.select("div#meddb_inner_container").select("div.tab-content").select("div.tab-pane#"+n).classed("active",!0)}}},meddb.history={},meddb.history.list=[],meddb.history.add=function(e,t){var n=meddb.history.list[meddb.history.list.length-1];if(n&&e==n.hash)return;meddb.history.list.push({hash:e,text:t}),d3.select("ul#meddb_breadcrumb").selectAll("li").remove();var r=d3.select("ul#meddb_breadcrumb").selectAll("li").data(meddb.history.list.slice(-5)).enter().append("li");r.append("a").attr("href",function(e){return e.hash}).text(function(e){return e.text}),r.append("span").classed("divider",!0).text(" / ")},meddb.tabber={},meddb.tabber.init=function(){var e=function(){return meddb.tabber.change(this.href.split("#tab:")[1]),!1};d3.selectAll('a[href^="#tab:"]').on("click",e)},meddb.tabber.onclick=function(e){return meddb.tabber.change(e.href.split("#tab:")[1]),e.parentNode.className+=" active",!1},meddb.tabber.change=function(e){d3.select("div#meddb_inner_container").select("div.tab-content").selectAll("div.tab-pane").classed("active",!1),d3.select("div#meddb_inner_container").select("div.tab-content").select("div.tab-pane#"+e).classed("active",!0),d3.select("div#meddb_inner_container").select("ul.nav.nav-tabs").selectAll("li").classed("active",!1),d3.select("div#meddb_inner_container").select("ul.nav.nav-tabs").select('li>a[href="#tab:'+e+'"]').classed("active",!0)},meddb.medicine={};var i=function(e,t){var n=function(e){var t=[],n=[],r=[];return e.ingredients.forEach(function(e){n.push(e.inn),r.push(e.strength)}),t.push(n.join(" + ")),t.push(r.join(" + ")),t.push(e.dosageform.name),t.push(d3.round(e.avgprice,4)),t.push(d3.round(e.mshprice,4)||""),t},r=d3.select(t).select("#meddb_medicine_list").select("tbody");r.selectAll("tr").remove();var i=r.selectAll("tr").data(e).enter().append("tr").style("cursor","pointer").on("click",function(e){location.hash="medicine:"+e.id});i.selectAll("td").data(n).enter().append("td").text(function(e){return e})};meddb.medicine.data={},meddb.medicine.list=function(){meddb.template.hide(),r("/medicine_list.html",function(e){r("/json/medicine/",function(t){meddb.medicine.data=t,i(t,e),meddb.history.add(location.hash,"All Medicine"),meddb.template.show(e),d3.select("#meddb_medicine_search").on("keyup",function(){meddb.medicine.filter(this.value)})})})},meddb.medicine.filter=function(e){var t=[];meddb.medicine.data.forEach(function(n){var r=0;n.ingredients.forEach(function(t){var n=t.inn.toLowerCase();n.indexOf(e.toLowerCase())!=-1&&r++}),r>0&&t.push(n)}),i(t,d3.select("div.meddb_inner_page")[0][0])},meddb.medicine.detail=function(e){meddb.template.hide(),r("/medicine_detail.html",function(t){r("/json/medicine/"+e+"/",function(e){var n=function(){var t=[];return e.ingredients.forEach(function(e){t.push(e.inn+" "+e.strength)}),t.join(" + ")},r=function(e){var t=[];return t.push(e.country.name),t.push(d3.round(e.price,4)),t.push(e.validity),t};d3.select(t).select("#meddb_medicine_heading").text(n());var i=d3.select(t).select("#meddb_medicine_procurement").select("tbody").selectAll("tr").data(e.procurements).enter().append("tr");i.selectAll("td").data(r).enter().append("td").text(function(e){return e});var s=function(e){var t=[];return t.push({text:e.product.name,hash:"product:"+e.product.id}),e.supplier?t.push({text:e.supplier.name,hash:"supplier:"+e.supplier.id}):t.push({text:""}),e.manufacturer?t.push({text:e.manufacturer.name,hash:"manufacturer:"+e.manufacturer.id}):t.push({text:""}),t.push({text:e.country.name}),t},i=d3.select(t).select("#meddb_medicine_product").select("tbody").selectAll("tr").data(e.procurements).enter().append("tr");i.selectAll("td").data(s).enter().append("td").text(function(e){return e.text}).style("cursor",function(e){if(e.hash)return"pointer"}).on("click",function(e){e.hash&&(location.hash=e.hash)});var o=function(){var t=["Kenya","Uganda","Tanzania"],n={};return e.procurements.forEach(function(e){typeof n[e.country.name]=="undefined"&&(n[e.country.name]=[]),n[e.country.name].push(e.price)}),a=[],t.forEach(function(e){var t={key:e};n[e]&&n[e].length>0?t.value=d3.sum(n[e])/n[e].length:t.value=0,a.push(t)}),a},u=function(t){var n=0,r=0,i=0;return t.forEach(function(e){e.value>0&&(n+=e.value,e.value>i&&(i=e.value),r++)}),d3.max([n*2/r,e.mshprice*1.1,i*1.1])},a=o(),f=u(a),l={width:940,height:95,node:d3.select(t).select("#meddb_medicine_prices")[0][0],bar:{height:25,margin:10,max:f,background:"#dfe7e5"},colors:["#08c","#08c","#08c","#08c","#08c","#08c","#08c","#08c"],data:a};e.mshprice&&(l.line={constant:d3.round(e.mshprice,4)}),d3.select(t).select("#meddb_medicine_prices").html("");var c=new HorizontalBarGraph(l);meddb.history.add(location.hash,n()),meddb.template.show(t)})})},meddb.product={},meddb.product.detail=function(e){meddb.template.hide(),r("/product_detail.html",function(t){r("/json/product/"+e+"/",function(e){var n=function(){var t=[],n=[],r=[];return e.medicine.ingredients.forEach(function(e){n.push(e.inn),r.push(e.strength)}),t.push(n.join(" + ")),t.push(r.join(" + ")),t},r=function(e){var t=[];return t.push({text:e.country.name}),e.supplier?t.push({text:e.supplier.name,hash:"supplier:"+e.supplier.id}):t.push({text:""}),e.manufacturer?t.push({text:e.manufacturer.name,hash:"manufacturer:"+e.manufacturer.id}):t.push({text:""}),t};d3.select(t).select("#meddb_product_heading").text(e.name),d3.select(t).select("table#meddb_product_detail").selectAll("td").data(n).text(function(e){return e});var i=d3.select(t).select("table#meddb_product_registration").select("tbody").selectAll("tr").data(e.procurements).enter().append("tr");i.selectAll("td").data(r).enter().append("td").text(function(e){return e.text}).style("cursor",function(e){if(e.hash)return"pointer"}).on("click",function(e){location.hash=e.hash}),meddb.history.add(location.hash,e.name),meddb.template.show(t)})})},meddb.supplier={},meddb.supplier.detail=function(e){meddb.template.hide(),r("/supplier_detail.html",function(t){r("/json/supplier/"+e+"/",function(e){var n=function(e){var t=[];t.push({text:e.product.name,hash:"product:"+e.product.id}),t.push({text:e.country.name});var n=[];return e.product.medicine.ingredients.forEach(function(e){n.push(e.inn+" "+e.strength)}),t.push({text:n.join(", "),hash:"medicine:"+e.product.medicine.id}),t};d3.select(t).select("#meddb_supplier_heading").text(e.name);var r=function(){var t=[];return t.push(e.website||"None"),t.push(e.contact||"None"),t.push(e.email||"None"),t.push(e.altemail||"None"),t.push(e.phone||"None"),t.push(e.altphone||"None"),t.push(e.fax||"None"),t.push(e.address||"None"),t};d3.select("table#meddb_supplier_details").selectAll("td").data(r()).text(function(e){return e.text}),d3.select("table#meddb_supplier_details").select("td").data([e.website]).style("cursor","pointer").on("click",function(e){e&&(location=e)});var i=d3.select(t).select("table#meddb_supplier_registration").select("tbody").selectAll("tr").data(e.procurements).enter().append("tr");i.selectAll("td").data(n).enter().append("td").text(function(e){return e.text}).style("cursor",function(e){if(e.hash)return"pointer"}).on("click",function(e){location.hash=e.hash}),meddb.history.add(location.hash,e.name),meddb.template.show(t)})})},meddb.template.load("base.html",function(e){meddb.template.inject(e,"#meddb_container"),meddb.router()}),window.onhashchange=meddb.router}