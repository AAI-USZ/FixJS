function o(a,b){for(var c=a.length-1;c>=0;c--)a[c]===b&&a.splice(c,1)}function r(a,b,c,d,f){if(d.needsUpdate){d.program&&E.deallocateMaterial(d);E.initMaterial(d,b,c,f);d.needsUpdate=false}if(d.morphTargets&&!f.__webglMorphTargetInfluences)f.__webglMorphTargetInfluences=new Float32Array(E.maxMorphTargets);var e=false,h=d.program,i=h.uniforms,j=d.uniforms;if(h!==J){g.useProgram(h);J=h;e=true}if(d.id!==S){S=d.id;e=true}if(e||a!==aa){g.uniformMatrix4fv(i.projectionMatrix,
false,a._projectionMatrixArray);a!==aa&&(aa=a)}if(e){if(c&&d.fog){j.fogColor.value=c.color;if(c instanceof THREE.Fog){j.fogNear.value=c.near;j.fogFar.value=c.far}else if(c instanceof THREE.FogExp2)j.fogDensity.value=c.density}if(d instanceof THREE.MeshPhongMaterial||d instanceof THREE.MeshLambertMaterial||d.lights){if(Wa){for(var k,n=0,l=0,m=0,o,q,r,p=fc,u=p.directional.colors,s=p.directional.positions,v=p.point.colors,x=p.point.positions,z=p.point.distances,D=p.spot.colors,I=p.spot.positions,K=p.spot.distances,
H=p.spot.directions,G=p.spot.angles,R=p.spot.exponents,T=0,V=0,U=0,L=r=0,c=L=0,e=b.length;c<e;c++){k=b[c];if(!k.onlyShadow&&k.visible){o=k.color;q=k.intensity;r=k.distance;if(k instanceof THREE.AmbientLight)if(E.gammaInput){n=n+o.r*o.r;l=l+o.g*o.g;m=m+o.b*o.b}else{n=n+o.r;l=l+o.g;m=m+o.b}else if(k instanceof THREE.DirectionalLight){r=T*3;if(E.gammaInput){u[r]=o.r*o.r*q*q;u[r+1]=o.g*o.g*q*q;u[r+2]=o.b*o.b*q*q}else{u[r]=o.r*q;u[r+1]=o.g*q;u[r+2]=o.b*q}Ha.copy(k.matrixWorld.getPosition());Ha.subSelf(k.target.matrixWorld.getPosition());
Ha.normalize();s[r]=Ha.x;s[r+1]=Ha.y;s[r+2]=Ha.z;T=T+1}else if(k instanceof THREE.PointLight){L=V*3;if(E.gammaInput){v[L]=o.r*o.r*q*q;v[L+1]=o.g*o.g*q*q;v[L+2]=o.b*o.b*q*q}else{v[L]=o.r*q;v[L+1]=o.g*q;v[L+2]=o.b*q}o=k.matrixWorld.getPosition();x[L]=o.x;x[L+1]=o.y;x[L+2]=o.z;z[V]=r;V=V+1}else if(k instanceof THREE.SpotLight){L=U*3;if(E.gammaInput){D[L]=o.r*o.r*q*q;D[L+1]=o.g*o.g*q*q;D[L+2]=o.b*o.b*q*q}else{D[L]=o.r*q;D[L+1]=o.g*q;D[L+2]=o.b*q}o=k.matrixWorld.getPosition();I[L]=o.x;I[L+1]=o.y;I[L+2]=
o.z;K[U]=r;Ha.copy(o);Ha.subSelf(k.target.matrixWorld.getPosition());Ha.normalize();H[L]=Ha.x;H[L+1]=Ha.y;H[L+2]=Ha.z;G[U]=Math.cos(k.angle);R[U]=k.exponent;U=U+1}}}c=T*3;for(e=u.length;c<e;c++)u[c]=0;c=V*3;for(e=v.length;c<e;c++)v[c]=0;c=U*3;for(e=D.length;c<e;c++)D[c]=0;p.directional.length=T;p.point.length=V;p.spot.length=U;p.ambient[0]=n;p.ambient[1]=l;p.ambient[2]=m;Wa=false}c=fc;j.ambientLightColor.value=c.ambient;j.directionalLightColor.value=c.directional.colors;j.directionalLightDirection.value=
c.directional.positions;j.pointLightColor.value=c.point.colors;j.pointLightPosition.value=c.point.positions;j.pointLightDistance.value=c.point.distances;j.spotLightColor.value=c.spot.colors;j.spotLightPosition.value=c.spot.positions;j.spotLightDistance.value=c.spot.distances;j.spotLightDirection.value=c.spot.directions;j.spotLightAngle.value=c.spot.angles;j.spotLightExponent.value=c.spot.exponents}if(d instanceof THREE.MeshBasicMaterial||d instanceof THREE.MeshLambertMaterial||d instanceof THREE.MeshPhongMaterial){j.opacity.value=
d.opacity;E.gammaInput?j.diffuse.value.copyGammaToLinear(d.color):j.diffuse.value=d.color;(j.map.texture=d.map)&&j.offsetRepeat.value.set(d.map.offset.x,d.map.offset.y,d.map.repeat.x,d.map.repeat.y);j.lightMap.texture=d.lightMap;j.envMap.texture=d.envMap;j.flipEnvMap.value=d.envMap instanceof THREE.WebGLRenderTargetCube?1:-1;j.reflectivity.value=d.reflectivity;j.refractionRatio.value=d.refractionRatio;j.combine.value=d.combine;j.useRefract.value=d.envMap&&d.envMap.mapping instanceof THREE.CubeRefractionMapping}if(d instanceof
THREE.LineBasicMaterial){j.diffuse.value=d.color;j.opacity.value=d.opacity}else if(d instanceof THREE.ParticleBasicMaterial){j.psColor.value=d.color;j.opacity.value=d.opacity;j.size.value=d.size;j.scale.value=N.height/2;j.map.texture=d.map}else if(d instanceof THREE.MeshPhongMaterial){j.shininess.value=d.shininess;if(E.gammaInput){j.ambient.value.copyGammaToLinear(d.ambient);j.emissive.value.copyGammaToLinear(d.emissive);j.specular.value.copyGammaToLinear(d.specular)}else{j.ambient.value=d.ambient;
j.emissive.value=d.emissive;j.specular.value=d.specular}d.wrapAround&&j.wrapRGB.value.copy(d.wrapRGB)}else if(d instanceof THREE.MeshLambertMaterial){if(E.gammaInput){j.ambient.value.copyGammaToLinear(d.ambient);j.emissive.value.copyGammaToLinear(d.emissive)}else{j.ambient.value=d.ambient;j.emissive.value=d.emissive}d.wrapAround&&j.wrapRGB.value.copy(d.wrapRGB)}else if(d instanceof THREE.MeshDepthMaterial){j.mNear.value=a.near;j.mFar.value=a.far;j.opacity.value=d.opacity}else if(d instanceof THREE.MeshNormalMaterial)j.opacity.value=
d.opacity;if(f.receiveShadow&&!d._shadowPass&&j.shadowMatrix){e=c=0;for(k=b.length;e<k;e++){n=b[e];if(n.castShadow&&(n instanceof THREE.SpotLight||n instanceof THREE.DirectionalLight&&!n.shadowCascade)){j.shadowMap.texture[c]=n.shadowMap;j.shadowMapSize.value[c]=n.shadowMapSize;j.shadowMatrix.value[c]=n.shadowMatrix;j.shadowDarkness.value[c]=n.shadowDarkness;j.shadowBias.value[c]=n.shadowBias;c++}}}b=d.uniformsList;j=0;for(c=b.length;j<c;j++)if(n=h.uniforms[b[j][1]]){e=b[j][0];l=e.type;k=e.value;
if(l==="i")g.uniform1i(n,k);else if(l==="f")g.uniform1f(n,k);else if(l==="v2")g.uniform2f(n,k.x,k.y);else if(l==="v3")g.uniform3f(n,k.x,k.y,k.z);else if(l==="v4")g.uniform4f(n,k.x,k.y,k.z,k.w);else if(l==="c")g.uniform3f(n,k.r,k.g,k.b);else if(l==="fv1")g.uniform1fv(n,k);else if(l==="fv")g.uniform3fv(n,k);else if(l==="v2v"){if(e._array===void 0)e._array=new Float32Array(2*k.length);l=0;for(m=k.length;l<m;l++){p=l*2;e._array[p]=k[l].x;e._array[p+1]=k[l].y}g.uniform2fv(n,e._array)}else if(l==="v3v"){if(e._array===
void 0)e._array=new Float32Array(3*k.length);l=0;for(m=k.length;l<m;l++){p=l*3;e._array[p]=k[l].x;e._array[p+1]=k[l].y;e._array[p+2]=k[l].z}g.uniform3fv(n,e._array)}else if(l==="v4v"){if(e._array===void 0)e._array=new Float32Array(4*k.length);l=0;for(m=k.length;l<m;l++){p=l*4;e._array[p]=k[l].x;e._array[p+1]=k[l].y;e._array[p+2]=k[l].z;e._array[p+3]=k[l].w}g.uniform4fv(n,e._array)}else if(l==="m4"){if(e._array===void 0)e._array=new Float32Array(16);k.flattenToArray(e._array);g.uniformMatrix4fv(n,
false,e._array)}else if(l==="m4v"){if(e._array===void 0)e._array=new Float32Array(16*k.length);l=0;for(m=k.length;l<m;l++)k[l].flattenToArrayOffset(e._array,l*16);g.uniformMatrix4fv(n,false,e._array)}else if(l==="t"){g.uniform1i(n,k);if(n=e.texture)if(n.image instanceof Array&&n.image.length===6){e=n;if(e.image.length===6)if(e.needsUpdate){if(!e.image.__webglTextureCube)e.image.__webglTextureCube=g.createTexture();g.activeTexture(g.TEXTURE0+k);g.bindTexture(g.TEXTURE_CUBE_MAP,e.image.__webglTextureCube);
g.pixelStorei(g.UNPACK_FLIP_Y_WEBGL,e.flipY);k=[];for(n=0;n<6;n++){l=k;m=n;if(E.autoScaleCubemaps){p=e.image[n];s=Mc;if(!(p.width<=s&&p.height<=s)){v=Math.max(p.width,p.height);u=Math.floor(p.width*s/v);s=Math.floor(p.height*s/v);v=document.createElement("canvas");v.width=u;v.height=s;v.getContext("2d").drawImage(p,0,0,p.width,p.height,0,0,u,s);p=v}}else p=e.image[n];l[m]=p}n=k[0];l=(n.width&n.width-1)===0&&(n.height&n.height-1)===0;m=A(e.format);p=A(e.type);F(g.TEXTURE_CUBE_MAP,e,l);for(n=0;n<6;n++)g.texImage2D(g.TEXTURE_CUBE_MAP_POSITIVE_X+
n,0,m,m,p,k[n]);e.generateMipmaps&&l&&g.generateMipmap(g.TEXTURE_CUBE_MAP);e.needsUpdate=false;if(e.onUpdate)e.onUpdate()}else{g.activeTexture(g.TEXTURE0+k);g.bindTexture(g.TEXTURE_CUBE_MAP,e.image.__webglTextureCube)}}else if(n instanceof THREE.WebGLRenderTargetCube){e=n;g.activeTexture(g.TEXTURE0+k);g.bindTexture(g.TEXTURE_CUBE_MAP,e.__webglTexture)}else E.setTexture(n,k)}else if(l==="tv"){if(e._array===void 0){e._array=[];l=0;for(m=e.texture.length;l<m;l++)e._array[l]=k+l}g.uniform1iv(n,e._array);
l=0;for(m=e.texture.length;l<m;l++)(n=e.texture[l])&&E.setTexture(n,e._array[l])}}if((d instanceof THREE.ShaderMaterial||d instanceof THREE.MeshPhongMaterial||d.envMap)&&i.cameraPosition!==null){b=a.matrixWorld.getPosition();g.uniform3f(i.cameraPosition,b.x,b.y,b.z)}(d instanceof THREE.MeshPhongMaterial||d instanceof THREE.MeshLambertMaterial||d instanceof THREE.ShaderMaterial||d.skinning)&&i.viewMatrix!==null&&g.uniformMatrix4fv(i.viewMatrix,false,a._viewMatrixArray);d.skinning&&g.uniformMatrix4fv(i.boneGlobalMatrices,
false,f.boneMatrices)}g.uniformMatrix4fv(i.modelViewMatrix,false,f._modelViewMatrix.elements);i.normalMatrix&&g.uniformMatrix3fv(i.normalMatrix,false,f._normalMatrix.elements);i.objectMatrix!==null&&g.uniformMatrix4fv(i.objectMatrix,false,f.matrixWorld.elements);return h}function p(a,b){a._modelViewMatrix.multiply(b.matrixWorldInverse,a.matrixWorld);a._normalMatrix.getInverse(a._modelViewMatrix);a._normalMatrix.transpose()}