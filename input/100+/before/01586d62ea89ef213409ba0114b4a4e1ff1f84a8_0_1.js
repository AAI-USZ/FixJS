function(options){L.Util.setOptions(this,options);if(!options.table_name||!options.map){if(options.debug){throw ("cartodb-leaflet needs at least a CartoDB table name and the Leaflet map object :(")}else{return}}if(options.auto_bound){this.setBounds()}this._addWadus()},onAdd:function(map){if(!this.options.interactivity){this._addSimple()}else{this._addInteraction()}},onRemove:function(map){this._remove()},setOpacity:function(opacity){if(isNaN(opacity)||opacity>1||opacity<0){if(this.options.debug){throw (opacity+" is not a valid value")}else{return}}this.layer.setOpacity(opacity)},setQuery:function(sql){if(!isNaN(sql)){if(this.options.debug){throw (sql+" is not a valid query")}else{return}}this.options.query=sql;this._update()},setStyle:function(style){if(!isNaN(style)){if(this.options.debug){throw (style+" is not a valid style")}else{return}}this.options.tile_style=style;this._update()},setInteractivity:function(value){if(!isNaN(value)){if(this.options.debug){throw (value+" is not a valid setInteractivity value")}else{return}}this.options.interactivity=value;this._update()},setLayerOrder:function(position){},setInteraction:function(bool){if(bool!==false&&bool!==true){if(this.options.debug){throw (bool+" is not a valid setInteraction value")}else{return}}if(this.interaction){if(bool){var self=this;this.interaction.on("on",function(o){self._bindWaxEvents(self.options.map,o)})}else{this.interaction.off("on")}}},setOptions:function(options){if(typeof options!="object"||options.length){if(this.options.debug){throw (options+" options has to be an object")}else{return}}L.Util.setOptions(this,options);this._update()},isVisible:function(){return this.options.visible},hide:function(){this.setOpacity(0);this.setInteraction(false);this.options.visible=false},show:function(){this.setOpacity(this.options.opacity);this.setInteraction(true);this.options.visible=true},_remove:function(){this.setInteraction(false);this.options.map.removeLayer(this.layer)},_update:function(){this._remove();if(!this.options.interactivity){this._addSimple()}else{this._addInteraction()}},setBounds:function(sql){var self=this,query="";if(sql){query=sql}else{query=this.options.query}reqwest({url:this.generateUrl("sql")+"/api/v2/sql/?q="+escape("SELECT ST_XMin(ST_Extent(the_geom)) as minx,ST_YMin(ST_Extent(the_geom)) as miny,ST_XMax(ST_Extent(the_geom)) as maxx,ST_YMax(ST_Extent(the_geom)) as maxy from ("+query.replace(/\{\{table_name\}\}/g,this.options.table_name)+") as subq"),type:"jsonp",jsonpCallback:"callback",success:function(result){if(result.rows[0].maxx!=null){var coordinates=result.rows[0];var lon0=coordinates.maxx;var lat0=coordinates.maxy;var lon1=coordinates.minx;var lat1=coordinates.miny;var minlat=-85.0511;var maxlat=85.0511;var minlon=-179;var maxlon=179;var clampNum=function(x,min,max){return x<min?min:x>max?max:x};lon0=clampNum(lon0,minlon,maxlon);lon1=clampNum(lon1,minlon,maxlon);lat0=clampNum(lat0,minlat,maxlat);lat1=clampNum(lat1,minlat,maxlat);var sw=new L.LatLng(lat0,lon0);var ne=new L.LatLng(lat1,lon1);var bounds=new L.LatLngBounds(sw,ne);self.options.map.fitBounds(bounds)}},error:function(e,msg){if(this.options.debug){throw ("Error getting table bounds: "+msg)}}})},_addWadus:function(){if(!document.getElementById("cartodb_logo")){var cartodb_link=document.createElement("a");cartodb_link.setAttribute("id","cartodb_logo");cartodb_link.setAttribute("style","position:absolute; bottom:8px; left:8px; display:block;");cartodb_link.setAttribute("href","http://www.cartodb.com");cartodb_link.setAttribute("target","_blank");cartodb_link.innerHTML="<img src='http://cartodb.s3.amazonaws.com/static/new_logo.png' alt='CartoDB' title='CartoDB' />";this.options.map._container.appendChild(cartodb_link)}},_addSimple:function(){var tile_style=(this.options.tile_style)?encodeURIComponent(this.options.tile_style.replace(/\{\{table_name\}\}/g,this.options.table_name)):"",query=encodeURIComponent(this.options.query.replace(/\{\{table_name\}\}/g,this.options.table_name));var cartodb_url=this.generateUrl("tiler")+"/tiles/"+this.options.table_name+"/{z}/{x}/{y}.png?sql="+query+"&style="+tile_style;this.layer=new L.TileLayer(cartodb_url,{attribution:"CartoDB",opacity:this.options.opacity});this.options.map.addLayer(this.layer,false)},_addInteraction:function(){var self=this;this.tilejson=this._generateTileJson();this.layer=new wax.leaf.connector(this.tilejson);this.options.map.addLayer(this.layer,false);this.interaction=wax.leaf.interaction().map(this.options.map).tilejson(this.tilejson).on("on",function(o){self._bindWaxEvents(self.options.map,o)}).on("off",function(){if(self.options.featureOut){return self.options.featureOut&&self.options.featureOut()}else{if(self.options.debug){throw ("featureOut function not defined")}}})},_bindWaxEvents:function(map,o){var layer_point=this._findPos(map,o),latlng=map.layerPointToLatLng(layer_point);switch(o.e.type){case"mousemove":if(this.options.featureOver){return this.options.featureOver(o.e,latlng,o.pos,o.data)}else{if(this.options.debug){throw ("featureOver function not defined")}}break;case"click":if(this.options.featureClick){this.options.featureClick(o.e,latlng,o.pos,o.data)}else{if(this.options.debug){throw ("featureClick function not defined")}}break;case"touchend":if(this.options.featureClick){this.options.featureClick(o.e,latlng,o.pos,o.data)}else{if(this.options.debug){throw ("featureClick function not defined")}}break;default:break}},_generateTileJson:function(){var core_url=this.generateUrl("tiler");var base_url=core_url+"/tiles/"+this.options.table_name+"/{z}/{x}/{y}";var tile_url=base_url+".png";var grid_url=base_url+".grid.json";if(this.options.query){var query="sql="+encodeURIComponent(this.options.query.replace(/\{\{table_name\}\}/g,this.options.table_name));tile_url=this._addUrlData(tile_url,query);grid_url=this._addUrlData(grid_url,query)}if(this.options.tile_style){var style="style="+encodeURIComponent(this.options.tile_style.replace(/\{\{table_name\}\}/g,this.options.table_name));tile_url=this._addUrlData(tile_url,style);grid_url=this._addUrlData(grid_url,style)}if(this.options.interactivity){var interactivity="interactivity="+encodeURIComponent(this.options.interactivity.replace(/ /g,""));tile_url=this._addUrlData(tile_url,interactivity);grid_url=this._addUrlData(grid_url,interactivity)}return{blankImage:"../img/blank_tile.png",tilejson:"1.0.0",scheme:"xyz",tiles:[tile_url],grids:[grid_url],tiles_base:tile_url,grids_base:grid_url,opacity:this.options.opacity,formatter:function(options,data){return data}}},_parseUri:function(str){var o={strictMode:false,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},m=o.parser[o.strictMode?"strict":"loose"].exec(str),uri={},i=14;while(i--){uri[o.key[i]]=m[i]||""}uri[o.q.name]={};uri[o.key[12]].replace(o.q.parser,function($0,$1,$2){if($1){uri[o.q.name][$1]=$2}});return uri},_addUrlData:function(url,data){url+=(this._parseUri(url).query)?"&":"?";return url+=data},generateUrl:function(type){if(type=="sql"){return this.options.sql_protocol+"://"+((this.options.user_name)?this.options.user_name+".":"")+this.options.sql_domain+((this.options.sql_port!="")?(":"+this.options.sql_port):"")}else{return this.options.tiler_protocol+"://"+((this.options.user_name)?this.options.user_name+".":"")+this.options.tiler_domain+((this.options.tiler_port!="")?(":"+this.options.tiler_port):"")}},_findPos:function(map,o){var curleft=curtop=0;var obj=map._container;if(obj.offsetParent){do{curleft+=obj.offsetLeft;curtop+=obj.offsetTop}while(obj=obj.offsetParent);return map.containerPointToLayerPoint(new L.Point(o.pos.x-curleft,o.pos.y-curtop))}else{return map.mouseEventToLayerPoint(o.e)}}