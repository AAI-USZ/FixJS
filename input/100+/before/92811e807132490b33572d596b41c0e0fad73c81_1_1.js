function(a,b,c){var d=a.Kinetic,e=function(){this.options=null,this.clipboard=null,this.main_display=null,this.preview_display=null,this.working_canvas=null,this.command_queue=null};e.prototype={init:function(a){this.options=b.extend({},e.DEFAULT_OPTIONS,a||{});var c=this;this.preview_display=new p,this.preview_display.init({container:this.options.preview_container}),this.main_display=new o,this.main_display.init({container:this.options.main_container,width:this.options.width,height:this.options.height,onViewportChanged:this.preview_display.onViewPortChanged.bind(this.preview_display)}),this.working_canvas=document.createElement("canvas"),this.command_queue=new f,this.command_queue.init()},onImageProcessed:function(a){var b=a.naturalWidth,c=a.naturalHeight,d=this.working_canvas.getContext("2d"),e=this.working_canvas.width!==b||this.working_canvas.height!==c;e&&(this.working_canvas.width=b,this.working_canvas.height=c),d.drawImage(a,0,0),this.preview_display.setImage(a,e),this.main_display.setImage(a,e)},launch:function(a,b){var c=this,d=new Image;d.onload=function(){c.onImageProcessed(d),b()},d.src=a},showSelection:function(){this.main_display.showSelection()},hideSelection:function(){this.main_display.hideSelection()},setSelectMode:function(a){this.main_display.setSelectMode(a)},copySelection:function(){var a=this.main_display.getCurrentSelection();this.clipboard=this.working_canvas.getContext("2d").getImageData(a.left,a.top,a.right-a.left,a.bottom-a.top)},downloadAsImage:function(){var a=this.working_canvas.toDataURL("image/png");a=a.replace("image/png","image/octet-stream"),document.location.href=a},getStage:function(){return this.main_display.getStage()},getLayer:function(){return this.main_display.getLayer()},getImage:function(){return this.main_display.getImage()},pasteClipboard:function(){if(!this.clipboard)return;var a=new i,b=this.main_display.getCurrentSelection(),c=this;a.init(this.working_canvas,{data:this.clipboard,coords:{x:b.left,y:b.top},onexecuted:this.onImageProcessed.bind(this)}),this.command_queue.execute(a),this.clipboard=null},filter:function(a,b){var c=new g,d=this;c.init(this.working_canvas,{filter:a,bounds:this.main_display.getCurrentSelection(),onexecuted:this.onImageProcessed.bind(this)}),this.command_queue.execute(c)},crop:function(){var a=new h,b=this;a.init(this.working_canvas,{bounds:this.main_display.getCurrentSelection(),onexecuted:b.onImageProcessed.bind(this)}),this.command_queue.execute(a)},undo:function(){this.command_queue.undo()},redo:function(){this.command_queue.redo()}},e.DEFAULT_OPTIONS={width:500,height:300};var f=function(){this.commands=null,this.cursor=null};f.prototype={init:function(){this.commands=[],this.cursor=-1},execute:function(a){a.execute(),this.cursor!==this.commands.length&&(this.commands=[]),this.commands.push(a),this.cursor=this.commands.length},redo:function(){this.valid()&&(this.commands[this.cursor].execute(),this.cursor++)},undo:function(){this.mayUndo()&&(this.cursor--,this.commands[this.cursor].revert())},mayUndo:function(){return!!this.commands[this.cursor-1]},valid:function(){return!!this.commands[this.cursor]}};var g=function(){this.canvas=null,this.ctx=null,this.original_data=null};g.prototype={init:function(a,c){this.options=b.extend({},g.DEFAULT_OPTIONS,c||{}),this.canvas=a,this.ctx=this.canvas.getContext("2d")},execute:function(){var a=this.options.bounds.left,b=this.options.bounds.top,c=this.options.bounds.right-this.options.bounds.left,d=this.options.bounds.bottom-this.options.bounds.top,e=this.ctx.getImageData(a,b,c,d);this.original_data=this.ctx.getImageData(a,b,c,d);var f=q[this.options.filter](e);this.ctx.putImageData(f,a,b),this.onExecuted(this.canvas)},revert:function(){this.ctx.putImageData(this.original_data,this.options.bounds.left,this.options.bounds.top),this.onExecuted(this.canvas)},onExecuted:function(a){var b=new Image,c=this;b.onload=function(){c.options.onexecuted(b)},b.src=a.toDataURL()}},g.DEFAULT_OPTIONS={onexecuted:function(){}};var h=function(){this.canvas=null,this.ctx=null,this.original_data=null};h.prototype={init:function(a,c){this.options=b.extend({},h.DEFAULT_OPTIONS,c||{}),this.canvas=a,this.ctx=this.canvas.getContext("2d")},execute:function(){this.original_data=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height);var a=this.options.bounds.left,b=this.options.bounds.top,c=this.options.bounds.right-this.options.bounds.left,d=this.options.bounds.bottom-this.options.bounds.top,e=this.ctx.getImageData(a,b,c,d),f=document.createElement("canvas");f.width=c,f.height=d;var g=f.getContext("2d");g.putImageData(e,0,0),this.onExecuted(f)},revert:function(){var a=document.createElement("canvas");a.width=this.original_data.width,a.height=this.original_data.height;var b=a.getContext("2d");b.putImageData(this.original_data,0,0),this.onExecuted(a)},onExecuted:function(a){var b=new Image,c=this;b.onload=function(){c.options.onexecuted(b)},b.src=a.toDataURL()}},h.DEFAULT_OPTIONS={onexecuted:function(){}};var i=function(){this.canvas=null,this.ctx=null,this.original_data=null};i.prototype={init:function(a,c){this.options=b.extend({},i.DEFAULT_OPTIONS,c||{}),this.canvas=a,this.ctx=this.canvas.getContext("2d")},execute:function(){var a=this.ctx.createImageData(this.options.data.width,this.options.data.height);q.Copy(this.options.data,a),this.original_data=this.ctx.getImageData(this.options.coords.x,this.options.coords.y,this.options.data.width,this.options.data.height),this.ctx.putImageData(this.options.data,this.options.coords.x,this.options.coords.y),this.options.data=a,this.onExecuted(this.canvas)},revert:function(){this.ctx.putImageData(this.original_data,this.options.coords.x,this.options.coords.y),this.onExecuted(this.canvas)},onExecuted:function(a){var b=new Image,c=this;b.onload=function(){c.options.onexecuted(b)},b.src=a.toDataURL()}},i.DEFAULT_OPTIONS={onexecuted:function(){}};var j=function(){this.display=null,this.stage=null,this.options=null,this.ratio=null,this.shapes_group=null,this.layer=null,this.resize_handles=null,this.selection_rect=null,this.resizeInteraction=null,this.resize_overlay=null,this.drag_bounds=null};j.prototype={init:function(a,c){this.display=a,this.stage=c.stage,this.options=b.extend({},j.DEFAULT_OPTIONS,c||{}),this.selection_rect=this.createSelectionRect(),this.resize_handles=this.createResizeHandles(),this.shapes_group=this.createShapesGroup(),this.ratio=this.selection_rect.getWidth()/this.selection_rect.getHeight(),this.setDragBounds({top:0,right:this.stage.getWidth(),bottom:this.stage.getHeight(),left:0}),this.layer=new d.Layer({id:"selection-layer",visible:this.options.show||!1}),this.layer.add(this.shapes_group),this.resizeInteraction=new l,this.resizeInteraction.init(this),this.resize_overlay=new k,this.resize_overlay.init(this),this.stage.add(this.layer)},createSelectionRect:function(){return new d.Rect({id:"selection-rect",width:this.options.width,height:this.options.height,fill:"rgba(0, 0, 0, 0)",stroke:"white",strokeWidth:this.options.stroke,x:0,y:0})},createResizeHandles:function(){var a=this,b=[],d=this.calculateResizeHandleCoordMap();return c.each(j.HANDLES,function(c){b.push(a.createResizeHandle(c,d))}),b},createResizeHandle:function(a,b){return new d.Rect({width:this.options.size,height:this.options.size,fill:this.options.fill,stroke:this.options.stroke,strokeWidth:this.options.stroke_width-1,x:b[a.x],y:b[a.y]})},calculateResizeHandleCoordMap:function(){return{north:-1*(this.options.size/2),east:this.selection_rect.getWidth()-this.options.size/2,south:this.selection_rect.getHeight()-this.options.size/2,west:-1*(this.options.size/2),center:this.selection_rect.getWidth()/2-this.options.size/2,middle:this.selection_rect.getHeight()/2-this.options.size/2}},createShapesGroup:function(){var a=new d.Group({draggable:!0,x:this.stage.getWidth()/2-this.options.width/2,y:this.stage.getHeight()/2-this.options.height/2});return a.add(this.selection_rect),c.each(this.resize_handles,function(b){a.add(b)}),a},updateDragBounds:function(){this.shapes_group.setDragBounds({top:this.drag_bounds.top,right:this.drag_bounds.right-this.selection_rect.getWidth(),bottom:this.drag_bounds.bottom-this.selection_rect.getHeight(),left:this.drag_bounds.left}),this.resize_overlay&&this.resize_overlay.update()},setDragBounds:function(a){this.drag_bounds=a,this.updateDragBounds()},correctResizeHandlePositions:function(){var a=this,b=0,d=this.calculateResizeHandleCoordMap();c.each(j.HANDLES,function(c){var e=a.resize_handles[b++];e.setX(d[c.x]),e.setY(d[c.y])})},getSelection:function(a){var b=this.selection_rect.getAbsolutePosition(),c,d;return typeof a=="object"?(c=b.x-a.x,d=b.y-a.y):(c=b.x,d=b.y),{top:d,right:c+this.selection_rect.getWidth(),bottom:d+this.selection_rect.getHeight(),left:c}},setSelection:function(a){this.selection_rect.setWidth(a.dim.width),this.selection_rect.setHeight(a.dim.height),this.shapes_group.setX(a.pos.x),this.shapes_group.setY(a.pos.y),this.correctResizeHandlePositions(),this.resize_overlay.update(),this.updateDragBounds(),this.layer.draw()},setResizeMode:function(a){this.resizeInteraction.setMode(a)},getHandles:function(a){return b.merge([],this.resize_handles)},getSelectionRect:function(){return this.selection_rect},getImageBoundry:function(){return this.drag_bounds},getLayer:function(){return this.layer},show:function(){this.layer.show(),this.resize_overlay.show(),this.layer.draw()},hide:function(){this.layer.hide(),this.resize_overlay.hide(),this.layer.draw()}},j.HANDLES=[{x:"west",y:"north"},{x:"center",y:"north"},{x:"east",y:"north"},{x:"east",y:"middle"},{x:"east",y:"south"},{x:"center",y:"south"},{x:"west",y:"south"},{x:"west",y:"middle"}],j.DEFAULT_OPTIONS={size:7,fill:"rgba(23, 23, 223, 1)",show:!1,stroke:"white",stroke_width:2,keep_ratio:!1};var k=function(){this.image_selection=null,this.layer=null,this.shapes=null};k.prototype={init:function(a){this.image_selection=a,this.layer=new d.Layer({alpha:.5,visible:!1});var b=this.image_selection.drag_bounds;this.shapes={north:new d.Rect({fill:"grey",x:b.left,y:b.top,width:b.right-b.left}),east:new d.Rect({fill:"grey"}),south:new d.Rect({fill:"grey",x:b.left,width:b.right-b.left}),west:new d.Rect({fill:"grey",x:b.left})},this.layer.add(this.shapes.north),this.layer.add(this.shapes.south),this.layer.add(this.shapes.east),this.layer.add(this.shapes.west),this.image_selection.stage.add(this.layer)},update:function(){var a=this.image_selection.getImageBoundry(),b=this.image_selection.getSelectionRect(),c=b.getAbsolutePosition();this.shapes.north.setWidth(a.right-a.left),this.shapes.north.setX(a.left),this.shapes.north.setY(a.top),this.shapes.north.setHeight(Math.ceil(c.y-a.top));var d=c.y+b.getHeight();this.shapes.south.setX(a.left),this.shapes.south.setY(Math.ceil(d)),this.shapes.south.setWidth(a.right-a.left),this.shapes.south.setHeight(Math.ceil(a.bottom-d)),this.shapes.west.setX(a.left),this.shapes.west.setY(c.y),this.shapes.west.setWidth(c.x-a.left),this.shapes.west.setHeight(Math.ceil(b.getHeight()));var e=c.x+b.getWidth();this.shapes.east.setX(e),this.shapes.east.setY(Math.ceil(c.y)),this.shapes.east.setWidth(a.right-e),this.shapes.east.setHeight(Math.ceil(b.getHeight())),this.layer.draw()},show:function(){this.layer.show(),this.layer.draw()},hide:function(){this.layer.hide(),this.layer.draw()}};var l=function(){this.image_selection=null,this.handles=null,this.last_mousepos=null,this.mode=null};l.prototype={init:function(a){this.image_selection=a,this.handles=this.image_selection.getHandles(),this.canvas=b(this.image_selection.getLayer().getCanvas()),this.mode=new m,this.mode.init(this),this.last_mousepos=null,this.registerHandleEvents()},registerHandleEvents:function(){var a=this,b=function(b){var c=a.handles[b],d=function(c){a.onMouseMove(c,b)},e=function(b){a.image_selection.shapes_group.setDraggable(!0),a.last_mousepos=null,window.document.removeEventListener("mousemove",d),window.document.removeEventListener("mouseup",e)};c.on("mousedown touchstart",function(b){a.image_selection.shapes_group.setDraggable(!1),a.last_mousepos={x:b.pageX,y:b.pageY},window.document.addEventListener("mousemove",d),window.document.addEventListener("mouseup",e)})};for(var c=0;c<this.handles.length;c++)b(c);var d=this.image_selection.getSelectionRect();this.image_selection.shapes_group.on("dragmove",function(){a.image_selection.setSelection({pos:d.getAbsolutePosition(),dim:{width:d.getWidth(),height:d.getHeight()}})})},onMouseMove:function(a,b){var c={x:a.pageX,y:a.pageY},d=this.image_selection.getSelectionRect(),e=d.getAbsolutePosition(),f=d.getWidth(),g=d.getHeight(),h=this.calculateEventDelta(b,c);this.image_selection.setSelection(this.mode.buildSelectGeometry(b,h)),this.last_mousepos=c},calculateEventDelta:function(a,b){var c=b.x,d=b.y,e=c-this.last_mousepos.x,f=d-this.last_mousepos.y,g=[0,6,7],h=[0,1,2];return-1!==g.indexOf(a)&&(e*=-1),-1!==h.indexOf(a)&&(f*=-1),{x:e,y:f}},getBoundry:function(){return this.image_selection.getImageBoundry()},setMode:function(a){"keep-ratio"===a?this.mode=new n:this.mode=new m,this.mode.init(this)},getImageSelection:function(){return this.image_selection}},l.DIRECTION={HORIZONTAL:"horizontal",VERTICAL:"vertical",BOTH:"both"},l.MODE={DEFAULT:"default",RATIO:"ratio"};var m=function(){this.interaction=null};m.prototype={init:function(a){this.interaction=a},buildSelectGeometry:function(a,b){return this.clipSelectionToBoundry({pos:this.calculateSelectPostion(a,b),dim:this.calculateSelectDimensions(a,b)})},calculateSelectDimensions:function(a,b){var c=this.interaction.getImageSelection(),d=c.getSelectionRect(),e=d.getWidth(),f=d.getHeight(),g=l.DIRECTION,h=this.determineResizeDirection(a,b);return e+=h===g.HORIZONTAL||h===g.BOTH?b.x:0,f+=h===g.VERTICAL||h===g.BOTH?b.y:0,{width:e,height:f}},determineResizeDirection:function(a,b){var d=l.DIRECTION,e=null,f={};return f[d.HORIZONTAL]=[3,7],f[d.VERTICAL]=[1,5],f[d.BOTH]=[0,2,4,6],c.each(f,function(b,c){-1!==b.indexOf(a)&&(e=c)}),e},calculateSelectPostion:function(a,b){var c=this.interaction.getImageSelection(),d=c.getSelectionRect(),e=d.getAbsolutePosition(),f=e.x,g=e.y,h=[0,6,7],i=[0,1,2];return f-=-1!==h.indexOf(a)?b.x:0,g-=-1!==i.indexOf(a)?b.y:0,{x:f,y:g}},clipSelectionToBoundry:function(a){var b=this.interaction.getImageSelection(),c=this.interaction.getBoundry(),d=a.pos,e=a.dim,f=b.getSelectionRect(),g=f.getAbsolutePosition(),h={top:d.y,right:d.x+e.width,bottom:d.y+e.height,left:d.x},i={width:f.getWidth(),height:f.getHeight()};return h.left<c.left&&(d.x=c.left,e.width=i.width+(g.x-d.x)),h.right>c.right&&(e.width=c.right-d.x),h.top<c.top&&(d.y=c.top,e.height=i.height+(g.y-d.y)),h.bottom>c.bottom&&(e.height=c.bottom-d.y),{pos:d,dim:e}}};var n=function(){m.prototype.constructor.call(this)};n.prototype=new m,n.prototype.constructor=n,n.prototype.buildSelectGeometry=function(a,b){var c=m.prototype.buildSelectGeometry.call(this,a,b),d=this.interaction.getImageSelection(),e=l.DIRECTION,f=this.determineResizeDirection(a,b),g=c.dim,h=c.pos,i=this.interaction.getBoundry(),j=d.getSelectionRect(),k=j.getAbsolutePosition(),n=[0,6],o=[0,2];if(f===e.HORIZONTAL)if(h.y+g.height>=i.bottom&&3<=a&&7>=a&&j.getWidth()<=g.width)g.height=i.bottom-h.y,g.width=g.height*d.ratio,h.x=k.x;else if(h.y<=i.top&&0<=a&&2>=a&&j.getWidth()<=g.width){var p=h.y+g.height;h.y=i.top,g.height=i.top-h.y,g.width=g.height*d.ratio,h.x=k.x}else{var q=g.width/d.ratio;-1!==o.indexOf(a)&&(h.y=k.y-(q-j.getHeight())),g.height=q}else if(h.x+g.width>=i.right&&1<=a&&5>=a&&j.getHeight()<=g.height)g.width=i.right-h.x,g.height=g.width/d.ratio,h.y=k.y;else if(h.x<=i.left&&-1!==[0,6,7].indexOf(a)&&j.getHeight()<=g.height){var r=h.x+g.width;h.x=i.left,g.width=r-h.x,g.height=g.width/d.ratio,h.y=k.y}else{var s=g.height*d.ratio;-1!==n.indexOf(a)&&(h.x=k.x-(s-j.getWidth())),g.width=s}return{pos:h,dim:g}},n.prototype.determineResizeDirection=function(a,b){var c=l.DIRECTION,d=m.prototype.determineResizeDirection.call(this,a,b);return c.BOTH===d&&(d=Math.abs(b.x)<Math.abs(b.y)?c.VERTICAL:c.HORIZONTAL),d};var o=function(){this.stage=null,this.layer=null,this.image=null,this.scale_x=null,this.scale_y=null,this.drag_bounds=null,this.original_bounds=null,this.natural_dim=null,this.zoom_handler=null,this.image_selection=null};o.prototype={init:function(a){this.options=b.extend({},o.DEFAULT_OPTIONS,a||{}),this.options.container=b(this.options.container).first(),this.natural_dim={width:0,height:0},this.stage=new d.Stage({width:this.options.width,height:this.options.height,container:this.options.container[0]}),this.layer=new d.Layer({id:"image-layer"}),this.image=new d.Image({id:"preview-image",draggable:!0}),this.layer.add(this.image),this.stage.add(this.layer),this.image_selection=new j,this.image_selection.init(this,{stage:this.stage,width:a.select_width||this.stage.getWidth(),height:a.select_height||this.stage.getHeight()}),this.zoom_handler=this.onImageZoomed.bind(this);var c=this;this.image.on("dragmove",function(){c.options.onViewportChanged(c.translateDimensions({top:-c.image.getY(),right:-c.image.getX()+c.stage.getWidth(),bottom:-c.image.getY()+c.stage.getHeight(),left:-c.image.getX()}))})},fitImageToStage:function(a){var b=a.naturalWidth,c=a.naturalHeight,d=b/c,e=this.stage.getWidth(),f=this.stage.getHeight(),g=e/f,h,i;g<=d&&e<b?(h=e,i=h/d):g>d&&f<c?(i=f,h=i*d):(h=b,i=c),this.scale_x=b/h,this.scale_y=c/i,this.image.setHeight(i),this.image.setWidth(h);var j=e/2-h/2,k=f/2-i/2;return this.image.setX(j),this.image.setY(k),{top:k,right:j+h,bottom:k+i,left:j}},setImageDragBounds:function(a){this.drag_bounds=a;var b=a.left<0?0:a.left,c=a.top<0?0:a.top,d=a.right-a.left,e=a.bottom-a.top,f=this.stage.getWidth(),g=this.stage.getHeight(),h=d>f?f:d,i=e>g?g:e;this.image_selection.setDragBounds({top:c,right:b+h,bottom:c+i,left:b})},manageZoomHandler:function(){1<this.scale_x||1<this.scale_y?b(this.stage.getDOM()).bind("mousewheel",this.zoom_handler):b(this.stage.getDOM()).unbind("mousewheel",this.zoom_handler)},onImageZoomed:function(a,b,c,d){c=Math.ceil(c),d=Math.ceil(d);var e,f,g=this.natural_dim.width/this.natural_dim.height,h=this.image.getHeight()+d,i=h*g,j=this.original_bounds.bottom-this.original_bounds.top,k=this.stage.getWidth(),l=this.stage.getHeight();return this.image.getHeight()===j&&0>=d?!1:(h<j?(e=this.original_bounds.left,f=this.original_bounds.top,h=j,i=h*g):(e=k/2-i/2,f=l/2-h/2),this.image.setX(e),this.image.setY(f),this.image.setHeight(h),this.image.setWidth(i),this.scale_x=this.natural_dim.width/i,this.scale_y=this.natural_dim.height/h,this.setImageDragBounds({top:f,right:e+i,bottom:f+h,left:e}),this.updateViewportDragBounds(),this.options.onViewportChanged(this.translateDimensions({top:-f,right:-e+k,bottom:-f+l,left:-e})),this.layer.draw(),!1)},updateViewportDragBounds:function(){var a={},b=this.image.getWidth(),c=this.image.getHeight(),d=this.stage.getWidth(),e=this.stage.getHeight();b>d?(a.left=d-b,a.right=0):(a.left=this.image.getX(),a.right=a.left),c>e?(a.top=e-c,a.bottom=0):(a.top=this.image.getY(),a.bottom=a.top),this.image.setDragBounds(a)},translateDimensions:function(a){return{top:a.top*this.scale_y,right:a.right*this.scale_x,bottom:a.bottom*this.scale_y,left:a.left*this.scale_x}},setImage:function(a){var c=this.natural_dim.width,d=this.natural_dim.height;this.natural_dim={width:a.naturalWidth,height:a.naturalHeight},this.image.setImage(a);if(c!==this.natural_dim.width||d!==this.natural_dim.height){this.original_bounds=this.fitImageToStage(a);var e=this.image.getX(),f=this.image.getY(),g=this.image.getWidth(),h=this.image.getHeight(),i=this.stage.getWidth(),j=this.stage.getHeight();this.setImageDragBounds(b.extend({},this.original_bounds)),this.image_selection.setSelection({dim:{width:g,height:h},pos:{x:e,y:f}}),this.updateViewportDragBounds(),this.options.onViewportChanged(this.translateDimensions({top:-f,right:-e+i,bottom:-f+j,left:-e})),this.manageZoomHandler()}this.layer.draw()},getCurrentSelection:function(){var a=this.image.getAbsolutePosition();return this.translateDimensions(this.image_selection.getSelection(a))},showSelection:function(){this.image_selection.show()},hideSelection:function(){this.image_selection.hide()},setSelectMode:function(a){this.image_selection.setResizeMode(a)},getImageBoundry:function(){return this.drag_bounds}},o.DEFAULT_OPTIONS={width:400,height:300,onzoomed:function(){}};var p=function(){this.stage=null,this.layer=null,this.image=null,this.scale_x=null,this.scale_y=null,this.original_dim=null,this.viewport_rect=null};p.prototype={init:function(a){this.options=b.extend({},p.DEFAULT_OPTIONS,a||{}),this.options.container=b(this.options.container).first(),this.original_dim={width:0,height:0},this.stage=new d.Stage({width:this.options.width,height:this.options.height,container:this.options.container[0]}),this.layer=new d.Layer({id:"image-layer"}),this.image=new d.Image({id:"preview-image"}),this.viewport_rect=new d.Rect({id:"viewport-rect",fill:"rgba(0, 0, 0, 0)",stroke:"black",strokeWidth:.5}),this.layer.add(this.image),this.layer.add(this.viewport_rect),this.stage.add(this.layer)},fitImageToStage:function(a){var b=a.naturalWidth,c=a.naturalHeight,d=b/c,e=this.stage.getWidth(),f=this.stage.getHeight(),g=e/f,h,i;g<=d&&e<b?(h=e,i=h/d):g>d&&f<c?(i=f,h=i*d):(h=b,i=c),this.scale_x=b/h,this.scale_y=c/i,this.image.setHeight(i),this.image.setWidth(h);var j=e/2-h/2,k=f/2-i/2;this.image.setX(j),this.image.setY(k)},setImage:function(a){var b=this.original_dim.width,c=this.original_dim.height;this.original_dim={width:a.naturalWidth,height:a.naturalHeight},this.image.setImage(a),(b!==this.original_dim.width||c!==this.original_dim.height)&&this.fitImageToStage(a),this.layer.draw()},onViewPortChanged:function(a){var b=this.image.getAbsolutePosition(),c=a.left/this.scale_x+b.x,d=a.top/this.scale_y+b.y,e=(a.right-a.left)/this.scale_x,f=(a.bottom-a.top)/this.scale_y;this.viewport_rect.setWidth(e),this.viewport_rect.setHeight(f),this.viewport_rect.setX(c),this.viewport_rect.setY(d),this.layer.draw()}},p.DEFAULT_OPTIONS={width:250,height:150};var q={};q.utils={initSampleCanvas:function(){var a=document.createElement("canvas"),b=a.getContext("2d");a.width=0,a.height=0,this.getSampleCanvas=function(){return a},this.getSampleContext=function(){return b},this.createImageData=b.createImageData?function(a,c){return b.createImageData(a,c)}:function(a,b){return new ImageData(a,b)}},getSampleCanvas:function(){return this.initSampleCanvas(),this.getSampleCanvas()},getSampleContext:function(){return this.initSampleCanvas(),this.getSampleContext()},createImageData:function(a,b){return this.initSampleCanvas(),this.createImageData(a,b)},clamp:function(a){return a>255?255:a<0?0:a},buildMap:function(a){for(var b=[],c=0,d;c<256;c+=1)b[c]=(d=a(c))>255?255:d<0?0:d|0;return b},applyMap:function(a,b,c){for(var d=0,e=a.length;d<e;d+=4)b[d]=c[a[d]],b[d+1]=c[a[d+1]],b[d+2]=c[a[d+2]],b[d+3]=a[d+3]},mapRGB:function(a,b,c){this.applyMap(a,b,this.buildMap(c))},getPixelIndex:function(a,b,c,d,e){if(a<0||a>=c||b<0||b>=d)switch(e){case 1:a=a<0?0:a>=c?c-1:a,b=b<0?0:b>=d?d-1:b;break;case 2:a=(a%=c)<0?a+c:a,b=(b%=d)<0?b+d:b;break;default:return null}return b*c+a<<2},getPixel:function(a,b,c,d,e,f){if(b<0||b>=d||c<0||c>=e)switch(f){case 1:b=b<0?0:b>=d?d-1:b,c=c<0?0:c>=e?e-1:c;break;case 2:b=(b%=d)<0?b+d:b,c=(c%=e)<0?c+e:c;break;default:return 0}var g=c*d+b<<2;return a[g+3]<<24|a[g]<<16|a[g+1]<<8|a[g+2]},getPixelByIndex:function(a,b){return a[b+3]<<24|a[b]<<16|a[b+1]<<8|a[b+2]},copyBilinear:function(a,b,c,d,e,f,g,h){var i=b<0?b-1|0:b|0,j=c<0?c-1|0:c|0,k=b-i,l=c-j,m,n=0,o=0,p=0,q=0,r,s,t,u,v,w;if(i>=0&&i<d-1&&j>=0&&j<e-1){m=j*d+i<<2;if(k||l)n=a[m+3]<<24|a[m]<<16|a[m+1]<<8|a[m+2],m+=4,o=a[m+3]<<24|a[m]<<16|a[m+1]<<8|a[m+2],m=m-8+(d<<2),p=a[m+3]<<24|a[m]<<16|a[m+1]<<8|a[m+2],m+=4,q=a[m+3]<<24|a[m]<<16|a[m+1]<<8|a[m+2];else{f[g]=a[m],f[g+1]=a[m+1],f[g+2]=a[m+2],f[g+3]=a[m+3];return}}else{n=this.getPixel(a,i,j,d,e,h);if(k||l)o=this.getPixel(a,i+1,j,d,e,h),p=this.getPixel(a,i,j+1,d,e,h),q=this.getPixel(a,i+1,j+1,d,e,h);else{f[g]=n>>16&255,f[g+1]=n>>8&255,f[g+2]=n&255,f[g+3]=n>>24&255;return}}r=1-k,s=1-l,t=((n>>16&255)*r+(o>>16&255)*k)*s+((p>>16&255)*r+(q>>16&255)*k)*l,u=((n>>8&255)*r+(o>>8&255)*k)*s+((p>>8&255)*r+(q>>8&255)*k)*l,v=((n&255)*r+(o&255)*k)*s+((p&255)*r+(q&255)*k)*l,w=((n>>24&255)*r+(o>>24&255)*k)*s+((p>>24&255)*r+(q>>24&255)*k)*l,f[g]=t>255?255:t<0?0:t|0,f[g+1]=u>255?255:u<0?0:u|0,f[g+2]=v>255?255:v<0?0:v|0,f[g+3]=w>255?255:w<0?0:w|0},rgbToHsl:function(a,b,c){a/=255,b/=255,c/=255;var d=a>b?a>c?a:c:b>c?b:c,e=a<b?a<c?a:c:b<c?b:c,f=d-e,g=0,h=0,i=(e+d)/2;return f!==0&&(a===d?g=(b-c)/f+(b<c?6:0):b===d?g=(c-a)/f+2:g=(a-b)/f+4,g/=6,h=i>.5?f/(2-d-e):f/(d+e)),[g,h,i]},hslToRgb:function(a,b,c){var d,e,f,g,h,i,j=[];if(b===0)g=h=i=c*255+.5|0,j=[g,h,i];else{c<=.5?e=c*(b+1):e=c+b-c*b,d=c*2-e,f=a+1/3;var k;for(var l=0;l<3;l+=1)f<0?f+=1:f>1&&(f-=1),6*f<1?k=d+(e-d)*f*6:2*f<1?k=e:3*f<2?k=d+(e-d)*(2/3-f)*6:k=d,j[l]=k*255+.5|0,f-=1/3}return j}},q.Translate=function(a,b,c,d){},q.Scale=function(a,b,c,d){},q.Rotate=function(a,b,c,d,e,f){},q.Affine=function(a,b,c,d){},q.UnsharpMask=function(a,b){},q.ConvolutionFilter=function(a,b,c,d,e,f,g,h,i,j){var k=a.data,l=a.width,m=a.height,n=k.length,o=this.utils.createImageData(l,m),p=o.data;e=e||1,f=f||0,g!==!1&&(g=!0),h!==!1&&(h=!0),i=i||0,j=j||0;var q=0,r=b>>1,s=c>>1,t=i>>16&255,u=i>>8&255,v=i&255,w=j*255;for(var x=0;x<m;x+=1)for(var y=0;y<l;y+=1,q+=4){var z=0,A=0,B=0,C=0,D=!1,E=0,F;for(var G=-r;G<=r;G+=1){var H=x+G,I;0<=H&&H<m?I=H*l:h?I=x*l:D=!0;for(var J=-s;J<=s;J+=1){var K=d[E++];if(K!==0){var L=y+J;0<=L&&L<l||(h?L=y:D=!0);if(D)z+=K*t,A+=K*u,B+=K*v,C+=K*w;else{var M=I+L<<2;z+=K*k[M],A+=K*k[M+1],B+=K*k[M+2],C+=K*k[M+3]}}}}p[q]=(F=z/e+f)>255?255:F<0?0:F|0,p[q+1]=(F=A/e+f)>255?255:F<0?0:F|0,p[q+2]=(F=B/e+f)>255?255:F<0?0:F|0,p[q+3]=g?k[q+3]:(F=C/e+f)>255?255:F<0?0:F|0}return o},q.Binarize=function(a,b){var c=a.data,d=a.width,e=a.height,f=c.length,g=this.utils.createImageData(d,e),h=g.data;isNaN(b)&&(b=.5),b*=255;for(var i=0;i<f;i+=4){var j=c[i]+c[i+1]+c[i+2]/3;h[i]=h[i+1]=h[i+2]=j<=b?0:255,h[i+3]=255}return g},q.BlendAdd=function(a,b,c,d){var e=a.data,f=a.width,g=a.height,h=e.length,i=this.utils.createImageData(f,g),j=i.data,k=b.data,l;for(var m=0;m<h;m+=4)j[m]=(l=e[m]+k[m])>255?255:l,j[m+1]=(l=e[m+1]+k[m+1])>255?255:l,j[m+2]=(l=e[m+2]+k[m+2])>255?255:l,j[m+3]=255;return i},q.BlendSubtract=function(a,b,c,d){var e=a.data,f=a.width,g=a.height,h=e.length,i=this.utils.createImageData(f,g),j=i.data,k=b.data,l;for(var m=0;m<h;m+=4)j[m]=(l=e[m]-k[m])<0?0:l,j[m+1]=(l=e[m+1]-k[m+1])<0?0:l,j[m+2]=(l=e[m+2]-k[m+2])<0?0:l,j[m+3]=255;return i},q.BoxBlur=function(){var a=function(a,b,c,d,e){var f=e*2+1,g=e+1,h=c-1,i,j,k,l,m=0,n,o,p,q,r,s,t,u,v,w,x=[];for(r=0,s=256*f;r<s;r+=1)x[r]=r/f|0;for(u=0;u<d;u+=1){i=j=k=l=0,n=u,o=m<<2,i+=g*a[o],j+=g*a[o+1],k+=g*a[o+2],l+=g*a[o+3];for(r=1;r<=e;r+=1)o=m+(r<c?r:h)<<2,i+=a[o],j+=a[o+1],k+=a[o+2],l+=a[o+3];for(t=0;t<c;t+=1)o=n<<2,b[o]=x[i],b[o+1]=x[j],b[o+2]=x[k],b[o+3]=x[l],v=t+g,v>h&&(v=h),w=t-e,w<0&&(w=0),p=m+v<<2,q=m+w<<2,i+=a[p]-a[q],j+=a[p+1]-a[q+1],k+=a[p+2]-a[q+2],l+=a[p+3]-a[q+3],n+=d;m+=c}};return function(b,c,d,e){var f=b.data,g=b.width,h=b.height,i=f.length,j=this.utils.createImageData(g,h),k=j.data,l=this.utils.createImageData(g,h),m=l.data;for(var n=0;n<e;n+=1)a(n?k:f,m,g,h,c),a(m,k,h,g,d);return j}}(),q.GaussianBlur=function(a,b){var c,d,e;switch(b){case 2:c=5,d=[1,1,2,1,1,1,2,4,2,1,2,4,8,4,2,1,2,4,2,1,1,1,2,1,1],e=52;break;case 3:c=7,d=[1,1,2,2,2,1,1,1,2,2,4,2,2,1,2,2,4,8,4,2,2,2,4,8,16,8,4,2,2,2,4,8,4,2,2,1,2,2,4,2,2,1,1,1,2,2,2,1,1],e=140;break;case 4:c=15,d=[2,2,3,4,5,5,6,6,6,5,5,4,3,2,2,2,3,4,5,7,7,8,8,8,7,7,5,4,3,2,3,4,6,7,9,10,10,11,10,10,9,7,6,4,3,4,5,7,9,10,12,13,13,13,12,10,9,7,5,4,5,7,9,11,13,14,15,16,15,14,13,11,9,7,5,5,7,10,12,14,16,17,18,17,16,14,12,10,7,5,6,8,10,13,15,17,19,19,19,17,15,13,10,8,6,6,8,11,13,16,18,19,20,19,18,16,13,11,8,6,6,8,10,13,15,17,19,19,19,17,15,13,10,8,6,5,7,10,12,14,16,17,18,17,16,14,12,10,7,5,5,7,9,11,13,14,15,16,15,14,13,11,9,7,5,4,5,7,9,10,12,13,13,13,12,10,9,7,5,4,3,4,6,7,9,10,10,11,10,10,9,7,6,4,3,2,3,4,5,7,7,8,8,8,7,7,5,4,3,2,2,2,3,4,5,5,6,6,6,5,5,4,3,2,2],e=2044;break;default:c=3,d=[1,2,1,2,4,2,1,2,1],e=16}return this.ConvolutionFilter(a,c,c,d,e,0,!1)},q.StackBlur=function(){function c(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}var a=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],b=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];return function(d,e){var f=d.data,g=d.width,h=d.height,i=f.length,j=this.Clone(d),k=j.data,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J=e+e+1,K=g<<2,L=g-1,M=h-1,N=e+1,O=N*(N+1)/2,P=new c,Q=P,R,S,T,U=a[e],V=b[e];for(n=1;n<J;n+=1)Q=Q.next=new c,n===N&&(T=Q);Q.next=P,r=q=0;for(m=0;m<h;m+=1){A=B=C=D=s=t=u=v=0,w=N*(E=k[q]),x=N*(F=k[q+1]),y=N*(G=k[q+2]),z=N*(H=k[q+3]),s+=O*E,t+=O*F,u+=O*G,v+=O*H,Q=P;for(n=0;n<N;n+=1)Q.r=E,Q.g=F,Q.b=G,Q.a=H,Q=Q.next;for(n=1;n<N;n+=1)o=q+((L<n?L:n)<<2),s+=(Q.r=E=k[o])*(I=N-n),t+=(Q.g=F=k[o+1])*I,u+=(Q.b=G=k[o+2])*I,v+=(Q.a=H=k[o+3])*I,A+=E,B+=F,C+=G,D+=H,Q=Q.next;R=P,S=T;for(l=0;l<g;l+=1)k[q]=s*U>>V,k[q+1]=t*U>>V,k[q+2]=u*U>>V,k[q+3]=v*U>>V,s-=w,t-=x,u-=y,v-=z,w-=R.r,x-=R.g,y-=R.b,z-=R.a,o=r+((o=l+e+1)<L?o:L)<<2,A+=R.r=k[o],B+=R.g=k[o+1],C+=R.b=k[o+2],D+=R.a=k[o+3],s+=A,t+=B,u+=C,v+=D,R=R.next,w+=E=S.r,x+=F=S.g,y+=G=S.b,z+=H=S.a,A-=E,B-=F,C-=G,D-=H,S=S.next,q+=4;r+=g}for(l=0;l<g;l+=1){B=C=D=A=t=u=v=s=0,q=l<<2,w=N*(E=k[q]),x=N*(F=k[q+1]),y=N*(G=k[q+2]),z=N*(H=k[q+3]),s+=O*E,t+=O*F,u+=O*G,v+=O*H,Q=P;for(n=0;n<N;n+=1)Q.r=E,Q.g=F,Q.b=G,Q.a=H,Q=Q.next;p=g;for(n=1;n<=e;n+=1)q=p+l<<2,s+=(Q.r=E=k[q])*(I=N-n),t+=(Q.g=F=k[q+1])*I,u+=(Q.b=G=k[q+2])*I,v+=(Q.a=H=k[q+3])*I,A+=E,B+=F,C+=G,D+=H,Q=Q.next,n<M&&(p+=g);q=l,R=P,S=T;for(m=0;m<h;m+=1)o=q<<2,k[o]=s*U>>V,k[o+1]=t*U>>V,k[o+2]=u*U>>V,k[o+3]=v*U>>V,s-=w,t-=x,u-=y,v-=z,w-=R.r,x-=R.g,y-=R.b,z-=R.a,o=l+((o=m+N)<M?o:M)*g<<2,s+=A+=R.r=k[o],t+=B+=R.g=k[o+1],u+=C+=R.b=k[o+2],v+=D+=R.a=k[o+3],R=R.next,w+=E=S.r,x+=F=S.g,y+=G=S.b,z+=H=S.a,A-=E,B-=F,C-=G,D-=H,S=S.next,q+=g}return j}}(),q.Brightness=function(a,b){var c=a.data,d=a.width,e=a.height,f=c.length,g=this.utils.createImageData(d,e),h=g.data;return this.utils.mapRGB(c,h,function(a){return a+=b,a>255?255:a}),g},q.BrightnessContrastGimp=function(a,b,c){var d=a.data,e=a.width,f=a.height,g=d.length,h=this.utils.createImageData(e,f),i=h.data,j=Math.PI/4;b/=100,c*=.99,c/=100,c=Math.tan((c+1)*j);for(var k=0,l=0;l<g;l+=4)k+=d[l]*19595+d[l+1]*38470+d[l+2]*7471>>16;return k=k/(g/4),this.utils.mapRGB(d,i,function(a){return b<0?a=a*(1+b):b>0&&(a=a+(255-a)*b),c!==0&&(a=(a-k)*c+k),a+.5|0}),h},q.BrightnessContrastPhotoshop=function(a,b,c){var d=a.data,e=a.width,f=a.height,g=d.length,h=this.utils.createImageData(e,f),i=h.data;return b=(b+100)/100,c=(c+100)/100,this.utils.mapRGB(d,i,function(a){return a*=b,a=(a-127.5)*c+127.5,a+.5|0}),h},q.Channels=function(a,b){var c;switch(b){case 2:c=[0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,1,0];break;case 3:c=[0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,1,0];break;default:c=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,1,0]}return this.ColorMatrixFilter(a,c)},q.Clone=function(a){return this.Copy(a,this.utils.createImageData(a.width,a.height))},q.CloneBuiltin=function(a){var b=a.width,c=a.height,d=this.utils.getSampleCanvas(),e=this.utils.getSampleContext(),f;return d.width=b,d.height=c,e.putImageData(a,0,0),f=e.getImageData(0,0,b,c),d.width=0,d.height=0,f},q.ColorMatrixFilter=function(a,b){var c=a.data,d=a.width,e=a.height,f=c.length,g=this.utils.createImageData(d,e),h=g.data,i=b[0],j=b[1],k=b[2],l=b[3],m=b[4],n=b[5],o=b[6],p=b[7],q=b[8],r=b[9],s=b[10],t=b[11],u=b[12],v=b[13],w=b[14],x=b[15],y=b[16],z=b[17],A=b[18],B=b[19],C,D,E,F,G,H;for(D=0;D<f;D+=4)E=c[D],F=c[D+1],G=c[D+2],H=c[D+3],h[D]=(C=E*i+F*j+G*k+H*l+m)>255?255:C<0?0:C|0,h[D+1]=(C=E*n+F*o+G*p+H*q+r)>255?255:C<0?0:C|0,h[D+2]=(C=E*s+F*t+G*u+H*v+w)>255?255:C<0?0:C|0,h[D+3]=(C=E*x+F*y+G*z+H*A+B)>255?255:C<0?0:C|0;return g},q.ColorTransformFilter=function(a,b,c,d,e,f,g,h,i){var j=a.data,k=a.width,l=a.height,m=j.length,n=this.utils.createImageData(k,l),o=n.data,p,q;for(p=0;p<m;p+=4)o[p]=(q=j[p]*b+f)>255?255:q<0?0:q,o[p+1]=(q=j[p+1]*c+g)>255?255:q<0?0:q,o[p+2]=(q=j[p+2]*d+h)>255?255:q<0?0:q,o[p+3]=(q=j[p+3]*e+i)>255?255:q<0?0:q;return n},q.Copy=function(a,b){var c=a.data,d=c.length,e=b.data;while(d--)e[d]=c[d];return b},q.Crop=function(a,b,c,d,e){var f=a.data,g=a.width,h=a.height,i=f.length,j=this.utils.createImageData(d,e),k=j.data,l=Math.max(b,0),m=Math.max(c,0),n=Math.min(b+d,g),o=Math.min(c+e,h),p=l-b,q=m-c,r,s,t,u,v,w;for(r=m,u=q;r<o;r+=1,u+=1)for(s=l,v=p;s<n;s+=1,v+=1)t=r*g+s<<2,w=u*d+v<<2,k[w]=f[t],k[w+1]=f[t+1],k[w+2]=f[t+2],k[w+3]=f[t+3];return j},q.CropBuiltin=function(a,b,c,d,e){var f=a.width,g=a.height,h=this.utils.getSampleCanvas(),i=this.utils.getSampleContext();h.width=f,h.height=g,i.putImageData(a,0,0);var j=i.getImageData(b,c,d,e);return h.width=0,h.height=0,j},q.Desaturate=function(a){var b=a.data,c=a.width,d=a.height,e=b.length,f=this.utils.createImageData(c,d),g=f.data;for(var h=0;h<e;h+=4){var i=b[h],j=b[h+1],k=b[h+2],l=i>j?i>k?i:k:j>k?j:k,m=i<j?i<k?i:k:j<k?j:k,n=(l+m)/2+.5|0;g[h]=g[h+1]=g[h+2]=n,g[h+3]=b[h+3]}return f},q.DisplacementMapFilter=function(a,b,c,d,e,f,g,h,i){var j=a.data,k=a.width,l=a.height,m=j.length,n=q.Clone(a),o=n.data;c=c||0,d=d||0,e=e||0,f=f||0,g=g||0,h=h||0,i=i||2;var p=b.width,r=b.height,s=b.data,t=p+c,u=r+d,v,w,x,y,z,A,B,C,D;for(C=0;C<k;C+=1)for(D=0;D<l;D+=1)v=D*k+C<<2,C<c||D<d||C>=t||D>=u?w=v:(x=(D-d)*p+(C-c)<<2,y=s[x+e],A=C+((y-128)*g>>8),z=s[x+f],B=D+((z-128)*h>>8),w=q.utils.getPixelIndex(A+.5|0,B+.5|0,k,l,i),w===null&&(w=v)),o[v]=j[w],o[v+1]=j[w+1],o[v+2]=j[w+2],o[v+3]=j[w+3];return n},q.Dither=function(a,b){var c=a.width,d=a.height,e=this.Clone(a),f=e.data;b=b<2?2:b>255?255:b;var g,h=[],i=b-1,j=0,k=0,l;for(l=0;l<b;l+=1)h[l]=255*l/i;g=this.utils.buildMap(function(a){var c=h[j];return k+=b,k>255&&(k-=255,j+=1),c});var m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B=c-1,C=d-1,D=7/16,E=3/16,F=5/16,G=1/16;for(n=0;n<d;n+=1)for(m=0;m<c;m+=1)o=n*c+m<<2,p=f[o],q=f[o+1],r=f[o+2],s=g[p],t=g[q],u=g[r],f[o]=s,f[o+1]=t,f[o+2]=u,v=p-s,w=q-t,x=r-u,o+=4,m<B&&(y=f[o]+D*v,z=f[o+1]+D*w,A=f[o+2]+D*x,f[o]=y>255?255:y<0?0:y|0,f[o+1]=z>255?255:z<0?0:z|0,f[o+2]=A>255?255:A<0?0:A|0),o+=c-2<<2,m>0&&n<C&&(y=f[o]+E*v,z=f[o+1]+E*w,A=f[o+2]+E*x,f[o]=y>255?255:y<0?0:y|0,f[o+1]=z>255?255:z<0?0:z|0,f[o+2]=A>255?255:A<0?0:A|0),o+=4,n<C&&(y=f[o]+F*v,z=f[o+1]+F*w,A=f[o+2]+F*x,f[o]=y>255?255:y<0?0:y|0,f[o+1]=z>255?255:z<0?0:z|0,f[o+2]=A>255?255:A<0?0:A|0),o+=4,m<B&&n<C&&(y=f[o]+G*v,z=f[o+1]+G*w,A=f[o+2]+G*x,f[o]=y>255?255:y<0?0:y|0,f[o+1]=z>255?255:z<0?0:z|0,f[o+2]=A>255?255:A<0?0:A|0);return e},q.Edge=function(a){return this.ConvolutionFilter(a,3,3,[-1,-1,-1,-1,8,-1,-1,-1,-1])},q.Emboss=function(a){return this.ConvolutionFilter(a,3,3,[-2,-1,0,-1,1,1,0,1,2])},q.Enrich=function(a){return this.ConvolutionFilter(a,3,3,[0,-2,0,-2,20,-2,0,-2,0],10,-40)},q.Flip=function(a,b){var c=a.data,d=a.width,e=a.height,f=c.length,g=this.utils.createImageData(d,e),h=g.data,i,j,k,l,m;for(j=0;j<e;j+=1)for(i=0;i<d;i+=1)k=j*d+i<<2,b?l=(e-j-1)*d+i<<2:l=j*d+(d-i-1)<<2,h[l]=c[k],h[l+1]=c[k+1],h[l+2]=c[k+2],h[l+3]=c[k+3];return g},q.Gamma=function(a,b){var c=a.data,d=a.width,e=a.height,f=c.length,g=this.utils.createImageData(d,e),h=g.data;return this.utils.mapRGB(c,h,function(a){return a=255*Math.pow(a/255,1/b)+.5,a>255?255:a+.5|0}),g},q.GrayScale=function(a){var b=a.data,c=a.width,d=a.height,e=b.length,f=this.utils.createImageData(c,d),g=f.data;for(var h=0;h<e;h+=4){var i=b[h]*19595+b[h+1]*38470+b[h+2]*7471>>16;g[h]=g[h+1]=g[h+2]=i,g[h+3]=b[h+3]}return f},q.HSLAdjustment=function(a,b,c,d){var e=a.data,f=a.width,g=a.height,h=e.length,i=this.utils.createImageData(f,g),j=i.data;b/=360,c/=100,d/=100;var k=this.utils.rgbToHsl,l=this.utils.hslToRgb,m,n,o,p,q,r;for(r=0;r<h;r+=4){p=k(e[r],e[r+1],e[r+2]),m=p[0]+b;while(m<0)m+=1;while(m>1)m-=1;n=p[1]+p[1]*c,n<0?n=0:n>1&&(n=1),o=p[2],d>0?o+=(1-o)*d:d<0&&(o+=o*d),q=l(m,n,o),j[r]=q[0],j[r+1]=q[1],j[r+2]=q[2],j[r+3]=e[r+3]}return i},q.Invert=function(a){var b=a.data,c=a.width,d=a.height,e=b.length,f=this.utils.createImageData(c,d),g=f.data;return this.utils.mapRGB(b,g,function(a){return 255-a}),f},q.Mosaic=function(a,b){var c=a.data,d=a.width,e=a.height,f=c.length,g=this.utils.createImageData(d,e),h=g.data,i=Math.ceil(d/b),j=Math.ceil(e/b),k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;for(k=0;k<j;k+=1){o=k*b,p=o+b,p>e&&(p=e);for(l=0;l<i;l+=1){m=l*b,n=m+b,n>d&&(n=d),v=w=x=y=0,u=(n-m)*(p-o);for(r=o;r<p;r+=1){s=r*d;for(q=m;q<n;q+=1)t=s+q<<2,v+=c[t],w+=c[t+1],x+=c[t+2],y+=c[t+3]}v=v/u+.5|0,w=w/u+.5|0,x=x/u+.5|0,y=y/u+.5|0;for(r=o;r<p;r+=1){s=r*d;for(q=m;q<n;q+=1)t=s+q<<2,h[t]=v,h[t+1]=w,h[t+2]=x,h[t+3]=y}}}return g},q.Oil=function(a,b,c){var d=a.data,e=a.width,f=a.height,g=d.length,h=this.utils.createImageData(e,f),i=h.data,j=0,k=[],l=[],m=[],n=[],o=[],p=[],q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H;for(r=0;r<f;r+=1)for(q=0;q<e;q+=1){for(s=0;s<c;s+=1)k[s]=l[s]=m[s]=n[s]=o[s]=p[s]=0;for(t=-b;t<=b;t+=1){v=r+t;if(v<0||v>=f)continue;x=v*e;for(u=-b;u<=b;u+=1){w=q+u;if(w<0||w>=e)continue;y=x+w<<2,z=d[y],A=d[y+1],B=d[y+2],C=z*c>>8,D=A*c>>8,E=B*c>>8,n[C]+=z,o[D]+=A,p[E]+=B,k[C]+=1,l[D]+=1,m[E]+=1}}F=G=H=0;for(s=1;s<c;s+=1)k[s]>k[F]&&(F=s),l[s]>l[G]&&(G=s),m[s]>m[H]&&(H=s);i[j]=n[F]/k[F]|0,i[j+1]=o[G]/l[G]|0,i[j+2]=p[H]/m[H]|0,i[j+3]=d[j+3],j+=4}return h},q.OpacityFilter=function(a,b){var c=a.data,d=a.width,e=a.height,f=c.length,g=this.utils.createImageData(d,e),h=g.data;for(var i=0;i<f;i+=4)h[i]=c[i],h[i+1]=c[i+1],h[i+2]=c[i+2],h[i+3]=b;return g},q.Posterize=function(a,b){var c=a.data,d=a.width,e=a.height,f=c.length,g=this.utils.createImageData(d,e),h=g.data;b=b<2?2:b>255?255:b;var i=[],j=b-1,k=0,l=0,m;for(m=0;m<b;m+=1)i[m]=255*m/j;return this.utils.mapRGB(c,h,function(a){var c=i[k];return l+=b,l>255&&(l-=255,k+=1),c}),g},q.Rescale=function(a,b){var c=a.data,d=a.width,e=a.height,f=c.length,g=this.utils.createImageData(d,e),h=g.data;return this.utils.mapRGB(c,h,function(a){return a*=b,a>255?255:a+.5|0}),g},q.ResizeNearestNeighbor=function(a,b,c){var d=a.data,e=a.width,f=a.height,g=d.length,h=this.utils.createImageData(b,c),i=h.data,j=e/b,k=f/c,l=0,m,n,o,p;for(o=0;o<c;o+=1){p=(o*k|0)*e;for(n=0;n<b;n+=1)m=p+n*j<<2,i[l]=d[m],i[l+1]=d[m+1],i[l+2]=d[m+2],i[l+3]=d[m+3],l+=4}return h},q.Resize=function(a,b,c){var d=a.data,e=a.width,f=a.height,g=d.length,h=this.utils.createImageData(b,c),i=h.data,j=e/b,k=f/c,l=0,m,n;for(n=0;n<c;n+=1)for(m=0;m<b;m+=1)this.utils.copyBilinear(d,m*j,n*k,e,f,i,l,0),l+=4;return h},q.ResizeBuiltin=function(a,b,c){var d=a.width,e=a.height,f=this.utils.getSampleCanvas(),g=this.utils.getSampleContext(),h;return f.width=Math.max(d,b),f.height=Math.max(e,c),g.save(),g.putImageData(a,0,0),g.scale(b/d,c/e),g.drawImage(f,0,0),h=g.getImageData(0,0,b,c),g.restore(),f.width=0,f.height=0,h},q.Sepia=function(a){var b=a.data,c=a.width,d=a.height,e=b.length,f=this.utils.createImageData(c,d),g=f.data,h,i,j,k,l;for(k=0;k<e;k+=4)h=b[k],i=b[k+1],j=b[k+2],g[k]=(l=h*.393+i*.769+j*.189)>255?255:l<0?0:l+.5|0,g[k+1]=(l=h*.349+i*.686+j*.168)>255?255:l<0?0:l+.5|0,g[k+2]=(l=h*.272+i*.534+j*.131)>255?255:l<0?0:l+.5|0,g[k+3]=b[k+3];return f},q.Sharpen=function(a,b){return this.ConvolutionFilter(a,3,3,[-b/16,-b/8,-b/16,-b/8,b*.75+1,-b/8,-b/16,-b/8,-b/16])},q.Solarize=function(a){var b=a.data,c=a.width,d=a.height,e=b.length,f=this.utils.createImageData(c,d),g=f.data;return this.utils.mapRGB(b,g,function(a){return a>127?(a-127.5)*2:(127.5-a)*2}),f},q.Transpose=function(a){var b=a.data,c=a.width,d=a.height,e=b.length,f=this.utils.createImageData(d,c),g=f.data,h,i;for(var j=0;j<d;j+=1)for(var k=0;k<c;k+=1)h=j*c+k<<2,i=k*d+j<<2,g[i]=b[h],g[i+1]=b[h+1],g[i+2]=b[h+2],g[i+3]=b[h+3];return f},q.Twril=function(a,b,c,d,e,f,g){var h=a.data,i=a.width,j=a.height,k=h.length,l=this.utils.createImageData(i,j),m=l.data;b=i*b,c=j*c,e*=Math.PI/180;var n=d*d,o=j-1,p=i-1,q=0,r,s,t,u,v,w,x,y,z,A,B;for(s=0;s<j;s+=1)for(r=0;r<i;r+=1)t=r-b,u=s-c,v=t*t+u*u,v>n?(m[q]=h[q],m[q+1]=h[q+1],m[q+2]=h[q+2],m[q+3]=h[q+3]):(v=Math.sqrt(v),w=Math.atan2(u,t)+e*(d-v)/d,x=b+v*Math.cos(w),y=c+v*Math.sin(w),g?this.utils.copyBilinear(h,x,y,i,j,m,q,f):(z=(y+.5|0)*i+(x+.5|0)<<2,m[q]=h[z],m[q+1]=h[z+1],m[q+2]=h[z+2],m[q+3]=h[z+3])),q+=4;return l},a.IchieJs={create:function(a){var b=["launch","showSelection","hideSelection","setSelectMode","copySelection","pasteClipboard","filter","crop","undo","redo","downloadAsImage"],c=new e;c.init(a);var d={};for(var f=0;f<b.length;f++){var g=b[f];d[g]=c[g].bind(c)}return d}}}